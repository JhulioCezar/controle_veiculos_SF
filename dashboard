<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Dashboard - Controle de Ve√≠culos</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        * { box-sizing: border-box; }
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: #2b6cb0; }
        .filtros { background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .checklist-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .header-card { 
            display: flex; 
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .detalhes { 
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .imagem-container { margin: 10px 0; }
        img { 
            max-width: 100%; 
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .badge-inicio { background: #d4edda; color: #155724; }
        .badge-final { background: #f8d7da; color: #721c24; }
        .acoes { margin-top: 10px; }
        button {
            padding: 8px 15px;
            margin-right: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-ver { background: #007bff; color: white; }
        .btn-excluir { background: #dc3545; color: white; }
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #2b6cb0;
            color: white;
        }
        tr:hover { background: #f5f5f5; }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stat-numero {
            font-size: 32px;
            font-weight: bold;
            color: #2b6cb0;
        }
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Dashboard - Controle de Ve√≠culos</h1>
        
        <!-- üî• SE√á√ÉO DE CONFIGURA√á√ÉO ADICIONADA -->
        <div style="margin: 20px 0; padding: 15px; background: #fff3cd; border-radius: 8px; border: 1px solid #ffeaa7;">
            <h3 style="color: #856404; margin-top: 0;">‚öôÔ∏è Configura√ß√µes do Sistema</h3>
            <div>
                <button onclick="iniciarModoProducao()" 
                        style="background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">
                    üöÄ Iniciar Modo Produ√ß√£o
                </button>
                <p style="margin-top: 10px; color: #856404; font-size: 14px;">
                    <small>‚ö†Ô∏è Isso vai limpar todos os dados de teste e preparar o sistema para uso oficial.</small>
                </p>
            </div>
        </div>
        <!-- üî• FIM DA SE√á√ÉO ADICIONADA -->
        
        <div class="stats" id="stats">
            <!-- Estat√≠sticas ser√£o carregadas aqui -->
        </div>
        
        <div class="filtros">
            <h3>üîç Filtros</h3>
            <div>
                <label>Placa:</label>
                <input type="text" id="filtroPlaca" placeholder="Ex: QWO9F32">
                <label>Colaborador:</label>
                <select id="filtroColaborador">
                    <option value="">Todos</option>
                    <!-- Op√ß√µes ser√£o carregadas -->
                </select>
                <label>Data de:</label>
                <input type="date" id="filtroDataInicio">
                <label>at√©:</label>
                <input type="date" id="filtroDataFim">
                <button onclick="carregarChecklists()" style="background:#28a745;color:white;">Aplicar Filtros</button>
                <button onclick="limparFiltros()" style="background:#6c757d;color:white;">Limpar</button>
            </div>
        </div>
        
        <div id="tabelaContainer">
            <table id="tabelaChecklists">
                <thead>
                    <tr>
                        <th>Data/Hora</th>
                        <th>Ve√≠culo</th>
                        <th>Placa</th>
                        <th>Colaborador</th>
                        <th>KM</th>
                        <th>Tipo</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="tabelaCorpo">
                    <!-- Dados ser√£o carregados aqui -->
                </tbody>
            </table>
        </div>
        
        <div id="detalhesModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000;">
            <div style="background:white; margin:50px auto; padding:20px; max-width:800px; border-radius:8px;">
                <h2>Detalhes do Checklist</h2>
                <div id="modalConteudo"></div>
                <button onclick="fecharModal()" style="margin-top:20px; padding:10px 20px; background:#6c757d; color:white; border:none; border-radius:4px; cursor:pointer;">Fechar</button>
            </div>
        </div>
    </div>

    <script>
        // Configura√ß√£o Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDPUrtX4_ZbZtHfPhBE1R9SmXL4YXknTMs",
            authDomain: "controle-veiculos-4a15c.firebaseapp.com",
            projectId: "controle-veiculos-4a15c",
            storageBucket: "controle-veiculos-4a15c.firebasestorage.app",
            messagingSenderId: "249949766074",
            appId: "1:249949766074:web:3f2431f5e2fe94336c7ac3"
        };
        
        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // Vari√°veis globais
        let checklistsData = [];
        
        // Carregar estat√≠sticas
        async function carregarEstatisticas() {
            const snapshot = await db.collection('checklists').get();
            const total = snapshot.size;
            
            // Contar por tipo de rota
            let inicios = 0, finais = 0;
            let colaboradores = new Set();
            let veiculos = new Set();
            let totalKM = 0;
            
            snapshot.forEach(doc => {
                const data = doc.data();
                if (data.tipo_rota === 'IN√çCIO') inicios++;
                if (data.tipo_rota === 'FINAL') finais++;
                colaboradores.add(data.colaborador);
                veiculos.add(data.veiculo);
                totalKM += data.quilometragem;
            });
            
            const statsHTML = `
                <div class="stat-card">
                    <div class="stat-numero">${total}</div>
                    <div class="stat-label">Total de Registros</div>
                </div>
                <div class="stat-card">
                    <div class="stat-numero">${inicios}</div>
                    <div class="stat-label">In√≠cios de Rota</div>
                </div>
                <div class="stat-card">
                    <div class="stat-numero">${finais}</div>
                    <div class="stat-label">Finais de Rota</div>
                </div>
                <div class="stat-card">
                    <div class="stat-numero">${colaboradores.size}</div>
                    <div class="stat-label">Colaboradores</div>
                </div>
                <div class="stat-card">
                    <div class="stat-numero">${veiculos.size}</div>
                    <div class="stat-label">Ve√≠culos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-numero">${totalKM.toLocaleString()} km</div>
                    <div class="stat-label">Quilometragem Total</div>
                </div>
            `;
            
            document.getElementById('stats').innerHTML = statsHTML;
        }
        
        // Carregar checklists
        async function carregarChecklists() {
            let query = db.collection('checklists');
            
            // Aplicar filtros
            const placa = document.getElementById('filtroPlaca').value;
            const colaborador = document.getElementById('filtroColaborador').value;
            const dataInicio = document.getElementById('filtroDataInicio').value;
            const dataFim = document.getElementById('filtroDataFim').value;
            
            if (placa) query = query.where('placa', '==', placa);
            if (colaborador) query = query.where('colaborador', '==', colaborador);
            
            // Ordenar por data mais recente
            query = query.orderBy('created_at', 'desc');
            
            const snapshot = await query.get();
            checklistsData = [];
            
            const tbody = document.getElementById('tabelaCorpo');
            tbody.innerHTML = '';
            
            snapshot.forEach(doc => {
                const data = doc.data();
                checklistsData.push({ id: doc.id, ...data });
                
                // Filtrar por data (se aplic√°vel)
                if (dataInicio || dataFim) {
                    const dataRegistro = new Date(data.created_at?.seconds * 1000 || new Date());
                    const inicio = dataInicio ? new Date(dataInicio) : null;
                    const fim = dataFim ? new Date(dataFim + 'T23:59:59') : null;
                    
                    if (inicio && dataRegistro < inicio) return;
                    if (fim && dataRegistro > fim) return;
                }
                
                const row = `
                    <tr>
                        <td>${data.data} ${data.hora}</td>
                        <td>${data.veiculo}</td>
                        <td>${data.placa}</td>
                        <td>${data.colaborador}</td>
                        <td>${data.quilometragem.toLocaleString()} km</td>
                        <td><span class="badge ${data.tipo_rota === 'IN√çCIO' ? 'badge-inicio' : 'badge-final'}">${data.tipo_rota}</span></td>
                        <td>
                            <button class="btn-ver" onclick="verDetalhes('${doc.id}')">üëÅÔ∏è Ver</button>
                            <button class="btn-excluir" onclick="excluirChecklist('${doc.id}')">üóëÔ∏è Excluir</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
            
            // Carregar op√ß√µes de colaboradores no filtro
            carregarFiltroColaboradores();
        }
        
        // Ver detalhes de um checklist
        async function verDetalhes(id) {
            const doc = await db.collection('checklists').doc(id).get();
            if (!doc.exists) return;
            
            const data = doc.data();
            let html = `
                <h3>${data.veiculo} - ${data.placa}</h3>
                <p><strong>Data:</strong> ${data.data} ${data.hora}</p>
                <p><strong>Colaborador:</strong> ${data.colaborador}</p>
                <p><strong>KM:</strong> ${data.quilometragem.toLocaleString()} km</p>
                <p><strong>Tipo de Rota:</strong> ${data.tipo_rota}</p>
                <p><strong>Tipo de Ve√≠culo:</strong> ${data.tipo_veiculo}</p>
            `;
            
            if (data.foto_painel_base64) {
                html += `
                    <div class="imagem-container">
                        <h4>üì∏ Foto do Painel:</h4>
                        <img src="${data.foto_painel_base64}" alt="Foto do painel">
                        <p><a href="${data.foto_painel_base64}" target="_blank">üîó Abrir em nova aba</a></p>
                    </div>
                `;
            }
            
            if (data.assinatura_base64) {
                html += `
                    <div class="imagem-container">
                        <h4>‚úçÔ∏è Assinatura Digital:</h4>
                        <img src="${data.assinatura_base64}" alt="Assinatura">
                    </div>
                `;
            }
            
            html += `<p><small>ID: ${id}</small></p>`;
            
            document.getElementById('modalConteudo').innerHTML = html;
            document.getElementById('detalhesModal').style.display = 'block';
        }
        
        // Fechar modal
        function fecharModal() {
            document.getElementById('detalhesModal').style.display = 'none';
        }
        
        // Excluir checklist
        async function excluirChecklist(id) {
            if (confirm('Tem certeza que deseja excluir este registro?')) {
                try {
                    await db.collection('checklists').doc(id).delete();
                    alert('‚úÖ Registro exclu√≠do com sucesso!');
                    carregarChecklists();
                    carregarEstatisticas();
                } catch (error) {
                    alert('‚ùå Erro ao excluir: ' + error.message);
                }
            }
        }
        
        // Carregar filtro de colaboradores
        async function carregarFiltroColaboradores() {
            const select = document.getElementById('filtroColaborador');
            const colaboradores = [...new Set(checklistsData.map(c => c.colaborador))].sort();
            
            let options = '<option value="">Todos</option>';
            colaboradores.forEach(colab => {
                options += `<option value="${colab}">${colab}</option>`;
            });
            
            select.innerHTML = options;
        }
        
        // Limpar filtros
        function limparFiltros() {
            document.getElementById('filtroPlaca').value = '';
            document.getElementById('filtroColaborador').value = '';
            document.getElementById('filtroDataInicio').value = '';
            document.getElementById('filtroDataFim').value = '';
            carregarChecklists();
        }
        
        // ========== FUN√á√ïES PARA MODO PRODU√á√ÉO ==========
        
        // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è CUIDADO: ISSO EXCLUI TUDO! ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è
        async function limparTodosRegistros() {
            if (!confirm('üö® ATEN√á√ÉO: Isso vai excluir TODOS os registros do Firestore!\n\nTem certeza?')) {
                return;
            }
            
            if (!confirm('üö® CONFIRMA√á√ÉO FINAL: Isso n√£o tem volta!\nClique em OK apenas se tiver certeza.')) {
                return;
            }
            
            console.log('üóëÔ∏è Excluindo todos os registros...');
            
            try {
                const snapshot = await db.collection('checklists').get();
                const batch = db.batch();
                
                snapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });
                
                await batch.commit();
                console.log('‚úÖ Todos os registros exclu√≠dos!');
                alert('‚úÖ Banco de dados limpo com sucesso!');
                return true;
            } catch (error) {
                console.error('‚ùå Erro:', error);
                alert('‚ùå Erro ao limpar: ' + error.message);
                return false;
            }
        }

        // Excluir apenas registros de uma placa espec√≠fica
        async function limparPorPlaca(placa) {
            if (!placa) {
                placa = prompt('Digite a placa para limpar (ex: QWO9F32):');
                if (!placa) return false;
            }
            
            if (!confirm(`üóëÔ∏è Excluir todos os registros da placa ${placa}?`)) {
                return false;
            }
            
            console.log(`üóëÔ∏è Excluindo registros da placa: ${placa}`);
            
            try {
                const snapshot = await db.collection('checklists')
                    .where('placa', '==', placa)
                    .get();
                
                if (snapshot.empty) {
                    alert(`‚ÑπÔ∏è Nenhum registro encontrado para placa ${placa}`);
                    return false;
                }
                
                const batch = db.batch();
                snapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });
                
                await batch.commit();
                console.log(`‚úÖ ${snapshot.size} registros da placa ${placa} exclu√≠dos!`);
                alert(`‚úÖ ${snapshot.size} registros da placa ${placa} exclu√≠dos!`);
                return true;
            } catch (error) {
                console.error('‚ùå Erro:', error);
                alert('‚ùå Erro: ' + error.message);
                return false;
            }
        }

        // Fun√ß√£o para iniciar modo produ√ß√£o
        async function iniciarModoProducao() {
            if (!confirm('üöÄ INICIAR MODO PRODU√á√ÉO\n\nIsso vai:' +
                         '\n1. üîç Listar todos os registros atuais' +
                         '\n2. üìã Mostrar relat√≥rio completo' +
                         '\n3. üóëÔ∏è Oferecer op√ß√£o de limpar dados' +
                         '\n4. ‚úÖ Preparar sistema para uso oficial' +
                         '\n\nContinuar?')) {
                return;
            }
            
            console.log('üöÄ Preparando modo produ√ß√£o...');
            
            // 1. Listar todos os registros
            const snapshot = await db.collection('checklists').get();
            
            if (snapshot.empty) {
                alert('‚úÖ Sistema j√° est√° limpo! Pode iniciar uso oficial.');
                return;
            }
            
            // 2. Criar relat√≥rio
            let relatorio = 'üìã RELAT√ìRIO ATUAL DO SISTEMA\n\n';
            relatorio += `Total de registros: ${snapshot.size}\n\n`;
            
            // Agrupar por placa
            const porPlaca = {};
            snapshot.forEach(doc => {
                const data = doc.data();
                if (!porPlaca[data.placa]) {
                    porPlaca[data.placa] = [];
                }
                porPlaca[data.placa].push({
                    data: data.data,
                    km: data.quilometragem,
                    colaborador: data.colaborador
                });
            });
            
            relatorio += 'üìä Por placa:\n';
            Object.keys(porPlaca).forEach(placa => {
                const registros = porPlaca[placa];
                relatorio += `\n  ${placa}: ${registros.length} registros\n`;
                // Pegar maior KM
                const maiorKM = Math.max(...registros.map(r => r.km));
                const menorKM = Math.min(...registros.map(r => r.km));
                relatorio += `    ‚Ä¢ KM atual: ${maiorKM.toLocaleString()} km\n`;
                relatorio += `    ‚Ä¢ KM inicial: ${menorKM.toLocaleString()} km\n`;
                relatorio += `    ‚Ä¢ Diferen√ßa: +${(maiorKM - menorKM).toLocaleString()} km\n`;
            });
            
            // 3. Mostrar relat√≥rio e oferecer op√ß√µes
            const acao = prompt(
                relatorio + 
                '\n\nO que deseja fazer?' +
                '\n1. üóëÔ∏è Excluir TODOS os registros' +
                '\n2. üöó Excluir por placa espec√≠fica' +
                '\n3. üìÖ Manter registros (n√£o excluir)' +
                '\n\nDigite 1, 2 ou 3:'
            );
            
            switch(acao) {
                case '1':
                    const sucesso1 = await limparTodosRegistros();
                    if (sucesso1) {
                        alert('‚úÖ Sistema pronto para produ√ß√£o!\n\nTodos os dados de teste foram removidos.');
                    }
                    break;
                case '2':
                    const placa = prompt('Digite a placa para limpar:');
                    if (placa) {
                        const sucesso2 = await limparPorPlaca(placa);
                        if (sucesso2) {
                            alert(`‚úÖ Dados da placa ${placa} removidos!`);
                        }
                    }
                    break;
                case '3':
                    alert('‚úÖ Sistema mantido com dados atuais.\n\nO pr√≥ximo registro de cada ve√≠culo ser√° validado contra o KM atual.');
                    break;
                default:
                    alert('‚ÑπÔ∏è Opera√ß√£o cancelada.');
            }
            
            // Recarregar dashboard
            carregarChecklists();
            carregarEstatisticas();
        }
        
        // Inicializar
        window.onload = function() {
            carregarEstatisticas();
            carregarChecklists();
            
            // Fechar modal ao clicar fora
            document.getElementById('detalhesModal').onclick = function(e) {
                if (e.target.id === 'detalhesModal') {
                    fecharModal();
                }
            };
        };
    </script>
</body>
</html>
