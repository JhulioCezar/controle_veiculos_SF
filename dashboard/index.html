<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Controle de Ve√≠culos</title>
    
    <!-- üî• SUPABASE -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <!-- üî• BIBLIOTECAS PARA FUNCIONALIDADES -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- üî• CONFIGURA√á√ÉO INLINE -->
    <script>
      const SUPABASE_CONFIG = {
        url: 'https://lrfhudpojewxwknqekdg.supabase.co',
        anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxyZmh1ZHBvamV3eHdrbnFla2RnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyOTEyNTMsImV4cCI6MjA4MDg2NzI1M30.JmfyUpUO2-qhMsZv17j6YACLfACYG3PneLoLqwtGR4s'
      };
    </script>
    
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            padding: 20px; 
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
        }
        
        /* HEADER */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #2b6cb0;
        }
        h1 { 
            color: #2b6cb0; 
            margin: 0;
            font-size: 28px;
        }
        .logo {
            height: 50px;
        }
        
        /* STATUS BANCO */
        .status-banco {
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-left: 5px solid #2b6cb0;
        }
        .status-banco h3 {
            margin: 0 0 10px 0;
            color: #2b6cb0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* ESTAT√çSTICAS */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 25px 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            border-top: 4px solid #2b6cb0;
            cursor: pointer;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        .stat-numero {
            font-size: 36px;
            font-weight: bold;
            color: #2b6cb0;
            margin-bottom: 8px;
        }
        .stat-label {
            color: #666;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        /* GR√ÅFICOS */
        .graficos-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .grafico-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .grafico-card h3 {
            margin: 0 0 15px 0;
            color: #2b6cb0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        canvas {
            width: 100% !important;
            height: 250px !important;
        }
        
        /* FILTROS */
        .filtros {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .filtros h3 {
            color: #2b6cb0;
            margin: 0 0 20px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .filtro-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        .filtro-item {
            display: flex;
            flex-direction: column;
        }
        .filtro-item label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #555;
            font-size: 14px;
        }
        .filtro-item select,
        .filtro-item input {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s;
        }
        .filtro-item select:focus,
        .filtro-item input:focus {
            outline: none;
            border-color: #2b6cb0;
            box-shadow: 0 0 0 3px rgba(43, 108, 176, 0.1);
        }
        .filtro-botoes {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        /* TABELA */
        .tabela-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th {
            background: #2b6cb0;
            color: white;
            padding: 16px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
        }
        td {
            padding: 14px 16px;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }
        tr:hover {
            background: #f8f9fa;
        }
        
        /* BADGES */
        .badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            display: inline-block;
        }
        .badge-inicio { 
            background: #d1fae5; 
            color: #065f46; 
            border: 1px solid #a7f3d0;
        }
        .badge-final { 
            background: #fee2e2; 
            color: #991b1b; 
            border: 1px solid #fecaca;
        }
        
        /* BOT√ïES */
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .btn-primary {
            background: #2b6cb0;
            color: white;
        }
        .btn-primary:hover {
            background: #1d4f91;
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background: #565e64;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-success:hover {
            background: #218838;
        }
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        .btn-warning:hover {
            background: #e0a800;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .btn-danger:hover {
            background: #c82333;
        }
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        .btn-info:hover {
            background: #138496;
        }
        
        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .modal-header {
            padding: 20px 30px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
            border-radius: 12px 12px 0 0;
        }
        .modal-header h2 {
            margin: 0;
            color: #2b6cb0;
        }
        .modal-body {
            padding: 30px;
        }
        
        /* NOTIFICA√á√ïES */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1001;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .notification.success {
            background: #28a745;
            border-left: 5px solid #218838;
        }
        .notification.warning {
            background: #ffc107;
            color: #212529;
            border-left: 5px solid #e0a800;
        }
        .notification.error {
            background: #dc3545;
            border-left: 5px solid #c82333;
        }
        .notification.info {
            background: #17a2b8;
            border-left: 5px solid #138496;
        }
        
        /* LOADING */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #2b6cb0;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* RESPONSIVO */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            .header {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }
            .filtro-grid {
                grid-template-columns: 1fr;
            }
            .filtro-botoes {
                flex-wrap: wrap;
            }
            .stats {
                grid-template-columns: repeat(2, 1fr);
            }
            .graficos-container {
                grid-template-columns: 1fr;
            }
            table {
                display: block;
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <div>
                <h1>üìä Dashboard - Controle de Ve√≠culos</h1>
                <p style="color: #666; margin-top: 5px;">Sistema de monitoramento em tempo real</p>
            </div>
            <img src="https://i.imgur.com/SEr4lkm.png" alt="Logo" class="logo">
        </div>
        
        <!-- STATUS DO BANCO -->
        <div class="status-banco">
            <h3>üîó Conex√£o com Banco de Dados</h3>
            <div style="display: flex; align-items: center; gap: 10px;">
                <div id="statusIndicator" style="width: 12px; height: 12px; border-radius: 50%; background: #ccc;"></div>
                <span id="statusText">Conectando ao Supabase...</span>
            </div>
        </div>
        
        <!-- CONTE√öDO PRINCIPAL -->
        <div id="mainContent">
            <!-- CONTROLES DO SISTEMA -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <h3 style="margin-top: 0; color: #2b6cb0; margin-bottom: 15px;">‚ö° A√ß√µes R√°pidas</h3>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                        <button class="btn-success" onclick="exportarDados()" title="Exportar todos os dados para CSV">
                            üì• Exportar CSV
                        </button>
                        <button class="btn-info" onclick="gerarRelatorio()" title="Gerar relat√≥rio detalhado">
                            üìã Gerar Relat√≥rio
                        </button>
                        <button class="btn-warning" onclick="atualizarDashboard()" title="Atualizar todos os dados">
                            üîÑ Atualizar
                        </button>
                    </div>
                </div>
                
                <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <h3 style="margin-top: 0; color: #2b6cb0; margin-bottom: 15px;">‚öôÔ∏è Administra√ß√£o</h3>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px;">
    <button class="btn-primary" onclick="gerenciarColaboradores()" title="Gerenciar colaboradores">
        üë• Gerenciar Colaboradores
    </button>
    <button class="btn-primary" onclick="gerenciarVeiculos()" title="Gerenciar ve√≠culos da frota" style="background: #059669;">
        üöó Gerenciar Ve√≠culos
    </button>
                        <button class="btn-danger" onclick="iniciarModoProducao()" title="Configurar sistema para produ√ß√£o">
                            üöÄ Modo Produ√ß√£o
                        </button>
                        <button class="btn-secondary" onclick="limparDadosTeste()" title="Limpar dados de teste">
                            üßπ Limpar Testes
                        </button>
                        <button class="btn-warning" onclick="mostrarGraficos()" title="Visualizar gr√°ficos">
                            üìä Ver Gr√°ficos
                        </button>
                    </div>
                    <p style="margin-top: 10px; color: #666; font-size: 12px;">
                        <small>‚ö†Ô∏è A√ß√µes administrativas exigem confirma√ß√£o</small>
                    </p>
                </div>
            </div>
            
            <!-- ESTAT√çSTICAS -->
            <div class="stats" id="stats">
                <div class="stat-card">
                    <div class="spinner"></div>
                    <div class="stat-label">Carregando...</div>
                </div>
            </div>
            
            <!-- GR√ÅFICOS (OCULTO INICIALMENTE) -->
            <div class="graficos-container" id="graficosContainer" style="display: none;">
                <div class="grafico-card">
                    <h3>üìà Tipos de Rota por Dia</h3>
                    <canvas id="graficoRota"></canvas>
                </div>
                <div class="grafico-card">
                    <h3>üöó Top 5 Ve√≠culos Mais Usados</h3>
                    <canvas id="graficoVeiculos"></canvas>
                </div>
                <div class="grafico-card">
                    <h3>üë• Atividade por Colaborador</h3>
                    <canvas id="graficoColaboradores"></canvas>
                </div>
                <div class="grafico-card">
                    <h3>üìÖ Evolu√ß√£o de KM Mensal</h3>
                    <canvas id="graficoKM"></canvas>
                </div>
            </div>
            
            <!-- FILTROS -->
            <div class="filtros">
                <h3>üîç Filtros Avan√ßados</h3>
                <div class="filtro-grid">
                    <div class="filtro-item">
                        <label>Placa do Ve√≠culo</label>
                        <input type="text" id="filtroPlaca" placeholder="Ex: QWO9F32">
                    </div>
                    <div class="filtro-item">
                        <label>Colaborador</label>
                        <select id="filtroColaborador">
                            <option value="">Todos os colaboradores</option>
                        </select>
                    </div>
                    <div class="filtro-item">
                        <label>Per√≠odo Inicial</label>
                        <input type="date" id="filtroDataInicio">
                    </div>
                    <div class="filtro-item">
                        <label>Per√≠odo Final</label>
                        <input type="date" id="filtroDataFim">
                    </div>
                    <div class="filtro-item">
                        <label>Tipo de Rota</label>
                        <select id="filtroTipoRota">
                            <option value="">Todos os tipos</option>
                            <option value="IN√çCIO">In√≠cio de Rota</option>
                            <option value="FINAL">Final de Rota</option>
                        </select>
                    </div>
                </div>
                <div class="filtro-botoes">
                    <button class="btn-primary" onclick="aplicarFiltros()">üîç Aplicar Filtros</button>
                    <button class="btn-secondary" onclick="limparFiltros()">üóëÔ∏è Limpar Filtros</button>
                    <button class="btn-info" onclick="salvarFiltro()">üíæ Salvar Filtro</button>
                    <button class="btn-warning" onclick="carregarFiltrosSalvos()">üìÇ Filtros Salvos</button>
                </div>
            </div>
            
            <!-- TABELA DE REGISTROS -->
            <div class="tabela-container">
                <div style="padding: 20px 25px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin: 0; color: #2b6cb0;">üìã Registros de Checklists</h3>
                    <div style="display: flex; gap: 10px;">
                        <span id="contadorRegistros" style="color: #666; font-size: 14px;">Carregando...</span>
                        <button class="btn-info" onclick="carregarChecklists()" style="padding: 8px 12px;" title="Recarregar dados">‚Üª</button>
                        <button class="btn-warning" onclick="verificarKMInconsistente()" style="padding: 8px 12px;" title="Verificar KM inconsistente">‚ö†Ô∏è KM</button>
                    </div>
                </div>
                
                <table id="tabelaChecklists">
                    <thead>
                        <tr>
                            <th>Data/Hora</th>
                            <th>Ve√≠culo</th>
                            <th>Placa</th>
                            <th>Colaborador</th>
                            <th>KM</th>
                            <th>Tipo</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaCorpo">
                        <!-- Dados carregados via JavaScript -->
                    </tbody>
                </table>
                
                <div style="padding: 15px 25px; text-align: center; color: #666; font-size: 14px;">
                    <span id="mensagemTabela">Carregando registros...</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MODAL DE DETALHES -->
    <div class="modal" id="detalhesModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìÑ Detalhes do Checklist</h2>
                <button onclick="fecharModal()" style="background: none; border: none; font-size: 24px; color: #666; cursor: pointer;">√ó</button>
            </div>
            <div class="modal-body" id="modalConteudo">
                <!-- Conte√∫do carregado dinamicamente -->
            </div>
        </div>
    </div>
    
    <!-- MODAL DE RELAT√ìRIO -->
    <div class="modal" id="relatorioModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>üìä Gerar Relat√≥rio</h2>
                <button onclick="fecharModalRelatorio()" style="background: none; border: none; font-size: 24px; color: #666; cursor: pointer;">√ó</button>
            </div>
            <div class="modal-body" id="relatorioConteudo">
                <div style="margin-bottom: 20px;">
                    <h3 style="color: #2b6cb0; margin-top: 0;">Selecione o tipo de relat√≥rio:</h3>
                </div>
                
                <div style="display: grid; gap: 15px;">
                    <button class="btn-primary" onclick="gerarRelatorioDiario()" style="text-align: left; justify-content: flex-start;">
                        üìÖ Relat√≥rio Di√°rio (hoje)
                    </button>
                    
                    <button class="btn-primary" onclick="gerarRelatorioSemanal()" style="text-align: left; justify-content: flex-start;">
                        üìÜ Relat√≥rio Semanal (√∫ltimos 7 dias)
                    </button>
                    
                    <button class="btn-primary" onclick="gerarRelatorioMensal()" style="text-align: left; justify-content: flex-start;">
                        üìà Relat√≥rio Mensal (este m√™s)
                    </button>
                    
                    <button class="btn-info" onclick="gerarRelatorioPorVeiculo()" style="text-align: left; justify-content: flex-start;">
                        üöó Por Ve√≠culo
                    </button>
                    
                    <button class="btn-info" onclick="gerarRelatorioPorColaborador()" style="text-align: left; justify-content: flex-start;">
                        üë• Por Colaborador
                    </button>
                    
                    <button class="btn-warning" onclick="gerarRelatorioCompleto()" style="text-align: left; justify-content: flex-start;">
                        üìã Relat√≥rio Completo (todos os dados)
                    </button>
                </div>
                
                <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;">
                    <label style="display: block; margin-bottom: 10px;">
                        <input type="checkbox" id="incluirGraficos" checked> Incluir gr√°ficos no relat√≥rio
                    </label>
                    <label style="display: block; margin-bottom: 10px;">
                        <input type="checkbox" id="incluirDetalhes" checked> Incluir detalhes dos registros
                    </label>
                    <label style="display: block; margin-bottom: 20px;">
                        <input type="checkbox" id="enviarEmail"> Enviar relat√≥rio por email (em desenvolvimento)
                    </label>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MODAL DE CONFIGURA√á√ÉO PRODU√á√ÉO -->
    <div class="modal" id="producaoModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>üöÄ Configura√ß√£o de Modo Produ√ß√£o</h2>
                <button onclick="fecharModalProducao()" style="background: none; border: none; font-size: 24px; color: #666; cursor: pointer;">√ó</button>
            </div>
            <div class="modal-body" id="producaoConteudo">
                <!-- Conte√∫do carregado dinamicamente -->
            </div>
        </div>
    </div>

    <!-- MODAL DE GERENCIAMENTO DE COLABORADORES -->
    <div class="modal" id="colaboradoresModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>üë• Gerenciamento de Colaboradores</h2>
                <button onclick="fecharModalColaboradores()" style="background: none; border: none; font-size: 24px; color: #666; cursor: pointer;">√ó</button>
            </div>
            <div class="modal-body" id="colaboradoresConteudo">
                <!-- Conte√∫do carregado dinamicamente -->
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Carregando colaboradores...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== VARI√ÅVEIS GLOBAIS ==========
        let supabaseClient = null;
        let checklistsData = [];
        let graficos = {};
        let filtrosSalvos = JSON.parse(localStorage.getItem('filtros_salvos') || '{}');
        
        // ========== FUN√á√ïES AUXILIARES ==========
        function formatarDataBrasileira(dataString) {
            if (!dataString) return 'N/D';
            
            // Se j√° estiver no formato brasileiro, retorna como est√°
            if (dataString.includes('/')) {
                return dataString;
            }
            
            // Converte de YYYY-MM-DD para DD/MM/YYYY
            try {
                const [ano, mes, dia] = dataString.split('-');
                return `${dia}/${mes}/${ano}`;
            } catch (error) {
                return dataString;
            }
        }
        
        function formatarDataParaFiltro(dataString) {
            if (!dataString) return null;
            
            // Converte de DD/MM/YYYY para YYYY-MM-DD
            try {
                const [dia, mes, ano] = dataString.split('/');
                return `${ano}-${mes.padStart(2, '0')}-${dia.padStart(2, '0')}`;
            } catch (error) {
                return dataString;
            }
        }
        
        // Fun√ß√£o para escapar caracteres especiais em HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ========== INICIALIZA√á√ÉO DO SUPABASE ==========
        async function inicializarSupabase() {
            try {
                console.log('üîÑ Iniciando conex√£o com Supabase...');
                
                // Verificar se a configura√ß√£o existe
                if (typeof SUPABASE_CONFIG === 'undefined') {
                    throw new Error('Configura√ß√£o do Supabase n√£o encontrada.');
                }
                
                // Criar cliente Supabase
                supabaseClient = window.supabase.createClient(
                    SUPABASE_CONFIG.url,
                    SUPABASE_CONFIG.anonKey
                );
                
                // Testar conex√£o com timeout
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Timeout: conex√£o muito lenta')), 10000)
                );
                
                const connectPromise = supabaseClient
                    .from('checklists')
                    .select('id')
                    .limit(1);
                
                const { data, error } = await Promise.race([
                    connectPromise,
                    timeoutPromise.then(() => ({ data: null, error: new Error('Timeout') }))
                ]);
                
                if (error) {
                    console.error('‚ùå Erro na conex√£o:', error);
                    throw error;
                }
                
                // Atualizar status
                document.getElementById('statusIndicator').style.background = '#28a745';
                document.getElementById('statusText').innerHTML = 
                    `<strong>‚úÖ Conectado ao Supabase</strong> | Conex√£o estabelecida`;
                
                console.log('‚úÖ Conex√£o estabelecida com sucesso');
                return true;
                
            } catch (error) {
                console.error('‚ùå Erro ao inicializar Supabase:', error);
                
                document.getElementById('statusIndicator').style.background = '#dc3545';
                document.getElementById('statusText').innerHTML = 
                    `<strong>‚ùå Erro de conex√£o:</strong> ${error.message}`;
                
                return false;
            }
        }
        
        // ========== FUN√á√ïES DE NOTIFICA√á√ÉO ==========
        function mostrarNotificacao(mensagem, tipo = 'info', tempo = 3000) {
            const notification = document.createElement('div');
            notification.className = `notification ${tipo}`;
            notification.textContent = mensagem;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => notification.remove(), 300);
            }, tempo);
        }
        
        // ========== FUN√á√ïES DE FILTRO ==========
        function salvarFiltro() {
            const nome = prompt('Digite um nome para este filtro:');
            if (!nome) return;
            
            const filtro = {
                placa: document.getElementById('filtroPlaca').value,
                colaborador: document.getElementById('filtroColaborador').value,
                dataInicio: document.getElementById('filtroDataInicio').value,
                dataFim: document.getElementById('filtroDataFim').value,
                tipoRota: document.getElementById('filtroTipoRota').value,
                criadoEm: new Date().toISOString()
            };
            
            filtrosSalvos[nome] = filtro;
            localStorage.setItem('filtros_salvos', JSON.stringify(filtrosSalvos));
            
            mostrarNotificacao(`‚úÖ Filtro "${nome}" salvo com sucesso!`, 'success');
        }
        
        function carregarFiltrosSalvos() {
            if (Object.keys(filtrosSalvos).length === 0) {
                mostrarNotificacao('‚ÑπÔ∏è Nenhum filtro salvo encontrado.', 'warning');
                return;
            }
            
            let lista = 'üìÇ Filtros Salvos:\n\n';
            Object.keys(filtrosSalvos).forEach((nome, index) => {
                lista += `${index + 1}. ${nome}\n`;
            });
            
            const escolha = prompt(lista + '\nDigite o n√∫mero do filtro ou nome:');
            if (!escolha) return;
            
            let filtro;
            if (!isNaN(escolha)) {
                const index = parseInt(escolha) - 1;
                const nomes = Object.keys(filtrosSalvos);
                if (index >= 0 && index < nomes.length) {
                    filtro = filtrosSalvos[nomes[index]];
                }
            } else if (filtrosSalvos[escolha]) {
                filtro = filtrosSalvos[escolha];
            }
            
            if (filtro) {
                document.getElementById('filtroPlaca').value = filtro.placa;
                document.getElementById('filtroColaborador').value = filtro.colaborador;
                document.getElementById('filtroDataInicio').value = filtro.dataInicio;
                document.getElementById('filtroDataFim').value = filtro.dataFim;
                document.getElementById('filtroTipoRota').value = filtro.tipoRota;
                
                aplicarFiltros();
                mostrarNotificacao(`‚úÖ Filtro carregado: ${escolha}`, 'success');
            } else {
                mostrarNotificacao('‚ùå Filtro n√£o encontrado.', 'error');
            }
        }
        
       // ========== FUN√á√ïES DE GERENCIAMENTO DE COLABORADORES ==========
async function gerenciarColaboradores() {
    // Abre em nova janela/tab - SISTEMA INDEPENDENTE
    window.open('colaboradores.html', '_blank', 
        'width=1300,height=800,scrollbars=yes,resizable=yes');
    
    mostrarNotificacao('üë• Abrindo sistema de gerenciamento de colaboradores...', 'info');
}
        
        async function carregarColaboradoresParaGestao() {
            const conteudo = document.getElementById('colaboradoresConteudo');
            
            try {
                // üî• BUSCAR TODOS OS COLABORADORES (ATIVOS E INATIVOS)
                const { data: colaboradores, error } = await supabaseClient
                    .from('colaboradores')
                    .select('*')
                    .order('nome_completo');
                
                if (error) throw error;
                
                let html = `
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="color: #2b6cb0; margin: 0;">Lista de Colaboradores</h3>
                            <button class="btn-success" id="btnNovoColaborador" style="padding: 8px 16px;">
                                Ôºã Adicionar Novo
                            </button>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                                <div style="text-align: center;">
                                    <div style="font-size: 24px; font-weight: bold; color: #2b6cb0;">
                                        ${colaboradores ? colaboradores.length : 0}
                                    </div>
                                    <div style="font-size: 12px; color: #666;">Total</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 24px; font-weight: bold; color: #28a745;">
                                        ${colaboradores ? colaboradores.filter(c => c.status === 'ativo').length : 0}
                                    </div>
                                    <div style="font-size: 12px; color: #666;">Ativos</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 24px; font-weight: bold; color: #dc3545;">
                                        ${colaboradores ? colaboradores.filter(c => c.status === 'inativo').length : 0}
                                    </div>
                                    <div style="font-size: 12px; color: #666;">Inativos</div>
                                </div>
                            </div>
                        </div>
                `;
                
                if (!colaboradores || colaboradores.length === 0) {
                    html += `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <div style="font-size: 48px;">üë•</div>
                            <p>Nenhum colaborador cadastrado.</p>
                            <button class="btn-success" id="btnNovoColaboradorEmpty" style="padding: 10px 20px;">
                                Ôºã Adicionar Primeiro Colaborador
                            </button>
                        </div>
                    `;
                } else {
                    html += `
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #2b6cb0; color: white;">
                                        <th style="padding: 12px; text-align: left; font-weight: 600;">Nome</th>
                                        <th style="padding: 12px; text-align: left; font-weight: 600;">Fun√ß√£o</th>
                                        <th style="padding: 12px; text-align: left; font-weight: 600;">Setor</th>
                                        <th style="padding: 12px; text-align: left; font-weight: 600;">Status</th>
                                        <th style="padding: 12px; text-align: left; font-weight: 600;">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelaColaboradoresBody">
                    `;
                    
                    colaboradores.forEach(colab => {
                        const statusBadge = colab.status === 'ativo' 
                            ? '<span style="background: #d1fae5; color: #065f46; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold;">ATIVO</span>'
                            : '<span style="background: #fee2e2; color: #991b1b; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold;">INATIVO</span>';
                        
                        html += `
                            <tr data-id="${colab.id}">
                                <td style="padding: 12px;">${escapeHtml(colab.nome_completo)}</td>
                                <td style="padding: 12px;">${escapeHtml(colab.funcao || 'N/D')}</td>
                                <td style="padding: 12px;">${escapeHtml(colab.setor || 'N/D')}</td>
                                <td style="padding: 12px;">${statusBadge}</td>
                                <td style="padding: 12px;">
                                    <button class="btn-info btn-editar" data-id="${colab.id}" style="padding: 6px 12px; margin-right: 5px; margin-bottom: 5px;">
                                        ‚úèÔ∏è Editar
                                    </button>
                                    <button class="${colab.status === 'ativo' ? 'btn-warning' : 'btn-success'} btn-alterar-status" 
                                            data-id="${colab.id}" 
                                            data-nome="${escapeHtml(colab.nome_completo)}"
                                            data-status="${colab.status}"
                                            style="padding: 6px 12px; margin-right: 5px; margin-bottom: 5px;">
                                        ${colab.status === 'ativo' ? '‚è∏Ô∏è Desativar' : '‚ñ∂Ô∏è Ativar'}
                                    </button>
                                    <button class="btn-danger btn-excluir" 
                                            data-id="${colab.id}" 
                                            data-nome="${escapeHtml(colab.nome_completo)}"
                                            style="padding: 6px 12px; margin-bottom: 5px;">
                                        üóëÔ∏è Excluir
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                }
                
                html += `
                    </div>
                `;
                
                conteudo.innerHTML = html;
                
                // Configurar event listeners
                configurarEventosColaboradores();
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar colaboradores:', error);
                conteudo.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #dc3545;">
                        <div style="font-size: 48px;">‚ùå</div>
                        <p>Erro ao carregar colaboradores.</p>
                        <button onclick="carregarColaboradoresParaGestao()" class="btn-primary" style="padding: 10px 20px;">
                            üîÑ Tentar Novamente
                        </button>
                    </div>
                `;
            }
        }
        
        function configurarEventosColaboradores() {
            const conteudo = document.getElementById('colaboradoresConteudo');
            
            // Evento para bot√£o "Adicionar Novo"
            conteudo.querySelectorAll('#btnNovoColaborador, #btnNovoColaboradorEmpty').forEach(btn => {
                btn.addEventListener('click', abrirFormularioNovoColaborador);
            });
            
            // Event delegation para os bot√µes da tabela
            conteudo.addEventListener('click', async function(e) {
                const btn = e.target.closest('button');
                if (!btn) return;
                
                const id = btn.dataset.id;
                const nome = btn.dataset.nome;
                const status = btn.dataset.status;
                
                if (btn.classList.contains('btn-editar')) {
                    e.stopPropagation();
                    await editarColaborador(id);
                } else if (btn.classList.contains('btn-alterar-status')) {
                    e.stopPropagation();
                    if (status === 'ativo') {
                        await desativarColaborador(id, nome);
                    } else {
                        await ativarColaborador(id, nome);
                    }
                } else if (btn.classList.contains('btn-excluir')) {
                    e.stopPropagation();
                    await excluirColaborador(id, nome);
                }
            });
        }
        
        function abrirFormularioNovoColaborador() {
            const html = `
                <div style="max-width: 600px;">
                    <h3 style="color: #2b6cb0; margin-top: 0;">‚ûï Novo Colaborador</h3>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                        <form id="formNovoColaborador">
                            <div style="display: grid; gap: 15px;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Nome Completo *</label>
                                    <input type="text" id="novoNome" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                                
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">CPF</label>
                                    <input type="text" id="novoCpf" placeholder="000.000.000-00" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Fun√ß√£o *</label>
                                        <input type="text" id="novoFuncao" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;" value="Motorista">
                                    </div>
                                    
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Setor *</label>
                                        <input type="text" id="novoSetor" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;" value="Opera√ß√µes">
                                    </div>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Email</label>
                                        <input type="email" id="novoEmail" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                    </div>
                                    
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Telefone</label>
                                        <input type="text" id="novoTelefone" placeholder="(11) 99999-9999" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                    </div>
                                </div>
                                
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Data de Admiss√£o</label>
                                    <input type="date" id="novoDataAdmissao" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                </div>
                                
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Status *</label>
                                    <select id="novoStatus" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                        <option value="ativo" selected>Ativo</option>
                                        <option value="inativo">Inativo</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 10px; margin-top: 30px;">
                                <button type="button" id="btnCancelarNovo" class="btn-secondary" style="flex: 1;">
                                    Cancelar
                                </button>
                                <button type="button" id="btnSalvarNovo" class="btn-success" style="flex: 1;">
                                    ‚úÖ Salvar Colaborador
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.getElementById('colaboradoresConteudo').innerHTML = html;
            
            // Configurar eventos do formul√°rio
            document.getElementById('btnCancelarNovo').addEventListener('click', carregarColaboradoresParaGestao);
            document.getElementById('btnSalvarNovo').addEventListener('click', salvarNovoColaborador);
        }
        
        async function salvarNovoColaborador() {
            try {
                const nome = document.getElementById('novoNome').value.trim();
                const funcao = document.getElementById('novoFuncao').value.trim();
                const setor = document.getElementById('novoSetor').value.trim();
                const status = document.getElementById('novoStatus').value;
                
                if (!nome || !funcao || !setor) {
                    mostrarNotificacao('Por favor, preencha os campos obrigat√≥rios (Nome, Fun√ß√£o e Setor).', 'warning');
                    return;
                }
                
                const dados = {
                    nome_completo: nome,
                    funcao: funcao,
                    setor: setor,
                    status: status,
                    cpf: document.getElementById('novoCpf').value.trim() || null,
                    email: document.getElementById('novoEmail').value.trim() || null,
                    telefone: document.getElementById('novoTelefone').value.trim() || null,
                    data_admissao: document.getElementById('novoDataAdmissao').value || null,
                    created_by: 'dashboard'
                };
                
                console.log('üíæ Salvando novo colaborador:', dados);
                
                const { data, error } = await supabaseClient
                    .from('colaboradores')
                    .insert([dados])
                    .select();
                
                if (error) throw error;
                
                console.log('‚úÖ Colaborador salvo com ID:', data[0].id);
                mostrarNotificacao('‚úÖ Colaborador cadastrado com sucesso!', 'success');
                
                // Recarregar lista
                await carregarColaboradoresParaGestao();
                
            } catch (error) {
                console.error('‚ùå Erro ao salvar colaborador:', error);
                mostrarNotificacao('‚ùå Erro ao salvar colaborador.', 'error');
            }
        }
        
        async function editarColaborador(id) {
            try {
                console.log('‚úèÔ∏è Editando colaborador ID:', id);
                
                // üî• BUSCAR DADOS DO COLABORADOR
                const { data: colaborador, error } = await supabaseClient
                    .from('colaboradores')
                    .select('*')
                    .eq('id', id)
                    .single();
                
                if (error) throw error;
                
                const html = `
                    <div style="max-width: 600px;">
                        <h3 style="color: #2b6cb0; margin-top: 0;">‚úèÔ∏è Editar Colaborador</h3>
                        
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                            <form id="formEditarColaborador">
                                <div style="display: grid; gap: 15px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Nome Completo *</label>
                                        <input type="text" id="editNome" value="${escapeHtml(colaborador.nome_completo)}" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                    </div>
                                    
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">CPF</label>
                                        <input type="text" id="editCpf" value="${escapeHtml(colaborador.cpf || '')}" placeholder="000.000.000-00" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                    </div>
                                    
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                        <div>
                                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Fun√ß√£o *</label>
                                            <input type="text" id="editFuncao" value="${escapeHtml(colaborador.funcao || '')}" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                        </div>
                                        
                                        <div>
                                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Setor *</label>
                                            <input type="text" id="editSetor" value="${escapeHtml(colaborador.setor || '')}" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                        </div>
                                    </div>
                                    
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                        <div>
                                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Email</label>
                                            <input type="email" id="editEmail" value="${escapeHtml(colaborador.email || '')}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                        </div>
                                        
                                        <div>
                                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Telefone</label>
                                            <input type="text" id="editTelefone" value="${escapeHtml(colaborador.telefone || '')}" placeholder="(11) 99999-9999" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Data de Admiss√£o</label>
                                        <input type="date" id="editDataAdmissao" value="${colaborador.data_admissao || ''}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                    </div>
                                    
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Status *</label>
                                        <select id="editStatus" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                                            <option value="ativo" ${colaborador.status === 'ativo' ? 'selected' : ''}>Ativo</option>
                                            <option value="inativo" ${colaborador.status === 'inativo' ? 'selected' : ''}>Inativo</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div style="display: flex; gap: 10px; margin-top: 30px;">
                                    <button type="button" id="btnCancelarEditar" class="btn-secondary" style="flex: 1;">
                                        Cancelar
                                    </button>
                                    <button type="button" id="btnSalvarEditar" data-id="${colaborador.id}" class="btn-success" style="flex: 1;">
                                        ‚úÖ Salvar Altera√ß√µes
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
                document.getElementById('colaboradoresConteudo').innerHTML = html;
                
                // Configurar eventos do formul√°rio
                document.getElementById('btnCancelarEditar').addEventListener('click', carregarColaboradoresParaGestao);
                document.getElementById('btnSalvarEditar').addEventListener('click', async () => {
                    await atualizarColaborador(colaborador.id);
                });
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar dados do colaborador:', error);
                mostrarNotificacao('‚ùå Erro ao carregar dados do colaborador.', 'error');
            }
        }
        
        async function atualizarColaborador(id) {
            try {
                const nome = document.getElementById('editNome').value.trim();
                const funcao = document.getElementById('editFuncao').value.trim();
                const setor = document.getElementById('editSetor').value.trim();
                const status = document.getElementById('editStatus').value;
                
                if (!nome || !funcao || !setor) {
                    mostrarNotificacao('Por favor, preencha os campos obrigat√≥rios (Nome, Fun√ß√£o e Setor).', 'warning');
                    return;
                }
                
                const dados = {
                    nome_completo: nome,
                    funcao: funcao,
                    setor: setor,
                    status: status,
                    cpf: document.getElementById('editCpf').value.trim() || null,
                    email: document.getElementById('editEmail').value.trim() || null,
                    telefone: document.getElementById('editTelefone').value.trim() || null,
                    data_admissao: document.getElementById('editDataAdmissao').value || null,
                    data_atualizacao: new Date().toISOString()
                };
                
                console.log('‚úèÔ∏è Atualizando colaborador:', dados);
                
                const { error } = await supabaseClient
                    .from('colaboradores')
                    .update(dados)
                    .eq('id', id);
                
                if (error) throw error;
                
                console.log('‚úÖ Colaborador atualizado com sucesso');
                mostrarNotificacao('‚úÖ Colaborador atualizado com sucesso!', 'success');
                
                // Recarregar lista
                await carregarColaboradoresParaGestao();
                
            } catch (error) {
                console.error('‚ùå Erro ao atualizar colaborador:', error);
                mostrarNotificacao('‚ùå Erro ao atualizar colaborador.', 'error');
            }
        }
        
        async function desativarColaborador(id, nome) {
            console.log('üîÑ Desativando colaborador:', { id, nome });
            
            if (!confirm(`‚ö†Ô∏è Deseja desativar o colaborador "${nome}"?\n\nEle n√£o aparecer√° mais na lista de colaboradores ativos na p√°gina principal.`)) {
                return;
            }
            
            try {
                const { error } = await supabaseClient
                    .from('colaboradores')
                    .update({ 
                        status: 'inativo',
                        data_atualizacao: new Date().toISOString()
                    })
                    .eq('id', id);
                
                if (error) {
                    console.error('‚ùå Erro no Supabase ao desativar:', error);
                    throw error;
                }
                
                console.log('‚úÖ Colaborador desativado:', nome);
                mostrarNotificacao(`‚úÖ "${nome}" foi desativado com sucesso!`, 'success');
                
                // Recarregar lista
                await carregarColaboradoresParaGestao();
                
            } catch (error) {
                console.error('‚ùå Erro ao desativar colaborador:', error);
                mostrarNotificacao('‚ùå Erro ao desativar colaborador.', 'error');
            }
        }
        
        async function ativarColaborador(id, nome) {
            console.log('üîÑ Ativando colaborador:', { id, nome });
            
            try {
                const { error } = await supabaseClient
                    .from('colaboradores')
                    .update({ 
                        status: 'ativo',
                        data_atualizacao: new Date().toISOString()
                    })
                    .eq('id', id);
                
                if (error) {
                    console.error('‚ùå Erro no Supabase ao ativar:', error);
                    throw error;
                }
                
                console.log('‚úÖ Colaborador ativado:', nome);
                mostrarNotificacao(`‚úÖ "${nome}" foi ativado com sucesso!`, 'success');
                
                // Recarregar lista
                await carregarColaboradoresParaGestao();
                
            } catch (error) {
                console.error('‚ùå Erro ao ativar colaborador:', error);
                mostrarNotificacao('‚ùå Erro ao ativar colaborador.', 'error');
            }
        }
        
        async function excluirColaborador(id, nome) {
            console.log('üóëÔ∏è Excluindo colaborador:', { id, nome });
            
            if (!confirm(`üö® ATEN√á√ÉO!\n\nDeseja EXCLUIR PERMANENTEMENTE o colaborador "${nome}"?\n\nEsta a√ß√£o N√ÉO pode ser desfeita!\n\nTodos os registros deste colaborador permanecer√£o, mas o nome aparecer√° como "N/D".\n\nContinuar?`)) {
                return;
            }
            
            try {
                const { error } = await supabaseClient
                    .from('colaboradores')
                    .delete()
                    .eq('id', id);
                
                if (error) {
                    console.error('‚ùå Erro no Supabase ao excluir:', error);
                    throw error;
                }
                
                console.log('‚úÖ Colaborador exclu√≠do:', nome);
                mostrarNotificacao(`‚úÖ "${nome}" foi exclu√≠do permanentemente!`, 'success');
                
                // Recarregar lista
                await carregarColaboradoresParaGestao();
                
            } catch (error) {
                console.error('‚ùå Erro ao excluir colaborador:', error);
                mostrarNotificacao('‚ùå Erro ao excluir colaborador.', 'error');
            }
        }

// ========== FUN√á√ÉO PARA GERENCIAR VE√çCULOS ==========
function gerenciarVeiculos() {
    // Abre em nova janela/tab - SISTEMA INDEPENDENTE
    window.open('veiculos.html', '_blank', 
        'width=1300,height=800,scrollbars=yes,resizable=yes');
    
    mostrarNotificacao('üöó Abrindo sistema de gerenciamento de ve√≠culos...', 'info');
}
        
        // ========== FUN√á√ïES DE RELAT√ìRIO CORRIGIDAS ==========
        function gerarRelatorio() {
            document.getElementById('relatorioModal').style.display = 'flex';
        }
        
        function fecharModalRelatorio() {
            document.getElementById('relatorioModal').style.display = 'none';
        }
        
        async function gerarRelatorioDiario() {
            try {
                const hoje = new Date().toLocaleDateString('pt-BR');
                console.log('üìÖ Buscando relat√≥rio di√°rio para:', hoje);
                
                // Formatar data para o formato do banco
                const hojeFormatado = formatarDataParaFiltro(hoje);
                
                const { data, error } = await supabaseClient
                    .from('checklists')
                    .select('*')
                    .eq('data', hojeFormatado)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    mostrarNotificacao('‚ÑπÔ∏è Nenhum registro encontrado para hoje.', 'info');
                    return;
                }
                
                // Converter datas para formato brasileiro
                const dadosFormatados = data.map(item => ({
                    ...item,
                    data: formatarDataBrasileira(item.data)
                }));
                
                const relatorio = criarRelatorioDiario(dadosFormatados, hoje);
                exportarRelatorio(relatorio, `relatorio_diario_${hoje.replace(/\//g, '-')}.txt`);
                
            } catch (error) {
                console.error('‚ùå Erro ao gerar relat√≥rio di√°rio:', error);
                mostrarNotificacao('‚ùå Erro ao gerar relat√≥rio di√°rio.', 'error');
            }
        }
        
        async function gerarRelatorioSemanal() {
            try {
                const hoje = new Date();
                const umaSemanaAtras = new Date();
                umaSemanaAtras.setDate(hoje.getDate() - 7);
                
                console.log('üìÜ Buscando relat√≥rio semanal de:', umaSemanaAtras.toLocaleDateString('pt-BR'), 'at√©', hoje.toLocaleDateString('pt-BR'));
                
                // Usar created_at para filtro temporal
                const { data, error } = await supabaseClient
                    .from('checklists')
                    .select('*')
                    .gte('created_at', umaSemanaAtras.toISOString())
                    .lte('created_at', hoje.toISOString())
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    mostrarNotificacao('‚ÑπÔ∏è Nenhum registro encontrado na √∫ltima semana.', 'info');
                    return;
                }
                
                // Converter datas para formato brasileiro
                const dadosFormatados = data.map(item => ({
                    ...item,
                    data: formatarDataBrasileira(item.data)
                }));
                
                const hojeFormatado = hoje.toISOString().split('T')[0];
                const relatorio = criarRelatorioSemanal(dadosFormatados, umaSemanaAtras, hoje);
                exportarRelatorio(relatorio, `relatorio_semanal_${hojeFormatado}.txt`);
                
            } catch (error) {
                console.error('‚ùå Erro ao gerar relat√≥rio semanal:', error);
                mostrarNotificacao('‚ùå Erro ao gerar relat√≥rio semanal.', 'error');
            }
        }
        
        async function gerarRelatorioMensal() {
            try {
                const hoje = new Date();
                const primeiroDiaMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
                
                console.log('üìà Buscando relat√≥rio mensal do m√™s:', hoje.getMonth() + 1);
                
                const { data, error } = await supabaseClient
                    .from('checklists')
                    .select('*')
                    .gte('created_at', primeiroDiaMes.toISOString())
                    .lte('created_at', hoje.toISOString())
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    mostrarNotificacao('‚ÑπÔ∏è Nenhum registro encontrado neste m√™s.', 'info');
                    return;
                }
                
                // Converter datas para formato brasileiro
                const dadosFormatados = data.map(item => ({
                    ...item,
                    data: formatarDataBrasileira(item.data)
                }));
                
                const mesNome = hoje.toLocaleDateString('pt-BR', { month: 'long' });
                const relatorio = criarRelatorioMensal(dadosFormatados, mesNome);
                exportarRelatorio(relatorio, `relatorio_mensal_${mesNome}_${hoje.getFullYear()}.txt`);
                
            } catch (error) {
                console.error('‚ùå Erro ao gerar relat√≥rio mensal:', error);
                mostrarNotificacao('‚ùå Erro ao gerar relat√≥rio mensal.', 'error');
            }
        }
        
        async function gerarRelatorioPorVeiculo() {
            try {
                // Primeiro, pegar todos os ve√≠culos dispon√≠veis
                const { data: veiculos, error: errorVeiculos } = await supabaseClient
                    .from('checklists')
                    .select('placa, veiculo')
                    .not('placa', 'is', null)
                    .order('veiculo');
                
                if (errorVeiculos) throw errorVeiculos;
                
                if (!veiculos || veiculos.length === 0) {
                    mostrarNotificacao('‚ÑπÔ∏è Nenhum ve√≠culo encontrado.', 'info');
                    return;
                }
                
                // Agrupar por placa √∫nica
                const veiculosUnicos = {};
                veiculos.forEach(v => {
                    if (v.placa && !veiculosUnicos[v.placa]) {
                        veiculosUnicos[v.placa] = v.veiculo;
                    }
                });
                
                // Perguntar qual ve√≠culo
                let listaVeiculos = 'üöó SELECIONE O VE√çCULO:\n\n';
                const placas = Object.keys(veiculosUnicos);
                
                placas.forEach((placa, index) => {
                    listaVeiculos += `${index + 1}. ${veiculosUnicos[placa]} (${placa})\n`;
                });
                
                const escolha = prompt(listaVeiculos + '\nDigite o n√∫mero do ve√≠culo:');
                if (!escolha) return;
                
                const index = parseInt(escolha) - 1;
                if (isNaN(index) || index < 0 || index >= placas.length) {
                    mostrarNotificacao('‚ùå Ve√≠culo inv√°lido.', 'error');
                    return;
                }
                
                const placaSelecionada = placas[index];
                const veiculoNome = veiculosUnicos[placaSelecionada];
                
                console.log(`üöó Buscando relat√≥rio para ve√≠culo: ${veiculoNome} (${placaSelecionada})`);
                
                // Buscar registros do ve√≠culo
                const { data: registros, error } = await supabaseClient
                    .from('checklists')
                    .select('*')
                    .eq('placa', placaSelecionada)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                if (!registros || registros.length === 0) {
                    mostrarNotificacao(`‚ÑπÔ∏è Nenhum registro encontrado para ${veiculoNome}.`, 'info');
                    return;
                }
                
                // Converter datas para formato brasileiro
                const dadosFormatados = registros.map(item => ({
                    ...item,
                    data: formatarDataBrasileira(item.data)
                }));
                
                const relatorio = criarRelatorioPorVeiculo(dadosFormatados, veiculoNome, placaSelecionada);
                exportarRelatorio(relatorio, `relatorio_veiculo_${placaSelecionada}.txt`);
                
            } catch (error) {
                console.error('‚ùå Erro ao gerar relat√≥rio por ve√≠culo:', error);
                mostrarNotificacao('‚ùå Erro ao gerar relat√≥rio por ve√≠culo.', 'error');
            }
        }
        
        async function gerarRelatorioPorColaborador() {
            try {
                // Primeiro, pegar todos os colaboradores dispon√≠veis
                const { data: colaboradores, error: errorColabs } = await supabaseClient
                    .from('checklists')
                    .select('colaborador')
                    .not('colaborador', 'is', null)
                    .order('colaborador');
                
                if (errorColabs) throw errorColabs;
                
                if (!colaboradores || colaboradores.length === 0) {
                    mostrarNotificacao('‚ÑπÔ∏è Nenhum colaborador encontrado.', 'info');
                    return;
                }
                
                // Agrupar colaboradores √∫nicos
                const colaboradoresUnicos = [...new Set(colaboradores.map(c => c.colaborador))].sort();
                
                // Perguntar qual colaborador
                let listaColabs = 'üë• SELECIONE O COLABORADOR:\n\n';
                colaboradoresUnicos.forEach((colab, index) => {
                    listaColabs += `${index + 1}. ${colab}\n`;
                });
                
                const escolha = prompt(listaColabs + '\nDigite o n√∫mero do colaborador:');
                if (!escolha) return;
                
                const index = parseInt(escolha) - 1;
                if (isNaN(index) || index < 0 || index >= colaboradoresUnicos.length) {
                    mostrarNotificacao('‚ùå Colaborador inv√°lido.', 'error');
                    return;
                }
                
                const colaboradorSelecionado = colaboradoresUnicos[index];
                
                console.log(`üë• Buscando relat√≥rio para colaborador: ${colaboradorSelecionado}`);
                
                // Buscar registros do colaborador
                const { data: registros, error } = await supabaseClient
                    .from('checklists')
                    .select('*')
                    .eq('colaborador', colaboradorSelecionado)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                if (!registros || registros.length === 0) {
                    mostrarNotificacao(`‚ÑπÔ∏è Nenhum registro encontrado para ${colaboradorSelecionado}.`, 'info');
                    return;
                }
                
                // Converter datas para formato brasileiro
                const dadosFormatados = registros.map(item => ({
                    ...item,
                    data: formatarDataBrasileira(item.data)
                }));
                
                const relatorio = criarRelatorioPorColaborador(dadosFormatados, colaboradorSelecionado);
                exportarRelatorio(relatorio, `relatorio_colaborador_${colaboradorSelecionado.replace(/\s+/g, '_')}.txt`);
                
            } catch (error) {
                console.error('‚ùå Erro ao gerar relat√≥rio por colaborador:', error);
                mostrarNotificacao('‚ùå Erro ao gerar relat√≥rio por colaborador.', 'error');
            }
        }
        
        async function gerarRelatorioCompleto() {
            try {
                const { data, error } = await supabaseClient
                    .from('checklists')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    mostrarNotificacao('‚ÑπÔ∏è Nenhum registro encontrado no sistema.', 'info');
                    return;
                }
                
                // Converter datas para formato brasileiro
                const dadosFormatados = data.map(item => ({
                    ...item,
                    data: formatarDataBrasileira(item.data)
                }));
                
                const relatorio = criarRelatorioCompleto(dadosFormatados);
                exportarRelatorio(relatorio, `relatorio_completo_${new Date().toISOString().split('T')[0]}.txt`);
                
            } catch (error) {
                console.error('‚ùå Erro ao gerar relat√≥rio completo:', error);
                mostrarNotificacao('‚ùå Erro ao gerar relat√≥rio.', 'error');
            }
        }
        
        // ========== FUN√á√ïES AUXILIARES DE CRIA√á√ÉO DE RELAT√ìRIO ==========
        function criarRelatorioDiario(dados, data) {
            const total = dados.length;
            const inicios = dados.filter(d => d.tipo_rota === 'IN√çCIO').length;
            const finais = dados.filter(d => d.tipo_rota === 'FINAL').length;
            const kmTotal = dados.reduce((sum, d) => sum + (d.km || 0), 0);
            
            let relatorio = `üìÖ RELAT√ìRIO DI√ÅRIO - ${data}\n`;
            relatorio += '='.repeat(50) + '\n\n';
            relatorio += `üìä RESUMO:\n`;
            relatorio += `‚Ä¢ Total de registros: ${total}\n`;
            relatorio += `‚Ä¢ In√≠cios de rota: ${inicios}\n`;
            relatorio += `‚Ä¢ Finais de rota: ${finais}\n`;
            relatorio += `‚Ä¢ KM total percorrido: ${kmTotal.toLocaleString()} km\n\n`;
            
            // Agrupar por ve√≠culo
            const porVeiculo = {};
            dados.forEach(item => {
                if (!porVeiculo[item.placa]) {
                    porVeiculo[item.placa] = {
                        veiculo: item.veiculo,
                        quantidade: 0,
                        km: 0
                    };
                }
                porVeiculo[item.placa].quantidade++;
                porVeiculo[item.placa].km += (item.km || 0);
            });
            
            relatorio += `üöó POR VE√çCULO:\n`;
            Object.keys(porVeiculo).forEach(placa => {
                const v = porVeiculo[placa];
                relatorio += `  ‚Ä¢ ${v.veiculo} (${placa}): ${v.quantidade} registros, ${v.km.toLocaleString()} km\n`;
            });
            
            relatorio += '\n' + '='.repeat(50) + '\n';
            relatorio += `Gerado em: ${new Date().toLocaleString('pt-BR')}\n`;
            
            return relatorio;
        }
        
        function criarRelatorioSemanal(dados, dataInicio, dataFim) {
            const total = dados.length;
            const inicios = dados.filter(d => d.tipo_rota === 'IN√çCIO').length;
            const finais = dados.filter(d => d.tipo_rota === 'FINAL').length;
            const kmTotal = dados.reduce((sum, d) => sum + (d.km || 0), 0);
            
            let relatorio = `üìÜ RELAT√ìRIO SEMANAL\n`;
            relatorio += `Per√≠odo: ${dataInicio.toLocaleDateString('pt-BR')} a ${dataFim.toLocaleDateString('pt-BR')}\n`;
            relatorio += '='.repeat(60) + '\n\n';
            relatorio += `üìä RESUMO ESTAT√çSTICO:\n`;
            relatorio += `‚Ä¢ Total de registros: ${total}\n`;
            relatorio += `‚Ä¢ In√≠cios de rota: ${inicios}\n`;
            relatorio += `‚Ä¢ Finais de rota: ${finais}\n`;
            relatorio += `‚Ä¢ KM total percorrido: ${kmTotal.toLocaleString()} km\n`;
            relatorio += `‚Ä¢ M√©dia di√°ria: ${(total / 7).toFixed(1)} registros/dia\n\n`;
            
            // An√°lise por dia
            relatorio += `üìÖ DISTRIBUI√á√ÉO POR DIA:\n`;
            const dadosPorDia = {};
            dados.forEach(item => {
                const data = item.data;
                if (!dadosPorDia[data]) {
                    dadosPorDia[data] = { total: 0, inicios: 0, finais: 0, km: 0 };
                }
                dadosPorDia[data].total++;
                if (item.tipo_rota === 'IN√çCIO') dadosPorDia[data].inicios++;
                if (item.tipo_rota === 'FINAL') dadosPorDia[data].finais++;
                dadosPorDia[data].km += (item.km || 0);
            });
            
            Object.keys(dadosPorDia).sort().forEach(data => {
                const dia = dadosPorDia[data];
                relatorio += `  ‚Ä¢ ${data}: ${dia.total} registros`;
                relatorio += ` (${dia.inicios} in√≠cios, ${dia.finais} finais)`;
                relatorio += ` - ${dia.km.toLocaleString()} km\n`;
            });
            
            relatorio += '\n' + '='.repeat(60) + '\n';
            relatorio += `Gerado em: ${new Date().toLocaleString('pt-BR')}\n`;
            
            return relatorio;
        }
        
        function criarRelatorioMensal(dados, mesNome) {
            const total = dados.length;
            const inicios = dados.filter(d => d.tipo_rota === 'IN√çCIO').length;
            const finais = dados.filter(d => d.tipo_rota === 'FINAL').length;
            const kmTotal = dados.reduce((sum, d) => sum + (d.km || 0), 0);
            const colaboradores = [...new Set(dados.map(d => d.colaborador))].length;
            const veiculos = [...new Set(dados.map(d => d.placa))].length;
            
            let relatorio = `üìà RELAT√ìRIO MENSAL - ${mesNome.toUpperCase()}\n`;
            relatorio += '='.repeat(60) + '\n\n';
            relatorio += `üìä RESUMO DO M√äS:\n`;
            relatorio += `‚Ä¢ Total de registros: ${total}\n`;
            relatorio += `‚Ä¢ In√≠cios de rota: ${inicios}\n`;
            relatorio += `‚Ä¢ Finais de rota: ${finais}\n`;
            relatorio += `‚Ä¢ Colaboradores ativos: ${colaboradores}\n`;
            relatorio += `‚Ä¢ Ve√≠culos utilizados: ${veiculos}\n`;
            relatorio += `‚Ä¢ KM total percorrido: ${kmTotal.toLocaleString()} km\n`;
            relatorio += `‚Ä¢ M√©dia por dia √∫til: ${(total / 22).toFixed(1)} registros/dia\n\n`;
            
            // Top 5 ve√≠culos mais usados
            relatorio += `üöó TOP 5 VE√çCULOS MAIS UTILIZADOS:\n`;
            const usoVeiculos = {};
            dados.forEach(item => {
                const veiculo = item.veiculo || 'Desconhecido';
                const placa = item.placa || 'N/D';
                const chave = `${veiculo} (${placa})`;
                usoVeiculos[chave] = (usoVeiculos[chave] || 0) + 1;
            });
            
            const veiculosOrdenados = Object.entries(usoVeiculos)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            veiculosOrdenados.forEach(([veiculo, quantidade], index) => {
                relatorio += `  ${index + 1}. ${veiculo}: ${quantidade} registros\n`;
            });
            
            relatorio += '\n' + '='.repeat(60) + '\n';
            relatorio += `Gerado em: ${new Date().toLocaleString('pt-BR')}\n`;
            
            return relatorio;
        }
        
        function criarRelatorioPorVeiculo(dados, veiculoNome, placa) {
            const total = dados.length;
            const inicios = dados.filter(d => d.tipo_rota === 'IN√çCIO').length;
            const finais = dados.filter(d => d.tipo_rota === 'FINAL').length;
            const kmTotal = dados.reduce((sum, d) => sum + (d.km || 0), 0);
            
            // Encontrar KM inicial e final
            const kmInicial = Math.min(...dados.map(d => d.km));
            const kmFinal = Math.max(...dados.map(d => d.km));
            const kmPercorrido = kmFinal - kmInicial;
            
            let relatorio = `üöó RELAT√ìRIO POR VE√çCULO\n`;
            relatorio += `Ve√≠culo: ${veiculoNome}\n`;
            relatorio += `Placa: ${placa}\n`;
            relatorio += '='.repeat(60) + '\n\n';
            relatorio += `üìä ESTAT√çSTICAS DO VE√çCULO:\n`;
            relatorio += `‚Ä¢ Total de registros: ${total}\n`;
            relatorio += `‚Ä¢ In√≠cios de rota: ${inicios}\n`;
            relatorio += `‚Ä¢ Finais de rota: ${finais}\n`;
            relatorio += `‚Ä¢ KM inicial registrado: ${kmInicial.toLocaleString()} km\n`;
            relatorio += `‚Ä¢ KM final registrado: ${kmFinal.toLocaleString()} km\n`;
            relatorio += `‚Ä¢ KM total percorrido: ${kmPercorrido.toLocaleString()} km\n`;
            relatorio += `‚Ä¢ M√©dia KM/registro: ${(kmTotal / total).toFixed(0)} km\n\n`;
            
            // Hist√≥rico de uso
            relatorio += `üìÖ HIST√ìRICO DE USO:\n`;
            
            // Ordenar por data
            dados.sort((a, b) => {
                const dataA = new Date(a.data.split('/').reverse().join('-') + ' ' + a.hora);
                const dataB = new Date(b.data.split('/').reverse().join('-') + ' ' + b.hora);
                return dataA - dataB;
            });
            
            dados.forEach((item, index) => {
                const diferenca = index > 0 ? item.km - dados[index - 1].km : 0;
                const sinalDiferenca = diferenca > 0 ? '+' : '';
                
                relatorio += `  ‚Ä¢ ${item.data} ${item.hora} - ${item.tipo_rota}\n`;
                relatorio += `    KM: ${item.km.toLocaleString()} km`;
                
                if (index > 0) {
                    relatorio += ` (${sinalDiferenca}${diferenca.toLocaleString()} km)`;
                }
                
                relatorio += ` - ${item.colaborador}\n`;
            });
            
            relatorio += '\n' + '='.repeat(60) + '\n';
            relatorio += `Gerado em: ${new Date().toLocaleString('pt-BR')}\n`;
            
            return relatorio;
        }
        
        function criarRelatorioPorColaborador(dados, colaborador) {
            const total = dados.length;
            const inicios = dados.filter(d => d.tipo_rota === 'IN√çCIO').length;
            const finais = dados.filter(d => d.tipo_rota === 'FINAL').length;
            const kmTotal = dados.reduce((sum, d) => sum + (d.km || 0), 0);
            const veiculosUsados = [...new Set(dados.map(d => `${d.veiculo} (${d.placa})`))];
            
            let relatorio = `üë• RELAT√ìRIO POR COLABORADOR\n`;
            relatorio += `Colaborador: ${colaborador}\n`;
            relatorio += '='.repeat(60) + '\n\n';
            relatorio += `üìä ATIVIDADE DO COLABORADOR:\n`;
            relatorio += `‚Ä¢ Total de registros: ${total}\n`;
            relatorio += `‚Ä¢ In√≠cios de rota: ${inicios}\n`;
            relatorio += `‚Ä¢ Finais de rota: ${finais}\n`;
            relatorio += `‚Ä¢ KM total registrado: ${kmTotal.toLocaleString()} km\n`;
            relatorio += `‚Ä¢ Ve√≠culos utilizados: ${veiculosUsados.length}\n`;
            relatorio += `‚Ä¢ M√©dia KM/registro: ${(kmTotal / total).toFixed(0)} km\n\n`;
            
            // Ve√≠culos utilizados
            relatorio += `üöó VE√çCULOS UTILIZADOS:\n`;
            veiculosUsados.forEach((veiculo, index) => {
                const uso = dados.filter(d => `${d.veiculo} (${d.placa})` === veiculo).length;
                relatorio += `  ${index + 1}. ${veiculo}: ${uso} registros\n`;
            });
            
            // Hist√≥rico recente
            relatorio += `\nüìÖ √öLTIMOS REGISTROS:\n`;
            const ultimosRegistros = dados.slice(0, 10);
            
            ultimosRegistros.forEach(item => {
                relatorio += `  ‚Ä¢ ${item.data} ${item.hora}\n`;
                relatorio += `    ${item.veiculo} (${item.placa}) - ${item.km.toLocaleString()} km - ${item.tipo_rota}\n`;
            });
            
            if (dados.length > 10) {
                relatorio += `  ... e mais ${dados.length - 10} registros\n`;
            }
            
            relatorio += '\n' + '='.repeat(60) + '\n';
            relatorio += `Gerado em: ${new Date().toLocaleString('pt-BR')}\n`;
            
            return relatorio;
        }
        
        function criarRelatorioCompleto(dados) {
            const total = dados.length;
            const inicios = dados.filter(d => d.tipo_rota === 'IN√çCIO').length;
            const finais = dados.filter(d => d.tipo_rota === 'FINAL').length;
            const kmTotal = dados.reduce((sum, d) => sum + (d.km || 0), 0);
            const colaboradores = [...new Set(dados.map(d => d.colaborador))].length;
            const veiculos = [...new Set(dados.map(d => d.placa))].length;
            
            let relatorio = `üìã RELAT√ìRIO COMPLETO DO SISTEMA\n`;
            relatorio += '='.repeat(60) + '\n\n';
            relatorio += `üìä ESTAT√çSTICAS GERAIS:\n`;
            relatorio += `‚Ä¢ Total de registros: ${total}\n`;
            relatorio += `‚Ä¢ In√≠cios de rota: ${inicios}\n`;
            relatorio += `‚Ä¢ Finais de rota: ${finais}\n`;
            relatorio += `‚Ä¢ Colaboradores ativos: ${colaboradores}\n`;
            relatorio += `‚Ä¢ Ve√≠culos registrados: ${veiculos}\n`;
            relatorio += `‚Ä¢ KM total percorrido: ${kmTotal.toLocaleString()} km\n\n`;
            
            // An√°lise por ve√≠culo detalhada
            relatorio += `üöó AN√ÅLISE POR VE√çCULO:\n`;
            const veiculosAnalise = {};
            dados.forEach(item => {
                if (!veiculosAnalise[item.placa]) {
                    veiculosAnalise[item.placa] = {
                        veiculo: item.veiculo,
                        registros: [],
                        kmInicial: null,
                        kmAtual: 0
                    };
                }
                veiculosAnalise[item.placa].registros.push(item);
                if (!veiculosAnalise[item.placa].kmInicial || item.km < veiculosAnalise[item.placa].kmInicial) {
                    veiculosAnalise[item.placa].kmInicial = item.km;
                }
                if (item.km > veiculosAnalise[item.placa].kmAtual) {
                    veiculosAnalise[item.placa].kmAtual = item.km;
                }
            });
            
            Object.keys(veiculosAnalise).forEach(placa => {
                const v = veiculosAnalise[placa];
                const diferenca = v.kmAtual - v.kmInicial;
                relatorio += `  ‚Ä¢ ${v.veiculo} (${placa}):\n`;
                relatorio += `      Registros: ${v.registros.length}\n`;
                relatorio += `      KM inicial: ${v.kmInicial ? v.kmInicial.toLocaleString() : 'N/D'} km\n`;
                relatorio += `      KM atual: ${v.kmAtual.toLocaleString()} km\n`;
                relatorio += `      KM percorrido: +${diferenca.toLocaleString()} km\n\n`;
            });
            
            relatorio += '\n' + '='.repeat(60) + '\n';
            relatorio += `Gerado em: ${new Date().toLocaleString('pt-BR')}\n`;
            
            return relatorio;
        }
        
        function exportarRelatorio(conteudo, nomeArquivo) {
            try {
                const blob = new Blob([conteudo], { type: 'text/plain;charset=utf-8' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.href = url;
                link.download = nomeArquivo;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                mostrarNotificacao('‚úÖ Relat√≥rio gerado e baixado com sucesso!', 'success');
                fecharModalRelatorio();
                
            } catch (error) {
                console.error('‚ùå Erro ao exportar relat√≥rio:', error);
                mostrarNotificacao('‚ùå Erro ao exportar relat√≥rio.', 'error');
            }
        }
        
        // ========== FUN√á√ïES DE MODO PRODU√á√ÉO ==========
        async function iniciarModoProducao() {
            try {
                // Buscar dados atuais para an√°lise
                const { data: checklists, error } = await supabaseClient
                    .from('checklists')
                    .select('*');
                
                if (error) throw error;
                
                // Identificar dados de teste
                const dadosTeste = checklists.filter(item => 
                    item.placa.includes('TESTE') || 
                    item.colaborador.includes('TESTE') ||
                    (item.observacoes && item.observacoes.includes('TESTE'))
                );
                
                // Criar conte√∫do do modal
                let html = `
                    <div style="max-width: 600px;">
                        <h3 style="color: #2b6cb0; margin-top: 0;">üöÄ CONFIGURA√á√ÉO DE PRODU√á√ÉO</h3>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <h4>üìä AN√ÅLISE DO SISTEMA ATUAL</h4>
                            <p><strong>Total de registros:</strong> ${checklists.length}</p>
                            <p><strong>Registros de teste identificados:</strong> ${dadosTeste.length}</p>
                            <p><strong>Ve√≠culos ativos:</strong> ${[...new Set(checklists.map(c => c.placa))].length}</p>
                            <p><strong>Colaboradores ativos:</strong> ${[...new Set(checklists.map(c => c.colaborador))].length}</p>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <h4>‚öôÔ∏è CONFIGURA√á√ïES DO SISTEMA</h4>
                            <label style="display: block; margin: 10px 0;">
                                <input type="checkbox" id="validarKM" checked> üîç Ativar valida√ß√£o autom√°tica de KM
                            </label>
                            <label style="display: block; margin: 10px 0;">
                                <input type="checkbox" id="notificarInconsistencias" checked> üîî Notificar inconsist√™ncias de KM
                            </label>
                            <label style="display: block; margin: 10px 0;">
                                <input type="checkbox" id="backupAutomatico"> üíæ Ativar backup autom√°tico di√°rio
                            </label>
                            <label style="display: block; margin: 10px 0;">
                                <input type="checkbox" id="relatorioAutomatico"> üìä Gerar relat√≥rio autom√°tico semanal
                            </label>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <h4>üßπ LIMPEZA DE DADOS DE TESTE</h4>
                `;
                
                if (dadosTeste.length > 0) {
                    html += `
                        <p>Encontrados ${dadosTeste.length} registros de teste.</p>
                        <button onclick="excluirDadosTeste()" class="btn-danger" style="width: 100%; margin: 10px 0;">
                            üóëÔ∏è Excluir todos os dados de teste (${dadosTeste.length} registros)
                        </button>
                    `;
                } else {
                    html += `<p>‚úÖ N√£o h√° dados de teste para limpar.</p>`;
                }
                
                html += `
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 30px;">
                            <button onclick="fecharModalProducao()" class="btn-secondary" style="flex: 1;">
                                Cancelar
                            </button>
                            <button onclick="ativarConfiguracaoProducao()" class="btn-success" style="flex: 1;">
                                ‚úÖ Ativar Configura√ß√µes
                            </button>
                        </div>
                    </div>
                `;
                
                document.getElementById('producaoConteudo').innerHTML = html;
                document.getElementById('producaoModal').style.display = 'flex';
                
            } catch (error) {
                console.error('‚ùå Erro no modo produ√ß√£o:', error);
                mostrarNotificacao('‚ùå Erro ao configurar modo produ√ß√£o.', 'error');
            }
        }
        
        function fecharModalProducao() {
            document.getElementById('producaoModal').style.display = 'none';
        }
        
        async function ativarConfiguracaoProducao() {
            // Salvar configura√ß√µes
            const config = {
                modoProducao: true,
                validarKM: document.getElementById('validarKM').checked,
                notificarInconsistencias: document.getElementById('notificarInconsistencias').checked,
                backupAutomatico: document.getElementById('backupAutomatico').checked,
                relatorioAutomatico: document.getElementById('relatorioAutomatico').checked,
                ativadoEm: new Date().toISOString()
            };
            
            localStorage.setItem('configProducao', JSON.stringify(config));
            
            // Agendar tarefas se necess√°rio
            if (config.backupAutomatico) {
                mostrarNotificacao('‚úÖ Backup autom√°tico configurado para 02:00 diariamente.', 'success');
            }
            
            if (config.relatorioAutomatico) {
                mostrarNotificacao('‚úÖ Relat√≥rio autom√°tico configurado para segunda-feira √†s 08:00.', 'success');
            }
            
            mostrarNotificacao('‚úÖ Modo produ√ß√£o configurado com sucesso!', 'success');
            fecharModalProducao();
        }
        
        async function excluirDadosTeste() {
            if (!confirm(`üö® ATEN√á√ÉO!\n\nIsso excluir√° permanentemente todos os registros de teste.\n\nEsta a√ß√£o n√£o pode ser desfeita!\n\nContinuar?`)) {
                return;
            }
            
            try {
                const { error } = await supabaseClient
                    .from('checklists')
                    .delete()
                    .or('placa.ilike.%TESTE%,colaborador.ilike.%TESTE%');
                
                if (error) throw error;
                
                mostrarNotificacao('‚úÖ Dados de teste exclu√≠dos com sucesso!', 'success');
                carregarEstatisticas();
                carregarChecklists();
                fecharModalProducao();
                
            } catch (error) {
                console.error('‚ùå Erro ao excluir dados de teste:', error);
                mostrarNotificacao('‚ùå Erro ao excluir dados de teste.', 'error');
            }
        }
        
        // ========== FUN√á√ïES DE LIMPEZA DE TESTES ==========
        async function limparDadosTeste() {
            try {
                // Buscar dados de teste
                const { data: dadosTeste, error } = await supabaseClient
                    .from('checklists')
                    .select('*')
                    .or('placa.ilike.%TESTE%,colaborador.ilike.%TESTE%,observacoes.ilike.%TESTE%');
                
                if (error) throw error;
                
                if (!dadosTeste || dadosTeste.length === 0) {
                    mostrarNotificacao('‚úÖ N√£o h√° dados de teste para limpar.', 'success');
                    return;
                }
                
                // Mostrar op√ß√µes
                const opcao = prompt(
                    `üßπ LIMPAR DADOS DE TESTE\n\n` +
                    `Foram encontrados ${dadosTeste.length} registros de teste.\n\n` +
                    `Selecione a a√ß√£o:\n` +
                    `1. üóëÔ∏è Excluir TODOS os dados de teste\n` +
                    `2. üìã Exportar antes de excluir\n` +
                    `3. üîç Ver detalhes dos dados de teste\n` +
                    `4. ‚ùå Cancelar\n\n` +
                    `Digite o n√∫mero:`
                );
                
                switch(opcao) {
                    case '1':
                        if (confirm(`Excluir ${dadosTeste.length} registros de teste?\n\nEsta a√ß√£o √© IRREVERS√çVEL!`)) {
                            await excluirDadosTeste();
                        }
                        break;
                        
                    case '2':
                        exportarDadosTeste(dadosTeste);
                        break;
                        
                    case '3':
                        mostrarDetalhesTeste(dadosTeste);
                        break;
                        
                    default:
                        mostrarNotificacao('‚ÑπÔ∏è Opera√ß√£o cancelada.', 'info');
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao limpar dados de teste:', error);
                mostrarNotificacao('‚ùå Erro ao processar dados de teste.', 'error');
            }
        }
        
        function exportarDadosTeste(dados) {
            const csv = converterParaCSV(dados);
            const blob = new Blob([csv], { type: 'text/csv' });
            const link = document.createElement('a');
            
            link.href = URL.createObjectURL(blob);
            link.download = `backup_dados_teste_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            mostrarNotificacao('‚úÖ Dados de teste exportados para CSV!', 'success');
        }
        
        function mostrarDetalhesTeste(dados) {
            let detalhes = `üìã DETALHES DOS DADOS DE TESTE\n\n`;
            detalhes += `Total: ${dados.length} registros\n\n`;
            
            // Agrupar por placa
            const porPlaca = {};
            dados.forEach(item => {
                if (!porPlaca[item.placa]) {
                    porPlaca[item.placa] = 0;
                }
                porPlaca[item.placa]++;
            });
            
            detalhes += `Por placa:\n`;
            Object.keys(porPlaca).forEach(placa => {
                detalhes += `  ‚Ä¢ ${placa}: ${porPlaca[placa]} registros\n`;
            });
            
            alert(detalhes);
        }
        
        // ========== FUN√á√ïES DE GR√ÅFICOS ==========
        function mostrarGraficos() {
            const container = document.getElementById('graficosContainer');
            if (container.style.display === 'none') {
                container.style.display = 'grid';
                criarGraficos();
                mostrarNotificacao('üìä Gr√°ficos carregados!', 'success');
            } else {
                container.style.display = 'none';
                mostrarNotificacao('üìä Gr√°ficos ocultados.', 'info');
            }
        }
        
        function criarGraficos() {
            if (!checklistsData || checklistsData.length === 0) {
                mostrarNotificacao('‚ÑπÔ∏è N√£o h√° dados suficientes para gerar gr√°ficos.', 'warning');
                return;
            }            
            // Gr√°fico de tipos de rota por dia
            criarGraficoRota();
            
            // Gr√°fico de top ve√≠culos
            criarGraficoVeiculos();
            
            // Gr√°fico de colaboradores
            criarGraficoColaboradores();
            
            // Gr√°fico de KM mensal
            criarGraficoKM();
        }
        
        function criarGraficoRota() {
            const ctx = document.getElementById('graficoRota').getContext('2d');
            
            // Agrupar por data e tipo
            const dadosPorDia = {};
            checklistsData.forEach(item => {
                const data = formatarDataBrasileira(item.data);
                if (!dadosPorDia[data]) {
                    dadosPorDia[data] = { IN√çCIO: 0, FINAL: 0 };
                }
                dadosPorDia[data][item.tipo_rota]++;
            });
            
            const datas = Object.keys(dadosPorDia).slice(-7); // √öltimos 7 dias
            const inicios = datas.map(data => dadosPorDia[data].IN√çCIO || 0);
            const finais = datas.map(data => dadosPorDia[data].FINAL || 0);
            
            if (graficos.rota) graficos.rota.destroy();
            
            graficos.rota = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: datas,
                    datasets: [
                        {
                            label: 'In√≠cio de Rota',
                            data: inicios,
                            backgroundColor: '#10b981',
                            borderColor: '#059669',
                            borderWidth: 1
                        },
                        {
                            label: 'Final de Rota',
                            data: finais,
                            backgroundColor: '#ef4444',
                            borderColor: '#dc2626',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Distribui√ß√£o por Tipo de Rota'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }
        
        function criarGraficoVeiculos() {
            const ctx = document.getElementById('graficoVeiculos').getContext('2d');
            
            // Contar por ve√≠culo
            const contagemVeiculos = {};
            checklistsData.forEach(item => {
                const veiculo = item.veiculo || 'Desconhecido';
                contagemVeiculos[veiculo] = (contagemVeiculos[veiculo] || 0) + 1;
            });
            
            // Ordenar e pegar top 5
            const veiculosOrdenados = Object.entries(contagemVeiculos)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            const nomes = veiculosOrdenados.map(v => v[0]);
            const quantidades = veiculosOrdenados.map(v => v[1]);
            
            if (graficos.veiculos) graficos.veiculos.destroy();
            
            graficos.veiculos = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: nomes,
                    datasets: [{
                        data: quantidades,
                        backgroundColor: [
                            '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        title: {
                            display: true,
                            text: 'Top 5 Ve√≠culos Mais Usados'
                        }
                    }
                }
            });
        }
        
        function criarGraficoColaboradores() {
            const ctx = document.getElementById('graficoColaboradores').getContext('2d');
            
            // Contar por colaborador
            const contagemColaboradores = {};
            checklistsData.forEach(item => {
                const colaborador = item.colaborador || 'Desconhecido';
                contagemColaboradores[colaborador] = (contagemColaboradores[colaborador] || 0) + 1;
            });
            
            // Ordenar e pegar top 10
            const colaboradoresOrdenados = Object.entries(contagemColaboradores)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            const nomes = colaboradoresOrdenados.map(c => c[0]);
            const quantidades = colaboradoresOrdenados.map(c => c[1]);
            
            if (graficos.colaboradores) graficos.colaboradores.destroy();
            
            graficos.colaboradores = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: nomes,
                    datasets: [{
                        label: 'Registros',
                        data: quantidades,
                        backgroundColor: '#3b82f6',
                        borderColor: '#2563eb',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Atividade por Colaborador'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }
        
        function criarGraficoKM() {
            const ctx = document.getElementById('graficoKM').getContext('2d');
            
            // Agrupar por m√™s
            const dadosPorMes = {};
            checklistsData.forEach(item => {
                const data = new Date(item.data.split('/').reverse().join('-'));
                const mesAno = `${data.getMonth() + 1}/${data.getFullYear()}`;
                
                if (!dadosPorMes[mesAno]) {
                    dadosPorMes[mesAno] = 0;
                }
                dadosPorMes[mesAno] += (item.km || 0);
            });
            
            const meses = Object.keys(dadosPorMes);
            const kms = meses.map(mes => dadosPorMes[mes]);
            
            if (graficos.km) graficos.km.destroy();
            
            graficos.km = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: meses,
                    datasets: [{
                        label: 'KM Percorrido',
                        data: kms,
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderColor: '#3b82f6',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Evolu√ß√£o de KM Mensal'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString() + ' km';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // ========== FUN√á√ïES PRINCIPAIS DO DASHBOARD ==========
        // ========== FUN√á√ÉO PARA CARREGAR CHECKLISTS ==========
        async function carregarChecklists() {
            if (!supabaseClient) {
                mostrarNotificacao('‚ùå Supabase n√£o inicializado.', 'error');
                return;
            }
            
            try {
                // Mostrar loading
                document.getElementById('tabelaCorpo').innerHTML = `
                    <tr>
                        <td colspan="7" class="loading">
                            <div class="spinner"></div>
                            <div>Carregando registros...</div>
                        </td>
                    </tr>
                `;
                
                console.log('üì• Carregando checklists do Supabase...');
                
                // Buscar dados do Supabase
                const { data, error } = await supabaseClient
                    .from('checklists')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                // Armazenar dados globalmente
                checklistsData = data || [];
                
                console.log(`‚úÖ ${checklistsData.length} registros carregados`);
                
                // Atualizar contador
                document.getElementById('contadorRegistros').textContent = 
                    `${checklistsData.length} registros encontrados`;
                
                // Renderizar tabela
                renderizarTabela(checklistsData);
                
                // Atualizar filtro de colaboradores
                atualizarFiltroColaboradores();
                
                mostrarNotificacao(`‚úÖ ${checklistsData.length} registros carregados`, 'success');
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar checklists:', error);
                
                document.getElementById('tabelaCorpo').innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #dc3545;">
                            <div style="font-size: 48px;">‚ùå</div>
                            <div style="margin-top: 10px;">Erro ao carregar registros</div>
                            <button onclick="carregarChecklists()" style="margin-top: 15px;" class="btn-primary">
                                Tentar Novamente
                            </button>
                        </td>
                    </tr>
                `;
                
                mostrarNotificacao('‚ùå Erro ao carregar registros.', 'error');
            }
        }

        // ========== RENDERIZAR TABELA ==========
        function renderizarTabela(dados) {
            const tbody = document.getElementById('tabelaCorpo');
            
            if (!dados || dados.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #666;">
                            <div style="font-size: 48px;">üì≠</div>
                            <div style="margin-top: 10px;">Nenhum registro encontrado</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            
            dados.forEach(item => {
                const tipoBadge = item.tipo_rota === 'IN√çCIO' ? 
                    '<span class="badge badge-inicio">IN√çCIO</span>' : 
                    '<span class="badge badge-final">FINAL</span>';
                
                // üî• CORRE√á√ÉO: Formatar data para padr√£o brasileiro
                const dataFormatada = formatarDataBrasileira(item.data);
                
                html += `
                    <tr>
                        <td>${dataFormatada} ${item.hora}</td>
                        <td>${escapeHtml(item.veiculo || 'N/D')}</td>
                        <td><strong>${escapeHtml(item.placa || 'N/D')}</strong></td>
                        <td>${escapeHtml(item.colaborador || 'N/D')}</td>
                        <td><strong>${item.km ? item.km.toLocaleString() : '0'} km</strong></td>
                        <td>${tipoBadge}</td>
                        <td>
                            <button onclick="verDetalhes('${item.id}')" class="btn-info" title="Ver detalhes">
                                üëÅÔ∏è
                            </button>
                            <button onclick="excluirChecklist('${item.id}', '${escapeHtml(item.placa)}')" class="btn-danger" title="Excluir">
                                üóëÔ∏è
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        // ========== VER DETALHES ==========
        async function verDetalhes(id) {
            try {
                // Buscar detalhes do registro
                const { data, error } = await supabaseClient
                    .from('checklists')
                    .select('*')
                    .eq('id', id)
                    .single();
                
                if (error) throw error;
                
                // üî• CORRE√á√ÉO: Formatar data para padr√£o brasileiro
                const dataFormatada = formatarDataBrasileira(data.data);
                
                let html = `
                    <div style="max-width: 600px;">
                        <h3 style="color: #2b6cb0; margin-top: 0;">üìã Detalhes do Checklist</h3>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div>
                                    <strong>ID:</strong><br>
                                    <small>${data.id}</small>
                                </div>
                                <div>
                                    <strong>Tipo de Rota:</strong><br>
                                    <span class="${data.tipo_rota === 'IN√çCIO' ? 'badge-inicio' : 'badge-final'}">
                                        ${data.tipo_rota}
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <h4>üìù Informa√ß√µes do Registro</h4>
                            <table style="width: 100%; border-collapse: collapse;">
                                <tr>
                                    <td style="padding: 8px 0; border-bottom: 1px solid #eee;"><strong>Data:</strong></td>
                                    <td style="padding: 8px 0; border-bottom: 1px solid #eee;">${dataFormatada}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px 0; border-bottom: 1px solid #eee;"><strong>Hora:</strong></td>
                                    <td style="padding: 8px 0; border-bottom: 1px solid #eee;">${data.hora}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px 0; border-bottom: 1px solid #eee;"><strong>Colaborador:</strong></td>
                                    <td style="padding: 8px 0; border-bottom: 1px solid #eee;">${escapeHtml(data.colaborador)}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px 0; border-bottom: 1px solid #eee;"><strong>Ve√≠culo:</strong></td>
                                    <td style="padding: 8px 0; border-bottom: 1px solid #eee;">${escapeHtml(data.veiculo)}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px 0; border-bottom: 1px solid #eee;"><strong>Placa:</strong></td>
                                    <td style="padding: 8px 0; border-bottom: 1px solid #eee;">${escapeHtml(data.placa)}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px 0; border-bottom: 1px solid #eee;"><strong>KM:</strong></td>
                                    <td style="padding: 8px 0; border-bottom: 1px solid #eee;">
                                        <strong style="font-size: 18px;">${data.km.toLocaleString()} km</strong>
                                    </td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px 0; border-bottom: 1px solid #eee;"><strong>Tipo Ve√≠culo:</strong></td>
                                    <td style="padding: 8px 0; border-bottom: 1px solid #eee;">${escapeHtml(data.tipo_veiculo)}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px 0; border-bottom: 1px solid #eee;"><strong>Registrado em:</strong></td>
                                    <td style="padding: 8px 0; border-bottom: 1px solid #eee;">
                                        ${new Date(data.created_at).toLocaleString('pt-BR')}
                                    </td>
                                </tr>
                            </table>
                        </div>
                `;
                
                // Mostrar foto se existir
                if (data.foto_painel_base64) {
                    html += `
                        <div style="margin-bottom: 20px;">
                            <h4>üì∑ Foto do Painel</h4>
                            <img src="${data.foto_painel_base64}" 
                                 alt="Foto do painel" 
                                 style="max-width: 100%; border-radius: 8px; border: 1px solid #ddd;">
                        </div>
                    `;
                }
                
                // Mostrar assinatura se existir
                if (data.assinatura_base64) {
                    html += `
                        <div style="margin-bottom: 20px;">
                            <h4>‚úçÔ∏è Assinatura Digital</h4>
                            <img src="${data.assinatura_base64}" 
                                 alt="Assinatura digital" 
                                 style="max-width: 100%; border-radius: 8px; border: 1px solid #ddd;">
                        </div>
                    `;
                }
                
                html += `
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button onclick="fecharModal()" class="btn-secondary" style="flex: 1;">
                                Fechar
                            </button>
                            <button onclick="excluirChecklist('${data.id}', '${escapeHtml(data.placa)}')" 
                                    class="btn-danger" style="flex: 1;">
                                üóëÔ∏è Excluir Registro
                            </button>
                        </div>
                    </div>
                `;
                
                document.getElementById('modalConteudo').innerHTML = html;
                document.getElementById('detalhesModal').style.display = 'flex';
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar detalhes:', error);
                mostrarNotificacao('‚ùå Erro ao carregar detalhes.', 'error');
            }
        }

        // ========== EXCLUIR CHECKLIST ==========
        async function excluirChecklist(id, placa) {
            if (!confirm(`üö® ATEN√á√ÉO!\n\nDeseja excluir o registro do ve√≠culo ${placa}?\n\nEsta a√ß√£o n√£o pode ser desfeita!`)) {
                return;
            }
            
            try {
                const { error } = await supabaseClient
                    .from('checklists')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                mostrarNotificacao('‚úÖ Registro exclu√≠do com sucesso!', 'success');
                
                // Fechar modal se estiver aberto
                fecharModal();
                
                // Atualizar dados
                await carregarChecklists();
                await carregarEstatisticas();
                
            } catch (error) {
                console.error('‚ùå Erro ao excluir checklist:', error);
                mostrarNotificacao('‚ùå Erro ao excluir registro.', 'error');
            }
        }

        // ========== ATUALIZAR FILTRO DE COLABORADORES ==========
        function atualizarFiltroColaboradores() {
            if (!checklistsData || checklistsData.length === 0) return;
            
            const select = document.getElementById('filtroColaborador');
            const colaboradores = [...new Set(checklistsData.map(c => c.colaborador).filter(Boolean))];
            
            // Limpar op√ß√µes antigas (exceto a primeira)
            select.innerHTML = '<option value="">Todos os colaboradores</option>';
            
            // Adicionar colaboradores
            colaboradores.sort().forEach(colab => {
                const option = document.createElement('option');
                option.value = colab;
                option.textContent = colab;
                select.appendChild(option);
            });
        }

        // ========== APLICAR FILTROS ==========
        function aplicarFiltros() {
            const placa = document.getElementById('filtroPlaca').value.toUpperCase();
            const colaborador = document.getElementById('filtroColaborador').value;
            const dataInicio = document.getElementById('filtroDataInicio').value;
            const dataFim = document.getElementById('filtroDataFim').value;
            const tipoRota = document.getElementById('filtroTipoRota').value;
            
            let dadosFiltrados = [...checklistsData];
            
            // Filtro por placa
            if (placa) {
                dadosFiltrados = dadosFiltrados.filter(item => 
                    item.placa && item.placa.toUpperCase().includes(placa)
                );
            }
            
            // Filtro por colaborador
            if (colaborador) {
                dadosFiltrados = dadosFiltrados.filter(item => 
                    item.colaborador === colaborador
                );
            }
            
            // Filtro por data (considerando formato brasileiro)
            if (dataInicio || dataFim) {
                dadosFiltrados = dadosFiltrados.filter(item => {
                    const dataItem = formatarDataBrasileira(item.data);
                    const [dia, mes, ano] = dataItem.split('/');
                    const itemDate = new Date(`${ano}-${mes}-${dia}`);
                    
                    let inicioOk = true;
                    let fimOk = true;
                    
                    if (dataInicio) {
                        const inicioDate = new Date(dataInicio);
                        inicioOk = itemDate >= inicioDate;
                    }
                    
                    if (dataFim) {
                        const fimDate = new Date(dataFim);
                        fimOk = itemDate <= fimDate;
                    }
                    
                    return inicioOk && fimOk;
                });
            }
            
            // Filtro por tipo de rota
            if (tipoRota) {
                dadosFiltrados = dadosFiltrados.filter(item => 
                    item.tipo_rota === tipoRota
                );
            }
            
            // Renderizar tabela filtrada
            renderizarTabela(dadosFiltrados);
            
            // Atualizar contador
            document.getElementById('contadorRegistros').textContent = 
                `${dadosFiltrados.length} registros encontrados`;
            
            // Mostrar notifica√ß√£o se houver filtros ativos
            const filtrosAtivos = [placa, colaborador, dataInicio, dataFim, tipoRota].filter(f => f).length;
            if (filtrosAtivos > 0) {
                mostrarNotificacao(`‚úÖ ${dadosFiltrados.length} registros filtrados`, 'success');
            }
        }

        // ========== LIMPAR FILTROS ==========
        function limparFiltros() {
            document.getElementById('filtroPlaca').value = '';
            document.getElementById('filtroColaborador').value = '';
            document.getElementById('filtroDataInicio').value = '';
            document.getElementById('filtroDataFim').value = '';
            document.getElementById('filtroTipoRota').value = '';
            
            aplicarFiltros();
            mostrarNotificacao('‚úÖ Filtros limpos', 'success');
        }

        // ========== EXPORTAR DADOS ==========
        function exportarDados() {
            if (!checklistsData || checklistsData.length === 0) {
                mostrarNotificacao('‚ÑπÔ∏è N√£o h√° dados para exportar.', 'warning');
                return;
            }
            
            try {
                // Converter para CSV
                const csv = converterParaCSV(checklistsData);
                
                // Criar blob e link para download
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                
                if (navigator.msSaveBlob) {
                    navigator.msSaveBlob(blob, `checklists_${new Date().toISOString().split('T')[0]}.csv`);
                } else {
                    link.href = URL.createObjectURL(blob);
                    link.setAttribute('download', `checklists_${new Date().toISOString().split('T')[0]}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
                
                mostrarNotificacao('‚úÖ Dados exportados para CSV!', 'success');
                
            } catch (error) {
                console.error('‚ùå Erro ao exportar dados:', error);
                mostrarNotificacao('‚ùå Erro ao exportar dados.', 'error');
            }
        }

        // ========== CONVERTER PARA CSV ==========
        function converterParaCSV(dados) {
            if (!dados || dados.length === 0) return '';
            
            // Definir cabe√ßalhos
            const cabecalhos = [
                'ID',
                'Data',
                'Hora',
                'Colaborador',
                'Tipo Ve√≠culo',
                'Ve√≠culo',
                'Placa',
                'KM',
                'Tipo Rota',
                'Data Registro'
            ];
            
            // Criar linhas
            const linhas = dados.map(item => [
                item.id,
                formatarDataBrasileira(item.data), // üî• CORRE√á√ÉO: Formatar data
                item.hora,
                item.colaborador,
                item.tipo_veiculo,
                item.veiculo,
                item.placa,
                item.km,
                item.tipo_rota,
                new Date(item.created_at).toLocaleString('pt-BR')
            ]);
            
            // Combinar tudo
            const conteudo = [
                cabecalhos.join(','),
                ...linhas.map(linha => linha.map(campo => 
                    `"${String(campo).replace(/"/g, '""')}"`
                ).join(','))
            ].join('\n');
            
            return conteudo;
        }

        // ========== FECHAR MODAL ==========
        function fecharModal() {
            document.getElementById('detalhesModal').style.display = 'none';
        }

        // ========== ATUALIZAR DASHBOARD ==========
        function atualizarDashboard() {
            carregarEstatisticas();
            carregarChecklists();
            mostrarNotificacao('‚úÖ Dashboard atualizado!', 'success');
        }

        // ========== FUN√á√ïES EXISTENTES (mantidas) ==========
        async function carregarEstatisticas() {
    if (!supabaseClient) {
        console.warn('‚ö†Ô∏è Supabase n√£o inicializado');
        return;
    }
    
    try {
        console.log('üìä Carregando estat√≠sticas...');
        
        const { data, error } = await supabaseClient
            .from('checklists')
            .select('*');
        
        if (error) throw error;
        
        const total = data ? data.length : 0;
        let inicios = 0, finais = 0;
        let colaboradores = new Set();
        let veiculos = new Set();
        let placas = new Set();
        let totalKM = 0;
        
        if (data && data.length > 0) {
            // üî• CORRE√á√ÉO: Agrupar KM por ve√≠culo
            const kmPorVeiculo = {};
            
            data.forEach(item => {
                if (item.tipo_rota === 'IN√çCIO') inicios++;
                if (item.tipo_rota === 'FINAL') finais++;
                if (item.colaborador) colaboradores.add(item.colaborador);
                if (item.veiculo) veiculos.add(item.veiculo);
                if (item.placa) placas.add(item.placa);
                
                // üî• CORRE√á√ÉO: Coletar KMs por ve√≠culo
                if (item.placa && item.km) {
                    if (!kmPorVeiculo[item.placa]) {
                        kmPorVeiculo[item.placa] = {
                            kmMin: item.km,
                            kmMax: item.km,
                            veiculo: item.veiculo
                        };
                    } else {
                        // Atualizar m√≠nimo e m√°ximo
                        if (item.km < kmPorVeiculo[item.placa].kmMin) {
                            kmPorVeiculo[item.placa].kmMin = item.km;
                        }
                        if (item.km > kmPorVeiculo[item.placa].kmMax) {
                            kmPorVeiculo[item.placa].kmMax = item.km;
                        }
                    }
                }
            });
            
            // üî• CALCULAR KM TOTAL PERCORRIDO CORRETAMENTE
            totalKM = 0;
            Object.values(kmPorVeiculo).forEach(veiculo => {
                const kmPercorrido = veiculo.kmMax - veiculo.kmMin;
                if (kmPercorrido > 0) {
                    totalKM += kmPercorrido;
                }
            });
            
            console.log('üîç Detalhes do c√°lculo:', {
                veiculos: Object.keys(kmPorVeiculo).length,
                kmPorVeiculo,
                totalKM
            });
        }
        
        const mediaKM = total > 0 ? (totalKM / total).toFixed(0) : 0;
        
        // Atualizar estat√≠sticas
        document.getElementById('stats').innerHTML = `
            <div class="stat-card" onclick="filtrarPorTipo('')" title="Clique para ver todos">
                <div class="stat-numero">${total}</div>
                <div class="stat-label">Total de Registros</div>
            </div>
            <div class="stat-card" onclick="filtrarPorTipo('IN√çCIO')" title="Clique para filtrar in√≠cios">
                <div class="stat-numero">${inicios}</div>
                <div class="stat-label">In√≠cios de Rota</div>
            </div>
            <div class="stat-card" onclick="filtrarPorTipo('FINAL')" title="Clique para filtrar finais">
                <div class="stat-numero">${finais}</div>
                <div class="stat-label">Finais de Rota</div>
            </div>
            <div class="stat-card" onclick="filtrarPorColaborador('')" title="Clique para ver colaboradores">
                <div class="stat-numero">${colaboradores.size}</div>
                <div class="stat-label">Colaboradores</div>
            </div>
            <div class="stat-card" onclick="filtrarPorVeiculo('')" title="Clique para ver ve√≠culos">
                <div class="stat-numero">${placas.size}</div>
                <div class="stat-label">Ve√≠culos</div>
            </div>
            <div class="stat-card">
                <div class="stat-numero">${totalKM.toLocaleString()}</div>
                <div class="stat-label">KM Total Percorrido</div>
            </div>
            <div class="stat-card">
                <div class="stat-numero">${mediaKM}</div>
                <div class="stat-label">M√©dia KM/Registro</div>
            </div>
        `;
        
    } catch (error) {
        console.error('Erro ao carregar estat√≠sticas:', error);
        document.getElementById('stats').innerHTML = `
            <div class="stat-card" style="grid-column: 1 / -1;">
                <div style="color: #dc3545; font-size: 20px;">‚ùå</div>
                <div class="stat-label">Erro ao carregar estat√≠sticas</div>
            </div>
        `;
    }
}
        
        // Fun√ß√µes de filtro r√°pido pelos cards
        function filtrarPorTipo(tipo) {
            if (tipo) {
                document.getElementById('filtroTipoRota').value = tipo;
                aplicarFiltros();
                mostrarNotificacao(`‚úÖ Filtrado por: ${tipo === 'IN√çCIO' ? 'In√≠cios de Rota' : 'Finais de Rota'}`, 'success');
            } else {
                document.getElementById('filtroTipoRota').value = '';
                aplicarFiltros();
            }
        }
        
        // Fun√ß√£o para verificar KM inconsistente
        async function verificarKMInconsistente() {
            if (!checklistsData || checklistsData.length === 0) {
                mostrarNotificacao('‚ÑπÔ∏è N√£o h√° dados para verificar.', 'warning');
                return;
            }
            
            try {
                // Agrupar por placa e verificar sequ√™ncia de KM
                const inconsistencias = [];
                const veiculosAgrupados = {};
                
                // Agrupar por placa
                checklistsData.forEach(item => {
                    if (!veiculosAgrupados[item.placa]) {
                        veiculosAgrupados[item.placa] = [];
                    }
                    veiculosAgrupados[item.placa].push({
                        id: item.id,
                        data: item.data,
                        hora: item.hora,
                        km: item.km,
                        tipo_rota: item.tipo_rota,
                        colaborador: item.colaborador
                    });
                });
                
                // Verificar cada ve√≠culo
                Object.keys(veiculosAgrupados).forEach(placa => {
                    const registros = veiculosAgrupados[placa]
                        .sort((a, b) => {
                            const dataA = new Date(a.data.split('/').reverse().join('-') + ' ' + a.hora);
                            const dataB = new Date(b.data.split('/').reverse().join('-') + ' ' + b.hora);
                            return dataA - dataB;
                        });
                    
                    for (let i = 1; i < registros.length; i++) {
                        const anterior = registros[i - 1];
                        const atual = registros[i];
                        
                        if (atual.km < anterior.km) {
                            inconsistencias.push({
                                placa: placa,
                                problema: 'KM DECRESCENTE',
                                detalhes: `KM diminuiu de ${anterior.km.toLocaleString()} para ${atual.km.toLocaleString()}`,
                                dataAnterior: anterior.data,
                                dataAtual: atual.data,
                                diferenca: anterior.km - atual.km
                            });
                        }
                    }
                });
                
                if (inconsistencias.length === 0) {
                    mostrarNotificacao('‚úÖ Nenhuma inconsist√™ncia de KM encontrada!', 'success');
                    return;
                }
                
                // Mostrar relat√≥rio de inconsist√™ncias
                let relatorio = `‚ö†Ô∏è INCONSIST√äNCIAS DE KM ENCONTRADAS\n\n`;
                relatorio += `Total: ${inconsistencias.length} inconsist√™ncia(s)\n\n`;
                
                inconsistencias.forEach((inc, index) => {
                    relatorio += `${index + 1}. ${inc.placa} - ${inc.problema}\n`;
                    relatorio += `   ${inc.detalhes}\n`;
                    relatorio += `   Data anterior: ${inc.dataAnterior}\n`;
                    relatorio += `   Data atual: ${inc.dataAtual}\n`;
                    relatorio += `   Diferen√ßa: -${inc.diferenca.toLocaleString()} km\n\n`;
                });
                
                // Exportar relat√≥rio
                const blob = new Blob([relatorio], { type: 'text/plain' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `inconsistencias_km_${new Date().toISOString().split('T')[0]}.txt`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                mostrarNotificacao(`‚ö†Ô∏è ${inconsistencias.length} inconsist√™ncia(s) encontradas. Relat√≥rio exportado.`, 'warning');
                
            } catch (error) {
                console.error('‚ùå Erro ao verificar KM:', error);
                mostrarNotificacao('‚ùå Erro ao verificar inconsist√™ncias.', 'error');
            }
        }
        
        // ========== INICIALIZA√á√ÉO ==========
        window.onload = async function() {
            console.log('üöÄ Iniciando dashboard...');
            
            // Inicializar Supabase
            const conectado = await inicializarSupabase();
            
            if (conectado) {
                // Carregar dados
                await carregarEstatisticas();
                await carregarChecklists();
                
                // Configurar atualiza√ß√£o autom√°tica a cada 30 segundos
                setInterval(carregarEstatisticas, 30000);
                
                // Configurar eventos
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') fecharModal();
                });
                
                document.getElementById('detalhesModal').addEventListener('click', (e) => {
                    if (e.target.id === 'detalhesModal') {
                        fecharModal();
                    }
                });
                
                document.getElementById('relatorioModal').addEventListener('click', (e) => {
                    if (e.target.id === 'relatorioModal') {
                        fecharModalRelatorio();
                    }
                });
                
                document.getElementById('producaoModal').addEventListener('click', (e) => {
                    if (e.target.id === 'producaoModal') {
                        fecharModalProducao();
                    }
                });
                
                document.getElementById('colaboradoresModal').addEventListener('click', (e) => {
                    if (e.target.id === 'colaboradoresModal') {
                        fecharModalColaboradores();
                    }
                });
                
                // Configurar filtro de data para √∫ltimos 30 dias
                const hoje = new Date().toISOString().split('T')[0];
                document.getElementById('filtroDataFim').value = hoje;
                
                const trintaDiasAtras = new Date();
                trintaDiasAtras.setDate(trintaDiasAtras.getDate() - 30);
                document.getElementById('filtroDataInicio').value = trintaDiasAtras.toISOString().split('T')[0];
                
                // Mostrar notifica√ß√£o inicial
                setTimeout(() => {
                    mostrarNotificacao('‚úÖ Dashboard carregado com sucesso!', 'success');
                }, 1000);
                
            } else {
                // Mostrar erro de conex√£o
                document.getElementById('stats').innerHTML = `
                    <div class="stat-card" style="grid-column: 1 / -1;">
                        <div style="color: #dc3545; font-size: 48px;">‚ö†Ô∏è</div>
                        <div class="stat-label" style="font-size: 16px; margin-top: 10px;">
                            Erro de conex√£o com o banco de dados
                        </div>
                        <button onclick="location.reload()" style="margin-top: 15px;" class="btn-primary">
                            Tentar Reconectar
                        </button>
                    </div>
                `;
                
                document.getElementById('tabelaCorpo').innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #dc3545;">
                            <div style="font-size: 48px;">üîå</div>
                            <div style="margin-top: 10px;">N√£o foi poss√≠vel conectar ao Supabase</div>
                            <button onclick="location.reload()" style="margin-top: 15px;" class="btn-primary">
                                Recarregar P√°gina
                            </button>
                        </td>
                    </tr>
                `;
            }
        };
    </script>
</body>
</html>
