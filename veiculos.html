<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöó Gerenciamento de Ve√≠culos</title>
    
    <!-- SUPABASE -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1300px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: #1e40af;
            color: white;
            padding: 25px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 28px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            padding: 20px 30px;
            background: #f8f9fa;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
        }
        
        .stat-numero {
            font-size: 32px;
            font-weight: bold;
            color: #1e40af;
        }
        
        .stat-label {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }
        
        .content {
            padding: 30px;
        }
        
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #1e40af;
            color: white;
        }
        
        .btn-primary:hover {
            background: #1e3a8a;
        }
        
        .btn-success {
            background: #059669;
            color: white;
        }
        
        .btn-success:hover {
            background: #047857;
        }
        
        .btn-warning {
            background: #d97706;
            color: white;
        }
        
        .btn-warning:hover {
            background: #b45309;
        }
        
        .btn-danger {
            background: #dc2626;
            color: white;
        }
        
        .btn-danger:hover {
            background: #b91c1b;
        }
        
        .btn-info {
            background: #0891b2;
            color: white;
        }
        
        .btn-info:hover {
            background: #0e7490;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th {
            background: #1e40af;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }
        
        .badge-danger {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 700px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .modal-header {
            padding: 20px 30px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
        }
        
        .modal-header h2 {
            margin: 0;
            color: #1e40af;
        }
        
        .modal-body {
            padding: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #1e40af;
            box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1001;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .notification.success {
            background: #059669;
        }
        
        .notification.error {
            background: #dc2626;
        }
        
        .notification.info {
            background: #0891b2;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #1e40af;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .btn-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        .error-message {
            color: #dc2626;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }
        
        .input-error {
            border-color: #dc2626 !important;
            background-color: #fff8f8;
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-active {
            background: #10b981;
        }
        
        .status-inactive {
            background: #ef4444;
        }
        
        .status-maintenance {
            background: #f59e0b;
        }
        
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <h1>üöó Gerenciamento de Ve√≠culos</h1>
            <div>
                <button onclick="fecharJanela()" class="btn btn-warning">‚úï Fechar</button>
            </div>
        </div>
        
        <!-- ESTAT√çSTICAS -->
        <div class="stats-grid" id="stats">
            <div class="stat-card">
                <div class="spinner"></div>
                <div class="stat-label">Carregando...</div>
            </div>
        </div>
        
        <!-- CONTE√öDO PRINCIPAL -->
        <div class="content">
            <!-- TOOLBAR -->
            <div class="toolbar">
                <h2>Frota de Ve√≠culos</h2>
                <button onclick="abrirModalNovo()" class="btn btn-success">Ôºã Novo Ve√≠culo</button>
            </div>
            
            <!-- TABELA -->
            <div id="tabelaContainer">
                <table>
                    <thead>
                        <tr>
                            <th>Placa</th>
                            <th>Modelo</th>
                            <th>Ano</th>
                            <th>Cor</th>
                            <th>Status</th>
                            <th>√öltima Manuten√ß√£o</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaBody">
                        <tr>
                            <td colspan="7" class="loading">
                                <div class="spinner"></div>
                                <div>Carregando ve√≠culos...</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- MODAL NOVO/EDITAR VE√çCULO -->
    <div class="modal" id="modalVeiculo">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitulo">üöó Novo Ve√≠culo</h2>
                <button onclick="fecharModal()" class="btn-close">√ó</button>
            </div>
            <div class="modal-body">
                <form id="formVeiculo">
                    <input type="hidden" id="veiculoId">
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="placa">Placa *</label>
                            <input type="text" id="placa" required maxlength="8" oninput="formatarPlaca(this)" placeholder="ABC-1234">
                            <div class="error-message" id="placaError">Formato: ABC-1234 ou ABC1D23</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="modelo">Modelo *</label>
                            <input type="text" id="modelo" required onblur="capitalizarPrimeiraLetra(this)">
                            <div class="error-message" id="modeloError">Modelo √© obrigat√≥rio</div>
                        </div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="marca">Marca *</label>
                            <input type="text" id="marca" required onblur="capitalizarPrimeiraLetra(this)">
                            <div class="error-message" id="marcaError">Marca √© obrigat√≥ria</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="ano">Ano *</label>
                            <input type="number" id="ano" min="1990" max="2025" required>
                            <div class="error-message" id="anoError">Ano entre 1990 e 2025</div>
                        </div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="cor">Cor</label>
                            <input type="text" id="cor" onblur="capitalizarPrimeiraLetra(this)">
                        </div>
                        
                        <div class="form-group">
                            <label for="km_atual">KM Atual *</label>
                            <input type="number" id="km_atual" min="0" required>
                            <div class="error-message" id="kmError">KM atual √© obrigat√≥rio</div>
                        </div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="tipo_combustivel">Tipo de Combust√≠vel</label>
                            <select id="tipo_combustivel">
                                <option value="">Selecione</option>
                                <option value="GASOLINA">Gasolina</option>
                                <option value="ETANOL">Etanol</option>
                                <option value="DIESEL">Diesel</option>
                                <option value="FLEX">Flex</option>
                                <option value="GNV">GNV</option>
                                <option value="ELETRICO">El√©trico</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="status">Status *</label>
                            <select id="status" required>
                                <option value="ativo">Ativo</option>
                                <option value="inativo">Inativo</option>
                                <option value="manutencao">Em Manuten√ß√£o</option>
                            </select>
                            <div class="error-message" id="statusError">Status √© obrigat√≥rio</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="observacoes">Observa√ß√µes</label>
                        <textarea id="observacoes" rows="3" placeholder="Observa√ß√µes sobre o ve√≠culo..."></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 30px;">
                        <button type="button" onclick="fecharModal()" class="btn" style="flex: 1; background: #6c757d; color: white;">
                            Cancelar
                        </button>
                        <button type="button" onclick="validarESalvar()" class="btn btn-success" style="flex: 1;">
                            ‚úÖ Salvar Ve√≠culo
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURA√á√ÉO INICIAL - DECLARAR VARI√ÅVEIS
        // ============================================
        window.VEICULOS_CONFIG = {
            supabaseUrl: 'https://lrfhudpojewxwknqekdg.supabase.co',
            supabaseKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxyZmh1ZHBvamV3eHdrbnFla2RnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyOTEyNTMsImV4cCI6MjA4MDg2NzI1M30.JmfyUpUO2-qhMsZv17j6YACLfACYG3PneLoLqwtGR4s',
            tableName: 'veiculos'
        };
        
        // Vari√°veis globais
        let supabaseClient = null;
        let veiculosLista = [];
        
        // ============================================
        // FUN√á√ïES B√ÅSICAS
        // ============================================
        function fecharJanela() {
            window.close();
        }
        
        function mostrarNotificacao(mensagem, tipo = 'info') {
            // Remover notifica√ß√µes antigas
            const notificacoesAntigas = document.querySelectorAll('.notification');
            notificacoesAntigas.forEach(n => n.remove());
            
            const notification = document.createElement('div');
            notification.className = `notification ${tipo}`;
            notification.textContent = mensagem;
            notification.style.zIndex = '9999';
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        // ============================================
        // FUN√á√ïES DE FORMATA√á√ÉO
        // ============================================
        function formatarPlaca(input) {
            if (!input || !input.value) return false;
            
            let placa = input.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
            
            if (placa.length > 7) placa = placa.substring(0, 7);
            
            if (placa.length > 4) {
                if (/[A-Z]{3}[0-9][A-Z][0-9]{2}/.test(placa)) {
                    placa = placa.replace(/^([A-Z]{3})([0-9])([A-Z])([0-9]{2})$/, '$1$2$3$4');
                } else {
                    placa = placa.replace(/^([A-Z]{3})([0-9]{1,4})/, '$1-$2');
                }
            }
            
            input.value = placa;
            
            const placaRegex = /^[A-Z]{3}-[0-9]{4}$|^[A-Z]{3}[0-9][A-Z][0-9]{2}$/;
            if (placa && !placaRegex.test(placa)) {
                mostrarErro(input, 'placaError', 'Formato inv√°lido. Use: ABC-1234 ou ABC1D23');
                return false;
            } else {
                removerErro(input, 'placaError');
                return true;
            }
        }
        
        function capitalizarPrimeiraLetra(input) {
            if (input && input.value && input.value.trim()) {
                input.value = input.value.charAt(0).toUpperCase() + input.value.slice(1).toLowerCase();
            }
        }
        
        function mostrarErro(input, errorId, mensagem) {
            if (input) input.classList.add('input-error');
            const errorElement = document.getElementById(errorId);
            if (errorElement) {
                errorElement.textContent = mensagem;
                errorElement.style.display = 'block';
            }
        }
        
        function removerErro(input, errorId) {
            if (input) input.classList.remove('input-error');
            const errorElement = document.getElementById(errorId);
            if (errorElement) errorElement.style.display = 'none';
        }
        
        function validarCampo(input, errorId, mensagem) {
            if (!input || !input.value || !input.value.trim()) {
                mostrarErro(input, errorId, mensagem);
                return false;
            } else {
                removerErro(input, errorId);
                return true;
            }
        }
        
        function validarFormulario() {
            let valido = true;
            
            const placaInput = document.getElementById('placa');
            const modeloInput = document.getElementById('modelo');
            const marcaInput = document.getElementById('marca');
            const anoInput = document.getElementById('ano');
            const kmInput = document.getElementById('km_atual');
            const statusInput = document.getElementById('status');
            
            // Placa
            valido = formatarPlaca(placaInput) && valido;
            valido = validarCampo(placaInput, 'placaError', 'Placa √© obrigat√≥ria') && valido;
            
            // Modelo
            valido = validarCampo(modeloInput, 'modeloError', 'Modelo √© obrigat√≥rio') && valido;
            
            // Marca
            valido = validarCampo(marcaInput, 'marcaError', 'Marca √© obrigat√≥ria') && valido;
            
            // Ano
            if (anoInput && (!anoInput.value || anoInput.value < 1990 || anoInput.value > 2025)) {
                mostrarErro(anoInput, 'anoError', 'Ano deve estar entre 1990 e 2025');
                valido = false;
            } else {
                removerErro(anoInput, 'anoError');
            }
            
            // KM Atual
            valido = validarCampo(kmInput, 'kmError', 'KM atual √© obrigat√≥rio') && valido;
            
            // Status
            valido = validarCampo(statusInput, 'statusError', 'Status √© obrigat√≥rio') && valido;
            
            return valido;
        }
        
        function validarESalvar() {
            if (validarFormulario()) {
                salvarVeiculo();
            } else {
                mostrarNotificacao('‚ö†Ô∏è Corrija os erros no formul√°rio', 'error');
            }
        }
        
        // ============================================
        // FUN√á√ïES DO SUPABASE
        // ============================================
        async function inicializarSupabase() {
            try {
                console.log('üîå Inicializando Supabase...');
                
                if (!window.supabase) {
                    throw new Error('Biblioteca Supabase n√£o carregada');
                }
                
                // Criar cliente Supabase
                supabaseClient = window.supabase.createClient(
                    window.VEICULOS_CONFIG.supabaseUrl,
                    window.VEICULOS_CONFIG.supabaseKey
                );
                
                // Testar conex√£o
                const { data, error } = await supabaseClient
                    .from(window.VEICULOS_CONFIG.tableName)
                    .select('id')
                    .limit(1);
                
                if (error) {
                    console.warn('‚ö†Ô∏è Aviso na conex√£o:', error.message);
                    // Continuar mesmo com erro (pode ser tabela vazia)
                }
                
                console.log('‚úÖ Supabase inicializado');
                return true;
                
            } catch (error) {
                console.error('‚ùå Erro ao inicializar Supabase:', error);
                mostrarNotificacao('‚ùå Erro de conex√£o com o banco', 'error');
                return false;
            }
        }
        
        async function carregarVeiculos() {
            try {
                console.log('üì• Carregando ve√≠culos...');
                
                const { data, error } = await supabaseClient
                    .from(window.VEICULOS_CONFIG.tableName)
                    .select('*')
                    .order('placa');
                
                if (error) {
                    console.error('‚ùå Erro ao carregar:', error);
                    
                    if (error.code === '42501') {
                        mostrarNotificacao('‚ùå Permiss√£o negada. Verifique RLS.', 'error');
                    } else if (error.code === 'PGRST116') {
                        console.log('‚ÑπÔ∏è Tabela vazia ou n√£o existe');
                        veiculosLista = [];
                    } else {
                        mostrarNotificacao('‚ùå Erro ao carregar ve√≠culos', 'error');
                    }
                } else {
                    veiculosLista = data || [];
                    console.log(`‚úÖ ${veiculosLista.length} ve√≠culos carregados`);
                }
                
                atualizarEstatisticas();
                renderizarTabela();
                
            } catch (error) {
                console.error('‚ùå Erro completo:', error);
                mostrarNotificacao('‚ùå Erro ao carregar dados', 'error');
                
                document.getElementById('tabelaBody').innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #dc3545;">
                            <div style="font-size: 48px;">‚ùå</div>
                            <div>Erro ao carregar ve√≠culos</div>
                            <button onclick="carregarVeiculos()" class="btn" style="margin-top: 15px; background: #1e40af; color: white;">
                                üîÑ Tentar Novamente
                            </button>
                        </td>
                    </tr>
                `;
            }
        }
        
        // ============================================
        // FUN√á√ïES DE INTERFACE
        // ============================================
        function atualizarEstatisticas() {
            const total = veiculosLista.length;
            const ativos = veiculosLista.filter(v => v.status === 'ativo').length;
            const inativos = veiculosLista.filter(v => v.status === 'inativo').length;
            const manutencao = veiculosLista.filter(v => v.status === 'manutencao').length;
            
            let kmTotal = 0;
            veiculosLista.forEach(v => {
                kmTotal += parseFloat(v.km_atual) || 0;
            });
            
            document.getElementById('stats').innerHTML = `
                <div class="stat-card" onclick="filtrarPorStatus('')">
                    <div class="stat-numero">${total}</div>
                    <div class="stat-label">Total</div>
                </div>
                <div class="stat-card" onclick="filtrarPorStatus('ativo')">
                    <div class="stat-numero">${ativos}</div>
                    <div class="stat-label">Ativos</div>
                </div>
                <div class="stat-card" onclick="filtrarPorStatus('inativo')">
                    <div class="stat-numero">${inativos}</div>
                    <div class="stat-label">Inativos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-numero">${kmTotal.toLocaleString('pt-BR')}</div>
                    <div class="stat-label">KM Total</div>
                </div>
            `;
        }
        
        function filtrarPorStatus(status) {
            if (!status) {
                renderizarTabela();
                mostrarNotificacao('Mostrando todos os ve√≠culos', 'info');
                return;
            }
            
            const filtrados = veiculosLista.filter(v => v.status === status);
            renderizarTabela(filtrados);
            mostrarNotificacao(`Mostrando ve√≠culos ${status}`, 'info');
        }
        
        function renderizarTabela(dados = veiculosLista) {
            const tbody = document.getElementById('tabelaBody');
            
            if (!dados || dados.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #666;">
                            <div style="font-size: 48px;">üöó</div>
                            <div>Nenhum ve√≠culo cadastrado</div>
                            <button onclick="abrirModalNovo()" class="btn" style="margin-top: 15px; background: #059669; color: white;">
                                Ôºã Adicionar Primeiro Ve√≠culo
                            </button>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            
            dados.forEach(veiculo => {
                const status = veiculo.status || 'ativo';
                let badgeClass = '';
                let badgeText = '';
                let indicatorClass = '';
                
                switch(status) {
                    case 'ativo':
                        badgeClass = 'badge-success';
                        badgeText = 'ATIVO';
                        indicatorClass = 'status-active';
                        break;
                    case 'inativo':
                        badgeClass = 'badge-danger';
                        badgeText = 'INATIVO';
                        indicatorClass = 'status-inactive';
                        break;
                    case 'manutencao':
                        badgeClass = 'badge-warning';
                        badgeText = 'MANUTEN√á√ÉO';
                        indicatorClass = 'status-maintenance';
                        break;
                    default:
                        badgeClass = 'badge';
                        badgeText = status.toUpperCase();
                }
                
                let ultimaManutencao = 'Nunca';
                if (veiculo.ultima_manutencao) {
                    try {
                        ultimaManutencao = new Date(veiculo.ultima_manutencao).toLocaleDateString('pt-BR');
                    } catch(e) {
                        ultimaManutencao = 'Data inv√°lida';
                    }
                }
                
                // Escapar aspas para JavaScript
                const placaEscapada = (veiculo.placa || '').replace(/'/g, "\\'");
                const nomeEscapado = (veiculo.placa || '').replace(/'/g, "\\'");
                
                html += `
                    <tr>
                        <td><strong>${veiculo.placa || 'N/D'}</strong></td>
                        <td>${veiculo.modelo || 'N/D'}</td>
                        <td>${veiculo.ano || 'N/D'}</td>
                        <td>${veiculo.cor || 'N/D'}</td>
                        <td>
                            <span class="status-indicator ${indicatorClass}"></span>
                            <span class="badge ${badgeClass}">${badgeText}</span>
                        </td>
                        <td>${ultimaManutencao}</td>
                        <td>
                            <button onclick="editarVeiculo('${veiculo.id}')" class="btn btn-info" style="padding: 6px 12px; margin-right: 5px;">
                                ‚úèÔ∏è Editar
                            </button>
                            <button onclick="alterarStatusVeiculo('${veiculo.id}', '${placaEscapada}', '${veiculo.status}')" 
                                    class="btn ${veiculo.status === 'ativo' ? 'btn-warning' : 'btn-success'}" 
                                    style="padding: 6px 12px; margin-right: 5px;">
                                ${veiculo.status === 'ativo' ? '‚è∏Ô∏è Pausar' : '‚ñ∂Ô∏è Ativar'}
                            </button>
                            <button onclick="excluirVeiculo('${veiculo.id}', '${placaEscapada}')" 
                                    class="btn btn-danger" style="padding: 6px 12px;">
                                üóëÔ∏è Excluir
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        // ============================================
        // FUN√á√ïES DO MODAL
        // ============================================
        function abrirModalNovo() {
            document.getElementById('modalTitulo').textContent = 'üöó Novo Ve√≠culo';
            document.getElementById('veiculoId').value = '';
            
            // Limpar formul√°rio
            const form = document.getElementById('formVeiculo');
            if (form) form.reset();
            
            // Configurar valores padr√£o
            const anoInput = document.getElementById('ano');
            const kmInput = document.getElementById('km_atual');
            const statusInput = document.getElementById('status');
            
            if (anoInput) anoInput.value = new Date().getFullYear();
            if (kmInput) kmInput.value = '0';
            if (statusInput) statusInput.value = 'ativo';
            
            // Mostrar modal
            document.getElementById('modalVeiculo').style.display = 'flex';
            
            // Limpar erros
            document.querySelectorAll('.error-message').forEach(el => {
                if (el) el.style.display = 'none';
            });
            document.querySelectorAll('.input-error').forEach(el => {
                if (el) el.classList.remove('input-error');
            });
        }
        
        async function editarVeiculo(id) {
            try {
                console.log('‚úèÔ∏è Editando ve√≠culo:', id);
                
                const { data, error } = await supabaseClient
                    .from(window.VEICULOS_CONFIG.tableName)
                    .select('*')
                    .eq('id', id)
                    .single();
                
                if (error) throw error;
                
                document.getElementById('modalTitulo').textContent = '‚úèÔ∏è Editar Ve√≠culo';
                document.getElementById('veiculoId').value = data.id;
                document.getElementById('placa').value = data.placa || '';
                document.getElementById('modelo').value = data.modelo || '';
                document.getElementById('marca').value = data.marca || '';
                document.getElementById('ano').value = data.ano || '';
                document.getElementById('cor').value = data.cor || '';
                document.getElementById('km_atual').value = data.km_atual || 0;
                document.getElementById('tipo_combustivel').value = data.tipo_combustivel || '';
                document.getElementById('status').value = data.status || 'ativo';
                document.getElementById('observacoes').value = data.observacoes || '';
                
                document.getElementById('modalVeiculo').style.display = 'flex';
                
                // Limpar erros
                document.querySelectorAll('.error-message').forEach(el => {
                    if (el) el.style.display = 'none';
                });
                document.querySelectorAll('.input-error').forEach(el => {
                    if (el) el.classList.remove('input-error');
                });
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar ve√≠culo:', error);
                mostrarNotificacao('‚ùå Erro ao carregar dados', 'error');
            }
        }
        
        function fecharModal() {
            document.getElementById('modalVeiculo').style.display = 'none';
        }
        
        // ============================================
        // FUN√á√ïES CRUD
        // ============================================
        async function salvarVeiculo() {
            try {
                const id = document.getElementById('veiculoId').value;
                const placa = document.getElementById('placa').value.trim();
                const modelo = document.getElementById('modelo').value.trim();
                const marca = document.getElementById('marca').value.trim();
                const ano = document.getElementById('ano').value;
                const cor = document.getElementById('cor').value.trim();
                const km_atual = document.getElementById('km_atual').value;
                const tipo_combustivel = document.getElementById('tipo_combustivel').value;
                const status = document.getElementById('status').value;
                const observacoes = document.getElementById('observacoes').value.trim();
                
                // Valida√ß√£o b√°sica
                if (!placa || !modelo || !marca || !ano || !km_atual || !status) {
                    mostrarNotificacao('‚ö†Ô∏è Preencha todos os campos obrigat√≥rios', 'error');
                    return;
                }
                
                const dados = {
                    placa: placa.toUpperCase(),
                    modelo: modelo,
                    marca: marca,
                    ano: parseInt(ano) || null,
                    cor: cor || null,
                    km_atual: parseFloat(km_atual) || 0,
                    tipo_combustivel: tipo_combustivel || null,
                    status: status,
                    observacoes: observacoes || null,
                    data_atualizacao: new Date().toISOString()
                };
                
                console.log('üíæ Salvando ve√≠culo:', dados);
                
                let resultado;
                
                if (id) {
                    // Atualizar
                    resultado = await supabaseClient
                        .from(window.VEICULOS_CONFIG.tableName)
                        .update(dados)
                        .eq('id', id);
                } else {
                    // Inserir novo
                    dados.data_criacao = new Date().toISOString();
                    dados.nome = modelo;
                    dados.tipo_veiculo = 'Autom√≥vel';
                    
                    resultado = await supabaseClient
                        .from(window.VEICULOS_CONFIG.tableName)
                        .insert([dados]);
                }
                
                if (resultado.error) {
                    console.error('‚ùå Erro Supabase:', resultado.error);
                    
                    if (resultado.error.message.includes('duplicate')) {
                        mostrarNotificacao('‚ùå Placa j√° cadastrada', 'error');
                    } else if (resultado.error.message.includes('permission')) {
                        mostrarNotificacao('‚ùå Permiss√£o negada. Verifique RLS.', 'error');
                    } else {
                        mostrarNotificacao(`‚ùå Erro: ${resultado.error.message}`, 'error');
                    }
                    return;
                }
                
                mostrarNotificacao(`‚úÖ Ve√≠culo ${id ? 'atualizado' : 'cadastrado'}!`, 'success');
                
                fecharModal();
                await carregarVeiculos();
                
            } catch (error) {
                console.error('‚ùå Erro ao salvar:', error);
                mostrarNotificacao('‚ùå Erro ao salvar ve√≠culo', 'error');
            }
        }
        
        async function alterarStatusVeiculo(id, placa, statusAtual) {
            try {
                console.log('üîÑ Alterando status:', { id, placa, statusAtual });
                
                statusAtual = (statusAtual || 'ativo').toLowerCase();
                
                let novoStatus;
                let acao;
                
                if (statusAtual === 'ativo') {
                    novoStatus = 'inativo';
                    acao = 'pausar';
                } else {
                    novoStatus = 'ativo';
                    acao = 'ativar';
                }
                
                if (!confirm(`Deseja ${acao} o ve√≠culo ${placa}?`)) {
                    return;
                }
                
                const dados = {
                    status: novoStatus,
                    data_atualizacao: new Date().toISOString()
                };
                
                console.log('üì§ Enviando:', dados);
                
                const { error } = await supabaseClient
                    .from(window.VEICULOS_CONFIG.tableName)
                    .update(dados)
                    .eq('id', id);
                
                if (error) {
                    console.error('‚ùå Erro:', error);
                    
                    if (error.code === '42501') {
                        mostrarNotificacao('‚ùå Permiss√£o negada. Verifique RLS.', 'error');
                    } else {
                        mostrarNotificacao(`‚ùå Erro: ${error.message}`, 'error');
                    }
                    return;
                }
                
                console.log('‚úÖ Status alterado');
                mostrarNotificacao(`‚úÖ Ve√≠culo ${acao}do!`, 'success');
                
                // Atualizar lista
                setTimeout(async () => {
                    await carregarVeiculos();
                }, 300);
                
            } catch (error) {
                console.error('‚ùå Erro completo:', error);
                mostrarNotificacao('‚ùå Erro ao alterar status', 'error');
            }
        }
        
        async function excluirVeiculo(id, placa) {
            try {
                if (!confirm(`üö® Excluir permanentemente o ve√≠culo ${placa}?\n\nEsta a√ß√£o N√ÉO pode ser desfeita!`)) {
                    return;
                }
                
                const { error } = await supabaseClient
                    .from(window.VEICULOS_CONFIG.tableName)
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                mostrarNotificacao('‚úÖ Ve√≠culo exclu√≠do!', 'success');
                await carregarVeiculos();
                
            } catch (error) {
                console.error('‚ùå Erro ao excluir:', error);
                mostrarNotificacao('‚ùå Erro ao excluir ve√≠culo', 'error');
            }
        }
        
        // ============================================
        // INICIALIZA√á√ÉO
        // ============================================
        async function inicializarSistema() {
            console.log('üöÄ Inicializando sistema de ve√≠culos...');
            
            // Testar se Supabase est√° carregado
            if (!window.supabase) {
                console.error('‚ùå Biblioteca Supabase n√£o carregada');
                mostrarNotificacao('‚ùå Erro: Biblioteca n√£o carregada', 'error');
                return;
            }
            
            // Inicializar Supabase
            const conexaoOK = await inicializarSupabase();
            
            if (conexaoOK) {
                // Carregar dados
                await carregarVeiculos();
                mostrarNotificacao('‚úÖ Sistema carregado!', 'success');
            }
        }
        
        // Inicializar quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìÑ DOM carregado');
            
            // Pequeno delay para garantir que tudo esteja carregado
            setTimeout(() => {
                inicializarSistema();
            }, 100);
        });
        
        // Tamb√©m chamar diretamente para garantir
        window.addEventListener('load', function() {
            console.log('üîÑ P√°gina totalmente carregada');
        });
        
        // Expor fun√ß√µes globalmente para debugging
        window.debugVeiculos = {
            config: window.VEICULOS_CONFIG,
            client: () => supabaseClient,
            lista: () => veiculosLista,
            recarregar: carregarVeiculos,
            testarConexao: async () => {
                try {
                    const { data, error } = await supabaseClient
                        .from('veiculos')
                        .select('count(*)', { count: 'exact', head: true });
                    return { data, error };
                } catch (e) {
                    return { error: e };
                }
            }
        };
        
    </script>
</body>
</html>