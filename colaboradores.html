<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üë• Gerenciamento de Colaboradores</title>
    
    <!-- SUPABASE -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: #2b6cb0;
            color: white;
            padding: 25px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 28px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            padding: 20px 30px;
            background: #f8f9fa;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }
        
        .stat-numero {
            font-size: 32px;
            font-weight: bold;
            color: #2b6cb0;
        }
        
        .stat-label {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }
        
        .content {
            padding: 30px;
        }
        
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #2b6cb0;
            color: white;
        }
        
        .btn-primary:hover {
            background: #1d4f91;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-warning:hover {
            background: #e0a800;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        
        .btn-info:hover {
            background: #138496;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th {
            background: #2b6cb0;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }
        
        .badge-danger {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .modal-header {
            padding: 20px 30px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
        }
        
        .modal-header h2 {
            margin: 0;
            color: #2b6cb0;
        }
        
        .modal-body {
            padding: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #2b6cb0;
            box-shadow: 0 0 0 3px rgba(43, 108, 176, 0.1);
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1001;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .notification.success {
            background: #28a745;
        }
        
        .notification.error {
            background: #dc3545;
        }
        
        .notification.info {
            background: #17a2b8;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #2b6cb0;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .btn-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        .error-message {
            color: #dc3545;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }
        
        .input-error {
            border-color: #dc3545 !important;
            background-color: #fff8f8;
        }
        
        .outros-input {
            margin-top: 10px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <h1>üë• Gerenciamento de Colaboradores</h1>
            <button onclick="window.close()" class="btn btn-warning">‚úï Fechar</button>
        </div>
        
        <!-- ESTAT√çSTICAS -->
        <div class="stats-grid" id="stats">
            <div class="stat-card">
                <div class="spinner"></div>
                <div class="stat-label">Carregando...</div>
            </div>
        </div>
        
        <!-- CONTE√öDO PRINCIPAL -->
        <div class="content">
            <!-- TOOLBAR -->
            <div class="toolbar">
                <h2>Lista de Colaboradores</h2>
                <button onclick="abrirModalNovo()" class="btn btn-success">Ôºã Novo Colaborador</button>
            </div>
            
            <!-- TABELA -->
            <div id="tabelaContainer">
                <table>
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Fun√ß√£o</th>
                            <th>Setor</th>
                            <th>Status</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaBody">
                        <tr>
                            <td colspan="5" class="loading">
                                <div class="spinner"></div>
                                <div>Carregando colaboradores...</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- MODAL NOVO/EDITAR COLABORADOR -->
    <div class="modal" id="modalColaborador">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitulo">‚ûï Novo Colaborador</h2>
                <button onclick="fecharModal()" class="btn-close">√ó</button>
            </div>
            <div class="modal-body">
                <form id="formColaborador">
                    <input type="hidden" id="colaboradorId">
                    
                    <div class="form-group">
                        <label for="nome">Nome Completo *</label>
                        <input type="text" id="nome" required onblur="formatarNomeCompleto(this)">
                        <div class="error-message" id="nomeError">Nome completo √© obrigat√≥rio</div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="cpf">CPF *</label>
                            <input type="text" id="cpf" placeholder="000.000.000-00" maxlength="14" oninput="formatarCPF(this)">
                            <div class="error-message" id="cpfError">CPF no formato 000.000.000-00</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="telefone">Telefone *</label>
                            <input type="text" id="telefone" placeholder="(11) 99999-9999" maxlength="15" oninput="formatarTelefone(this)">
                            <div class="error-message" id="telefoneError">Telefone no formato (DD) 99999-9999</div>
                        </div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="funcao">Fun√ß√£o *</label>
                            <select id="funcao" required onchange="mostrarOutrosFuncao(this)">
                                <option value="">Selecione uma fun√ß√£o</option>
                                <option value="Administrativo">Administrativo</option>
                                <option value="Encarregado">Encarregado</option>
                                <option value="Engenheiro">Engenheiro</option>
                                <option value="Gerente">Gerente</option>
                                <option value="Supervisor">Supervisor</option>
                                <option value="T√©cnico de Infraestrutura">T√©cnico de Infraestrutura</option>
                                <option value="T√©cnico de Instala√ß√£o">T√©cnico de Instala√ß√£o</option>
                                <option value="Outros">Outros</option>
                            </select>
                            <div class="error-message" id="funcaoError">Fun√ß√£o √© obrigat√≥ria</div>
                            <input type="text" id="outrosFuncao" class="outros-input" placeholder="Especifique a fun√ß√£o" onblur="capitalizarPrimeiraLetra(this)">
                        </div>
                        
                        <div class="form-group">
                            <label for="setor">Setor *</label>
                            <select id="setor" required onchange="mostrarOutrosSetor(this)">
                                <option value="">Selecione um setor</option>
                                <option value="DADOS">DADOS</option>
                                <option value="Engenharia">Engenharia</option>
                                <option value="Ger√™ncia">Ger√™ncia</option>
                                <option value="INFRA">INFRA</option>
                                <option value="NOC">NOC</option>
                                <option value="Recursos Humanos">Recursos Humanos</option>
                                <option value="SAC">SAC</option>
                                <option value="SOC">SOC</option>
                                <option value="Outros">Outros</option>
                            </select>
                            <div class="error-message" id="setorError">Setor √© obrigat√≥rio</div>
                            <input type="text" id="outrosSetor" class="outros-input" placeholder="Especifique o setor" onblur="capitalizarPrimeiraLetra(this)">
                        </div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="email">Email *</label>
                            <input type="email" id="email" onblur="validarEmail(this)">
                            <div class="error-message" id="emailError">Email inv√°lido</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="dataAdmissao">Data Admiss√£o *</label>
                            <input type="date" id="dataAdmissao" max="" onchange="validarDataAdmissao(this)">
                            <div class="error-message" id="dataAdmissaoError">Data n√£o pode ser futura</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="status">Status *</label>
                        <select id="status" required>
                            <option value="ativo" selected>Ativo</option>
                            <option value="inativo">Inativo</option>
                        </select>
                        <div class="error-message" id="statusError">Status √© obrigat√≥rio</div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 30px;">
                        <button type="button" onclick="fecharModal()" class="btn" style="flex: 1; background: #6c757d; color: white;">
                            Cancelar
                        </button>
                        <button type="button" onclick="validarESalvar()" class="btn btn-success" style="flex: 1;">
                            ‚úÖ Salvar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURA√á√ÉO SUPABASE
        const SUPABASE_CONFIG = {
            url: 'https://lrfhudpojewxwknqekdg.supabase.co',
            anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxyZmh1ZHBvamV3eHdrbnFla2RnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyOTEyNTMsImV4cCI6MjA4MDg2NzI1M30.JmfyUpUO2-qhMsZv17j6YACLfACYG3PneLoLqwtGR4s'
        };
        
        // VARI√ÅVEIS GLOBAIS
        let colaboradores = [];
        
        // FUN√á√ïES DE FORMATA√á√ÉO E VALIDA√á√ÉO
        function formatarNomeCompleto(input) {
            if (!input.value.trim()) return;
            
            const palavrasIgnoradas = ['de', 'da', 'do', 'dos', 'das', 'e'];
            let palavras = input.value.toLowerCase().split(' ');
            
            palavras = palavras.map((palavra, index) => {
                if (index === 0 || !palavrasIgnoradas.includes(palavra)) {
                    return palavra.charAt(0).toUpperCase() + palavra.slice(1);
                }
                return palavra;
            });
            
            input.value = palavras.join(' ');
        }
        
        function formatarCPF(input) {
            let cpf = input.value.replace(/\D/g, '');
            
            if (cpf.length > 11) cpf = cpf.substring(0, 11);
            
            if (cpf.length > 9) {
                cpf = cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
            } else if (cpf.length > 6) {
                cpf = cpf.replace(/(\d{3})(\d{3})(\d{1,3})/, '$1.$2.$3');
            } else if (cpf.length > 3) {
                cpf = cpf.replace(/(\d{3})(\d{1,3})/, '$1.$2');
            }
            
            input.value = cpf;
            
            // Validar formato
            const cpfRegex = /^\d{3}\.\d{3}\.\d{3}-\d{2}$/;
            if (cpf && !cpfRegex.test(cpf)) {
                mostrarErro(input, 'cpfError', 'CPF no formato 000.000.000-00');
            } else {
                removerErro(input, 'cpfError');
            }
        }
        
        function formatarTelefone(input) {
            let telefone = input.value.replace(/\D/g, '');
            
            if (telefone.length > 11) telefone = telefone.substring(0, 11);
            
            if (telefone.length > 10) {
                telefone = telefone.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
            } else if (telefone.length > 6) {
                telefone = telefone.replace(/(\d{2})(\d{4})(\d{0,4})/, '($1) $2-$3');
            } else if (telefone.length > 2) {
                telefone = telefone.replace(/(\d{2})(\d{0,5})/, '($1) $2');
            } else if (telefone.length > 0) {
                telefone = telefone.replace(/(\d{0,2})/, '($1');
            }
            
            input.value = telefone;
            
            // Validar formato
            const telefoneRegex = /^\(\d{2}\) \d{4,5}-\d{4}$/;
            if (telefone && !telefoneRegex.test(telefone)) {
                mostrarErro(input, 'telefoneError', 'Telefone no formato (DD) 99999-9999');
            } else {
                removerErro(input, 'telefoneError');
            }
        }
        
        function mostrarOutrosFuncao(select) {
            const outrosInput = document.getElementById('outrosFuncao');
            outrosInput.style.display = select.value === 'Outros' ? 'block' : 'none';
            outrosInput.required = select.value === 'Outros';
            
            if (select.value !== 'Outros') {
                outrosInput.value = '';
                removerErro(outrosInput, 'funcaoError');
            }
        }
        
        function mostrarOutrosSetor(select) {
            const outrosInput = document.getElementById('outrosSetor');
            outrosInput.style.display = select.value === 'Outros' ? 'block' : 'none';
            outrosInput.required = select.value === 'Outros';
            
            if (select.value !== 'Outros') {
                outrosInput.value = '';
                removerErro(outrosInput, 'setorError');
            }
        }
        
        function capitalizarPrimeiraLetra(input) {
            if (input.value.trim()) {
                input.value = input.value.charAt(0).toUpperCase() + input.value.slice(1).toLowerCase();
            }
        }
        
        function validarEmail(input) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (input.value && !emailRegex.test(input.value)) {
                mostrarErro(input, 'emailError', 'Email inv√°lido');
                return false;
            } else {
                removerErro(input, 'emailError');
                return true;
            }
        }
        
        function validarDataAdmissao(input) {
            const hoje = new Date().toISOString().split('T')[0];
            if (input.value > hoje) {
                mostrarErro(input, 'dataAdmissaoError', 'Data n√£o pode ser futura');
                return false;
            } else {
                removerErro(input, 'dataAdmissaoError');
                return true;
            }
        }
        
        function mostrarErro(input, errorId, mensagem) {
            input.classList.add('input-error');
            const errorElement = document.getElementById(errorId);
            errorElement.textContent = mensagem;
            errorElement.style.display = 'block';
        }
        
        function removerErro(input, errorId) {
            input.classList.remove('input-error');
            document.getElementById(errorId).style.display = 'none';
        }
        
        function validarCampo(input, errorId, mensagem) {
            if (!input.value.trim()) {
                mostrarErro(input, errorId, mensagem);
                return false;
            } else {
                removerErro(input, errorId);
                return true;
            }
        }
        
        function validarFormulario() {
            let valido = true;
            
            // Nome
            valido = validarCampo(document.getElementById('nome'), 'nomeError', 'Nome completo √© obrigat√≥rio') && valido;
            
            // CPF
            const cpf = document.getElementById('cpf');
            const cpfRegex = /^\d{3}\.\d{3}\.\d{3}-\d{2}$/;
            if (!cpf.value || !cpfRegex.test(cpf.value)) {
                mostrarErro(cpf, 'cpfError', 'CPF no formato 000.000.000-00');
                valido = false;
            } else {
                removerErro(cpf, 'cpfError');
            }
            
            // Telefone
            const telefone = document.getElementById('telefone');
            const telefoneRegex = /^\(\d{2}\) \d{4,5}-\d{4}$/;
            if (!telefone.value || !telefoneRegex.test(telefone.value)) {
                mostrarErro(telefone, 'telefoneError', 'Telefone no formato (DD) 99999-9999');
                valido = false;
            } else {
                removerErro(telefone, 'telefoneError');
            }
            
            // Fun√ß√£o
            const funcaoSelect = document.getElementById('funcao');
            const outrosFuncao = document.getElementById('outrosFuncao');
            if (!funcaoSelect.value) {
                mostrarErro(funcaoSelect, 'funcaoError', 'Fun√ß√£o √© obrigat√≥ria');
                valido = false;
            } else if (funcaoSelect.value === 'Outros' && !outrosFuncao.value.trim()) {
                mostrarErro(outrosFuncao, 'funcaoError', 'Especifique a fun√ß√£o');
                valido = false;
            } else {
                removerErro(funcaoSelect, 'funcaoError');
                removerErro(outrosFuncao, 'funcaoError');
            }
            
            // Setor
            const setorSelect = document.getElementById('setor');
            const outrosSetor = document.getElementById('outrosSetor');
            if (!setorSelect.value) {
                mostrarErro(setorSelect, 'setorError', 'Setor √© obrigat√≥rio');
                valido = false;
            } else if (setorSelect.value === 'Outros' && !outrosSetor.value.trim()) {
                mostrarErro(outrosSetor, 'setorError', 'Especifique o setor');
                valido = false;
            } else {
                removerErro(setorSelect, 'setorError');
                removerErro(outrosSetor, 'setorError');
            }
            
            // Email
            valido = validarEmail(document.getElementById('email')) && valido;
            if (!document.getElementById('email').value) {
                mostrarErro(document.getElementById('email'), 'emailError', 'Email √© obrigat√≥rio');
                valido = false;
            }
            
            // Data Admiss√£o
            const dataAdmissao = document.getElementById('dataAdmissao');
            if (!dataAdmissao.value) {
                mostrarErro(dataAdmissao, 'dataAdmissaoError', 'Data de admiss√£o √© obrigat√≥ria');
                valido = false;
            } else {
                valido = validarDataAdmissao(dataAdmissao) && valido;
            }
            
            // Status
            valido = validarCampo(document.getElementById('status'), 'statusError', 'Status √© obrigat√≥rio') && valido;
            
            return valido;
        }
        
        function validarESalvar() {
            if (validarFormulario()) {
                salvarColaborador();
            } else {
                mostrarNotificacao('‚ö†Ô∏è Corrija os erros no formul√°rio', 'error');
            }
        }
        
        // INICIALIZAR SUPABASE
        async function inicializarSupabase() {
            try {
                console.log('üîå Conectando ao Supabase...');
                
                // Verificar se a biblioteca Supabase foi carregada
                if (typeof supabase === 'undefined') {
                    console.error('‚ùå Biblioteca Supabase n√£o foi carregada');
                    mostrarNotificacao('‚ùå Biblioteca Supabase n√£o carregada', 'error');
                    return false;
                }
                
                // Criar cliente Supabase uma √∫nica vez
                if (!window.supabaseClient) {
                    window.supabaseClient = supabase.createClient(
                        SUPABASE_CONFIG.url,
                        SUPABASE_CONFIG.anonKey
                    );
                }
                
                // Testar conex√£o
                const { data, error } = await window.supabaseClient
                    .from('colaboradores')
                    .select('id')
                    .limit(1);
                
                if (error) {
                    console.error('‚ùå Erro na conex√£o:', error);
                    throw error;
                }
                
                console.log('‚úÖ Supabase conectado!');
                return true;
                
            } catch (error) {
                console.error('‚ùå Falha ao conectar:', error);
                mostrarNotificacao('‚ùå Erro de conex√£o com o banco', 'error');
                return false;
            }
        }
        
        // NOTIFICA√á√ïES
        function mostrarNotificacao(mensagem, tipo = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${tipo}`;
            notification.textContent = mensagem;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        // CARREGAR COLABORADORES
        async function carregarColaboradores() {
            try {
                console.log('üì• Carregando colaboradores...');
                
                const { data, error } = await window.supabaseClient
                    .from('colaboradores')
                    .select('*')
                    .order('nome_completo');
                
                if (error) throw error;
                
                colaboradores = data || [];
                console.log(`‚úÖ ${colaboradores.length} colaboradores carregados`);
                
                atualizarEstatisticas();
                renderizarTabela();
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar colaboradores:', error);
                mostrarNotificacao('‚ùå Erro ao carregar colaboradores', 'error');
                
                document.getElementById('tabelaBody').innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px; color: #dc3545;">
                            <div style="font-size: 48px;">‚ùå</div>
                            <div>Erro ao carregar dados</div>
                            <button onclick="carregarColaboradores()" class="btn" style="margin-top: 15px; background: #2b6cb0; color: white;">
                                üîÑ Tentar Novamente
                            </button>
                        </td>
                    </tr>
                `;
            }
        }
        
        // ATUALIZAR ESTAT√çSTICAS
        function atualizarEstatisticas() {
            const total = colaboradores.length;
            const ativos = colaboradores.filter(c => c.status === 'ativo').length;
            const inativos = colaboradores.filter(c => c.status === 'inativo').length;
            
            document.getElementById('stats').innerHTML = `
                <div class="stat-card">
                    <div class="stat-numero">${total}</div>
                    <div class="stat-label">Total</div>
                </div>
                <div class="stat-card">
                    <div class="stat-numero">${ativos}</div>
                    <div class="stat-label">Ativos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-numero">${inativos}</div>
                    <div class="stat-label">Inativos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-numero">${colaboradores.filter(c => c.funcao === 'Motorista').length}</div>
                    <div class="stat-label">Motoristas</div>
                </div>
            `;
        }
        
        // RENDERIZAR TABELA
        function renderizarTabela() {
            const tbody = document.getElementById('tabelaBody');
            
            if (colaboradores.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px; color: #666;">
                            <div style="font-size: 48px;">üë•</div>
                            <div>Nenhum colaborador cadastrado</div>
                            <button onclick="abrirModalNovo()" class="btn" style="margin-top: 15px; background: #28a745; color: white;">
                                Ôºã Adicionar Primeiro
                            </button>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            
            colaboradores.forEach(colab => {
                const statusBadge = colab.status === 'ativo' 
                    ? '<span class="badge badge-success">ATIVO</span>'
                    : '<span class="badge badge-danger">INATIVO</span>';
                
                html += `
                    <tr>
                        <td><strong>${colab.nome_completo || 'N/D'}</strong></td>
                        <td>${colab.funcao || 'N/D'}</td>
                        <td>${colab.setor || 'N/D'}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <button onclick="editarColaborador('${colab.id}')" class="btn btn-info" style="padding: 6px 12px; margin-right: 5px;">
                                ‚úèÔ∏è Editar
                            </button>
                            <button onclick="alterarStatus('${colab.id}', '${colab.nome_completo}', '${colab.status}')" 
                                    class="btn ${colab.status === 'ativo' ? 'btn-warning' : 'btn-success'}" 
                                    style="padding: 6px 12px; margin-right: 5px;">
                                ${colab.status === 'ativo' ? '‚è∏Ô∏è Desativar' : '‚ñ∂Ô∏è Ativar'}
                            </button>
                            <button onclick="excluirColaborador('${colab.id}', '${colab.nome_completo}')" 
                                    class="btn btn-danger" style="padding: 6px 12px;">
                                üóëÔ∏è Excluir
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        // MODAL FUNCTIONS
        function abrirModalNovo() {
            document.getElementById('modalTitulo').textContent = '‚ûï Novo Colaborador';
            document.getElementById('colaboradorId').value = '';
            document.getElementById('formColaborador').reset();
            
            // Limpar campos de "Outros"
            document.getElementById('outrosFuncao').style.display = 'none';
            document.getElementById('outrosSetor').style.display = 'none';
            
            // Configurar data m√°xima
            const hoje = new Date().toISOString().split('T')[0];
            document.getElementById('dataAdmissao').max = hoje;
            
            document.getElementById('status').value = 'ativo';
            document.getElementById('modalColaborador').style.display = 'flex';
            
            // Limpar erros
            document.querySelectorAll('.error-message').forEach(el => {
                el.style.display = 'none';
            });
            document.querySelectorAll('.input-error').forEach(el => {
                el.classList.remove('input-error');
            });
        }
        
        async function editarColaborador(id) {
            try {
                console.log('‚úèÔ∏è Editando colaborador:', id);
                
                const { data, error } = await window.supabaseClient
                    .from('colaboradores')
                    .select('*')
                    .eq('id', id)
                    .single();
                
                if (error) throw error;
                
                document.getElementById('modalTitulo').textContent = '‚úèÔ∏è Editar Colaborador';
                document.getElementById('colaboradorId').value = data.id;
                document.getElementById('nome').value = data.nome_completo || '';
                document.getElementById('cpf').value = data.cpf || '';
                document.getElementById('telefone').value = data.telefone || '';
                
                // Configurar fun√ß√£o
                if (['Administrativo', 'Encarregado', 'Engenheiro', 'Gerente', 'Supervisor', 'T√©cnico de Infraestrutura', 'T√©cnico de Instala√ß√£o'].includes(data.funcao)) {
                    document.getElementById('funcao').value = data.funcao;
                    document.getElementById('outrosFuncao').style.display = 'none';
                } else {
                    document.getElementById('funcao').value = 'Outros';
                    document.getElementById('outrosFuncao').value = data.funcao || '';
                    document.getElementById('outrosFuncao').style.display = 'block';
                }
                
                // Configurar setor
                if (['DADOS', 'Engenharia', 'Ger√™ncia', 'INFRA', 'NOC', 'Recursos Humanos', 'SAC', 'SOC'].includes(data.setor)) {
                    document.getElementById('setor').value = data.setor;
                    document.getElementById('outrosSetor').style.display = 'none';
                } else {
                    document.getElementById('setor').value = 'Outros';
                    document.getElementById('outrosSetor').value = data.setor || '';
                    document.getElementById('outrosSetor').style.display = 'block';
                }
                
                document.getElementById('email').value = data.email || '';
                document.getElementById('dataAdmissao').value = data.data_admissao || '';
                document.getElementById('status').value = data.status || 'ativo';
                
                // Configurar data m√°xima
                const hoje = new Date().toISOString().split('T')[0];
                document.getElementById('dataAdmissao').max = hoje;
                
                document.getElementById('modalColaborador').style.display = 'flex';
                
                // Limpar erros
                document.querySelectorAll('.error-message').forEach(el => {
                    el.style.display = 'none';
                });
                document.querySelectorAll('.input-error').forEach(el => {
                    el.classList.remove('input-error');
                });
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar colaborador:', error);
                mostrarNotificacao('‚ùå Erro ao carregar dados', 'error');
            }
        }
        
        function fecharModal() {
            document.getElementById('modalColaborador').style.display = 'none';
        }
        
        // ========== OPERA√á√ïES CRUD ==========
        async function salvarColaborador() {
            try {
                const id = document.getElementById('colaboradorId').value;
                const nome = document.getElementById('nome').value.trim();
                const cpf = document.getElementById('cpf').value.trim();
                const telefone = document.getElementById('telefone').value.trim();
                const email = document.getElementById('email').value.trim();
                const dataAdmissao = document.getElementById('dataAdmissao').value;
                const status = document.getElementById('status').value;
                
                // Obter fun√ß√£o
                let funcao = document.getElementById('funcao').value;
                if (funcao === 'Outros') {
                    funcao = document.getElementById('outrosFuncao').value.trim();
                }
                
                // Obter setor
                let setor = document.getElementById('setor').value;
                if (setor === 'Outros') {
                    setor = document.getElementById('outrosSetor').value.trim();
                }
                
                if (!nome || !funcao || !setor || !cpf || !telefone || !email || !dataAdmissao || !status) {
                    mostrarNotificacao('‚ö†Ô∏è Preencha todos os campos obrigat√≥rios', 'error');
                    return;
                }
                
                // Use os nomes CORRETOS das suas colunas
                const dados = {
                    nome_completo: nome,
                    funcao: funcao,
                    setor: setor,
                    status: status,
                    cpf: cpf || null,
                    telefone: telefone || null,
                    email: email || null,
                    data_admissao: dataAdmissao || null,
                    data_atualizacao: new Date().toISOString()
                };
                
                console.log('üíæ Salvando colaborador:', dados);
                
                let resultado;
                
                if (id) {
                    // ATUALIZAR
                    resultado = await window.supabaseClient
                        .from('colaboradores')
                        .update(dados)
                        .eq('id', id);
                } else {
                    // NOVO
                    dados.data_criacao = new Date().toISOString();
                    dados.created_by = 'sistema_colaboradores';
                    
                    resultado = await window.supabaseClient
                        .from('colaboradores')
                        .insert([dados]);
                }
                
                if (resultado.error) {
                    console.error('‚ùå Erro Supabase:', resultado.error);
                    
                    if (resultado.error.message.includes('permission denied')) {
                        mostrarNotificacao('‚ùå Permiss√£o negada. Configure RLS no Supabase.', 'error');
                    } else {
                        mostrarNotificacao('‚ùå Erro ao salvar: ' + resultado.error.message, 'error');
                    }
                    return;
                }
                
                mostrarNotificacao(`‚úÖ Colaborador ${id ? 'atualizado' : 'cadastrado'} com sucesso!`, 'success');
                
                fecharModal();
                await carregarColaboradores();
                
            } catch (error) {
                console.error('‚ùå Erro ao salvar colaborador:', error);
                mostrarNotificacao('‚ùå Erro ao salvar colaborador: ' + error.message, 'error');
            }
        }
        
        async function alterarStatus(id, nome, statusAtual) {
            try {
                const novoStatus = statusAtual === 'ativo' ? 'inativo' : 'ativo';
                const acao = statusAtual === 'ativo' ? 'desativar' : 'ativar';
                
                if (!confirm(`Tem certeza que deseja ${acao} o colaborador "${nome}"?`)) {
                    return;
                }
                
                console.log(`üîÑ Alterando status do colaborador ${id} para ${novoStatus}`);
                
                const { error } = await window.supabaseClient
                    .from('colaboradores')
                    .update({ 
                        status: novoStatus,
                        data_atualizacao: new Date().toISOString()
                    })
                    .eq('id', id);
                
                if (error) {
                    console.error('‚ùå Erro ao alterar status:', error);
                    
                    if (error.message.includes('permission denied')) {
                        mostrarNotificacao('‚ùå Permiss√£o negada. Configure RLS no Supabase.', 'error');
                    } else {
                        mostrarNotificacao('‚ùå Erro ao alterar status: ' + error.message, 'error');
                    }
                    return;
                }
                
                mostrarNotificacao(`‚úÖ Colaborador ${acao}do com sucesso!`, 'success');
                
                // Recarregar lista
                await carregarColaboradores();
                
            } catch (error) {
                console.error('‚ùå Erro ao alterar status:', error);
                mostrarNotificacao('‚ùå Erro ao alterar status do colaborador', 'error');
            }
        }
        
        // EXCLUIR COLABORADOR
        async function excluirColaborador(id, nome) {
            try {
                if (!confirm(`üö® ATEN√á√ÉO!\n\nDeseja EXCLUIR PERMANENTEMENTE o colaborador "${nome}"?\n\nEsta a√ß√£o n√£o pode ser desfeita!`)) {
                    return;
                }
                
                const { error } = await window.supabaseClient
                    .from('colaboradores')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                mostrarNotificacao('‚úÖ Colaborador exclu√≠do com sucesso!', 'success');
                await carregarColaboradores();
                
            } catch (error) {
                console.error('‚ùå Erro ao excluir colaborador:', error);
                
                if (error.message.includes('violates foreign key constraint')) {
                    mostrarNotificacao('‚ùå N√£o √© poss√≠vel excluir: colaborador tem registros associados', 'error');
                } else {
                    mostrarNotificacao('‚ùå Erro ao excluir colaborador', 'error');
                }
            }
        }
        
        // INICIALIZA√á√ÉO
        window.onload = async function() {
            console.log('üöÄ Iniciando sistema de colaboradores...');
            
            const conectado = await inicializarSupabase();
            
            if (conectado) {
                await carregarColaboradores();
                mostrarNotificacao('‚úÖ Sistema carregado com sucesso!', 'success');
            }
        };
    </script>
</body>
</html>
