<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Controle de Uso de Ve√≠culos</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2b6cb0">

  <!-- üî• BIBLIOTECA PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <!-- üî• SUPABASE - ADICIONADO defer PARA CARREGAR CORRETAMENTE -->
  <script src="https://unpkg.com/@supabase/supabase-js@2" defer></script>

  <!-- üî• CRIPTOGRAFIA PARA SENHAS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f3f6f9;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }
    .container {
      background: white;
      width: 95%;
      max-width: 650px;
      border-radius: 15px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      margin-top: 20px;
      padding: 20px;
    }
    h2 {
      text-align: center;
      color: #2b6cb0;
    }
    img.logo {
      display: block;
      margin: 0 auto 10px;
      max-width: 160px;
    }
    label {
      font-weight: bold;
      display: block;
      margin-top: 12px;
    }
    select, input, canvas {
      width: 100%;
      padding: 8px;
      margin-top: 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 15px;
      transition: all 0.3s;
    }
    select:focus, input:focus {
      outline: none;
      border-color: #2b6cb0;
      box-shadow: 0 0 0 2px rgba(43, 108, 176, 0.2);
    }
    button {
      margin-top: 15px;
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 8px;
      background-color: #2b6cb0;
      color: white;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #1d4f91;
    }
    .btn-secondary {
      background-color: #6c757d;
    }
    .btn-secondary:hover {
      background-color: #565e64;
    }
    .btn-clear {
      background-color: #e63946;
    }
    .btn-clear:hover {
      background-color: #b91d2e;
    }
    #signature-pad {
      border: 2px dashed #aaa;
      height: 150px;
      width: 100%;
      background-color: white;
      border-radius: 6px;
      box-sizing: border-box;
    }
    .loading-pdf {
      display: none;
      text-align: center;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 6px;
      margin: 10px 0;
    }
    #fotoPreview {
      max-width: 100%;
      margin-top: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      display: none;
    }
    .km-valido {
      border-color: #28a745 !important;
      background-color: #d4edda !important;
    }
    .km-alerta {
      border-color: #ffc107 !important;
      background-color: #fff3cd !important;
    }
    .km-invalido {
      border-color: #dc3545 !important;
      background-color: #f8d7da !important;
    }
    .status-conexao {
      position: fixed;
      bottom: 10px;
      right: 10px;
      background: #f8f9fa;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 11px;
      color: #666;
      border: 1px solid #dee2e6;
      z-index: 1000;
    }
    .error-message {
      color: #dc3545;
      font-size: 12px;
      margin-top: 3px;
      display: none;
    }
    
    /* üî• ESTILOS PARA BOT√ÉO DE INSTALA√á√ÉO */
    .install-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
      color: white !important;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      font-weight: bold;
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin: 10px auto;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
      transition: transform 0.3s, box-shadow 0.3s;
      width: 100%;
    }
    
    .install-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
    }
    
    .install-btn:active {
      transform: translateY(0);
    }
    
    .install-container {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); 
      border-radius: 10px; 
      padding: 15px; 
      border: 2px solid #2b6cb0;
      margin: 15px 0;
      text-align: center;
    }
    
    .install-tip {
      font-size: 11px; 
      color: #6c757d; 
      max-width: 300px; 
      margin: 5px auto 0;
    }
    
    @keyframes slideDown {
      from { top: -100px; opacity: 0; }
      to { top: 20px; opacity: 1; }
    }
    
    @keyframes slideUp {
      from { top: 20px; opacity: 1; }
      to { top: -100px; opacity: 0; }
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .notificacao-sincronizacao {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #28a745;
      color: white;
      padding: 15px 20px;
      border-radius: 8px;
      z-index: 10000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      animation: slideDown 0.5s ease-out;
      display: none;
    }
    
    .notificacao-offline {
      background: #ffc107;
      color: #333;
    }
    
    .notificacao-erro {
      background: #dc3545;
      color: white;
    }

    /* üî• ESTILOS PARA LOGIN E TROCA DE SENHA */
    .login-box, .troca-senha-box {
      background: white;
      padding: 25px;
      border-radius: 10px;
      border: 1px solid #dee2e6;
      margin-top: 20px;
    }
    
    .login-title {
      text-align: center;
      color: #2b6cb0;
      margin-bottom: 20px;
    }
    
    .login-error, .troca-error {
      color: #dc3545;
      background-color: #f8d7da;
      border: 1px solid #f5c6cb;
      padding: 10px;
      border-radius: 5px;
      margin-top: 10px;
      display: none;
    }
    
    .login-success, .troca-success {
      color: #155724;
      background-color: #d4edda;
      border: 1px solid #c3e6cb;
      padding: 10px;
      border-radius: 5px;
      margin-top: 10px;
      display: none;
    }
    
    .user-info-bar {
      background-color: #2b6cb0;
      color: white;
      padding: 12px 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .user-info-bar span {
      font-weight: bold;
    }
    
    .logout-btn-small {
      background-color: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
      padding: 5px 15px;
      border-radius: 5px;
      font-size: 14px;
      cursor: pointer;
    }
    
    .logout-btn-small:hover {
      background-color: rgba(255, 255, 255, 0.3);
    }
    
    .colaborador-info {
      background-color: #f8f9fa;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #dee2e6;
      margin-top: 6px;
      font-weight: normal;
    }
    
    .colaborador-info span {
      font-weight: bold;
      color: #2b6cb0;
    }
    
    .password-tips {
      margin: 20px 0;
      padding: 15px;
      background: #fff3cd;
      border-radius: 5px;
    }
    
    .password-tips p {
      margin: 0;
      color: #856404;
      font-size: 14px;
    }
    
    .first-login-alert {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 10px;
      margin: 20px 0;
      text-align: center;
      border: 2px solid #2b6cb0;
    }
    
    .first-login-alert p {
      color: #2b6cb0;
      font-weight: bold;
      margin: 0;
    }
  </style>
</head>

<body>
  <!-- üî• TELA DE LOGIN -->
  <div class="container" id="loginContainer">
    <img src="https://i.imgur.com/SEr4lkm.png" alt="Logo" class="logo" />
    <h2>Controle de Uso de Ve√≠culos</h2>
    
    <div class="login-box">
      <h3 class="login-title">Acesso do Colaborador</h3>
      
      <label for="loginUsername">Nome de Usu√°rio:</label>
      <input type="text" id="loginUsername" placeholder="Ex: joao.silva" required autofocus>
      <small style="color: #666; font-size: 12px; display: block; margin-top: 3px;">
        Formato: primeiro.segundo (ex: joao.silva)
      </small>
      
      <label for="loginPassword" style="margin-top: 15px;">Senha:</label>
      <input type="password" id="loginPassword" placeholder="Digite sua senha" required>
      
      <div class="login-error" id="loginError"></div>
      <div class="login-success" id="loginSuccess"></div>
      
      <div id="loadingLogin" style="display: none; text-align: center; padding: 15px;">
        <div style="width: 30px; height: 30px; border: 3px solid #f3f3f3; border-top: 3px solid #2b6cb0; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
        <p style="margin-top: 10px;">Autenticando...</p>
      </div>
      
      <button type="button" onclick="fazerLogin()">Entrar</button>
    </div>
    
    <p style="text-align: center; margin-top: 20px; font-size: 12px; color: #666;">
      Problemas para acessar? Entre em contato com o administrador.
    </p>
  </div>

  <!-- üî• TELA DE TROCA DE SENHA (Primeiro Acesso) -->
  <div class="container" id="trocaSenhaContainer" style="display: none;">
    <img src="https://i.imgur.com/SEr4lkm.png" alt="Logo" class="logo" />
    <h2>Altera√ß√£o de Senha Obrigat√≥ria</h2>
    
    <div class="first-login-alert">
      <p>üõ°Ô∏è Por seguran√ßa, voc√™ deve alterar sua senha no primeiro acesso.</p>
    </div>
    
    <div class="troca-senha-box">
      <div style="margin-bottom: 20px;">
        <label for="novaSenha">Nova Senha:</label>
        <input type="password" id="novaSenha" placeholder="Digite a nova senha" required>
      </div>
      
      <div style="margin-bottom: 20px;">
        <label for="confirmarSenha">Confirmar Nova Senha:</label>
        <input type="password" id="confirmarSenha" placeholder="Digite novamente" required>
      </div>
      
      <div class="troca-error" id="trocaError"></div>
      <div class="troca-success" id="trocaSuccess"></div>
      
      <div class="password-tips">
        <p><strong>Dicas para uma senha segura:</strong></p>
        <p>‚Ä¢ Use no m√≠nimo 6 caracteres<br>
           ‚Ä¢ Combine letras, n√∫meros e s√≠mbolos<br>
           ‚Ä¢ Evite sequ√™ncias simples como 123456<br>
           ‚Ä¢ N√£o use informa√ß√µes pessoais</p>
      </div>
      
      <button type="button" onclick="trocarSenha()">Alterar Senha e Continuar</button>
    </div>
  </div>

  <!-- üî• TELA PRINCIPAL (AP√ìS LOGIN) -->
  <div class="container" id="mainContainer" style="display: none;">
    <!-- CABE√áALHO COM INFO DO USU√ÅRIO -->
    <div class="user-info-bar">
      <div>
        <span id="userName"></span>
        <div style="font-size: 12px; opacity: 0.9;" id="userEmail"></div>
      </div>
      <button class="logout-btn-small" onclick="fazerLogout()">Sair</button>
    </div>
    
    <img src="https://i.imgur.com/SEr4lkm.png" alt="Logo" class="logo" />
    <h2>Controle de Uso de Ve√≠culos</h2>
    
    <!-- üî• BOT√ÉO INSTALAR APP -->
    <div id="installContainer" style="display: none;">
      <div class="install-container">
        <button id="installButton" class="install-btn">
          <span style="font-size: 24px;">üì±</span>
          <div style="text-align: left; flex-grow: 1;">
            <div style="font-weight: bold;">Instalar App</div>
            <div style="font-size: 12px; opacity: 0.8;">Acesso r√°pido e offline</div>
          </div>
          <span style="font-size: 20px;">‚Üì</span>
        </button>
      </div>
      <p class="install-tip">
        Instale para usar sem internet e com √≠cone na tela inicial
      </p>
    </div>

    <!-- üî• NOTIFICA√á√ïES -->
    <div id="notificacaoSincronizacao" class="notificacao-sincronizacao" style="display: none;"></div>

    <!-- SELE√á√ÉO DE ROTA -->
    <div id="step-selection">
      <label for="rotaTipo">Selecione o Tipo de Rota:</label>
      <select id="rotaTipo" required>
        <option value="">Selecione</option>
        <option value="inicio">In√≠cio de Rota</option>
        <option value="final">Final de Rota</option>
      </select>
      <button id="continuarBtn">Continuar</button>
    </div>

    <!-- FORMUL√ÅRIO -->
    <form id="formulario" style="display:none;">
      <label>Data:</label>
      <input type="text" id="dataAtual" readonly>

      <label>Hora:</label>
      <input type="text" id="horaAtual" readonly>

      <label>Colaborador:</label>
      <div class="colaborador-info" id="colaboradorInfo">
        <!-- Nome do colaborador logado ser√° inserido aqui -->
      </div>

      <label>Tipo de Ve√≠culo:</label>
      <select id="tipoVeiculo" onchange="carregarVeiculos()" required>
        <option value="">Selecione</option>
        <option value="carro">Carro</option>
        <option value="moto">Moto</option>
      </select>

      <label>Ve√≠culo:</label>
      <select id="veiculo" onchange="atualizarPlaca()" required>
        <option value="">Selecione o tipo de ve√≠culo</option>
      </select>

      <label>Placa:</label>
      <input type="text" id="placa" readonly>

      <label>Quilometragem:</label>
      <input type="number" id="km" required placeholder="Digite a quilometragem atual">
      <div class="error-message" id="kmError"></div>

      <label>Foto do Painel (KM):</label>
      <input type="file" id="fotoPainel" accept="image/*" capture="environment" required onchange="previewFoto(event)">
      <img id="fotoPreview" src="" alt="Preview da foto do painel">

      <label>Assinatura Digital:</label>
      <canvas id="signature-pad"></canvas>
      <button type="button" onclick="limparAssinatura()">Limpar Assinatura</button>

      <p id="nomeAssinatura" style="text-align:center;font-weight:bold;margin-top:10px;"></p>

      <!-- üî• LOADING DO PDF -->
      <div id="loadingPDF" class="loading-pdf">
        <div style="width: 30px; height: 30px; border: 3px solid #f3f3f3; border-top: 3px solid #2b6cb0; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
        <p style="margin-top: 10px;">Gerando PDF e sincronizando com banco de dados...</p>
      </div>

      <button type="button" class="btn-secondary" onclick="voltarInicio()">Voltar</button>
      <button type="button" class="btn-clear" onclick="limparFormulario()">Limpar Formul√°rio</button>
      <button type="button" onclick="gerarESalvarPDF()">Gerar e Salvar PDF</button>
    </form>
  </div>

  <div id="status-conexao" class="status-conexao">Carregando sistema...</div>

  <script>
    // üî• DECLARA√á√ïES GLOBAIS NO TOPO
    window.fotoPainelDataURL = null;
    window.signaturePad = null;
    window.ctx = null;
    window.desenhando = false;
    window.supabase = null;
    window.veiculoSelecionado = null;
    window.deferredPrompt = null;
    window.supabaseCarregado = false;
    window.isOnline = navigator.onLine;
    window.usuarioLogado = null;

    // ---------- DADOS ----------
    const veiculos = {
      carro: [
        { id: "b019bb89-bbf3-4d55-be4d-9b07f32823b7", nome: "Fiat Toro", placa: "QWO9F32" },
        { id: "7b66eb48-42fe-4103-aa75-5fe1ce2f1eda", nome: "Volkswagen Saveiro", placa: "STY1F04" }
      ],
      moto: []
    };

    // ========== FUN√á√ÉO DE NOTIFICA√á√ÉO ==========
    function mostrarNotificacao(mensagem, tipo = 'sucesso') {
      const notificacao = document.getElementById('notificacaoSincronizacao');
      notificacao.textContent = mensagem;
      notificacao.className = 'notificacao-sincronizacao';
      
      if (tipo === 'offline') {
        notificacao.classList.add('notificacao-offline');
      } else if (tipo === 'erro') {
        notificacao.classList.add('notificacao-erro');
      }
      
      notificacao.style.display = 'block';
      
      setTimeout(() => {
        notificacao.style.animation = 'slideUp 0.5s ease-out';
        setTimeout(() => {
          notificacao.style.display = 'none';
          notificacao.style.animation = '';
        }, 500);
      }, 4000);
    }

    // ========== FUN√á√ÉO PARA GERAR HASH SHA256 ==========
    function gerarHashSHA256(texto) {
      return CryptoJS.SHA256(texto).toString();
    }

    // ========== FUN√á√ïES DE LOGIN ==========
    async function fazerLogin() {
      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value;
      const loginError = document.getElementById('loginError');
      const loginSuccess = document.getElementById('loginSuccess');
      const loadingLogin = document.getElementById('loadingLogin');
      
      // Resetar mensagens
      loginError.style.display = 'none';
      loginSuccess.style.display = 'none';
      
      // Valida√ß√£o b√°sica
      if (!username || !password) {
        loginError.textContent = 'Por favor, preencha todos os campos.';
        loginError.style.display = 'block';
        return;
      }
      
      // Mostrar loading
      loadingLogin.style.display = 'block';
      
      try {
        // Gerar hash da senha
        const senhaHash = gerarHashSHA256(password);
        
        // Verificar se o Supabase est√° dispon√≠vel
        if (!window.supabase || !window.supabaseCarregado) {
          await window.inicializarSupabase();
        }
        
        if (window.supabaseCarregado && window.supabase) {
          // Buscar usu√°rio no Supabase pelo nome de usu√°rio
          const { data: usuarios, error } = await window.supabase
            .from('usuarios')
            .select('*')
            .eq('nome_usuario', username.toLowerCase())
            .eq('ativo', true)
            .limit(1);
          
          if (error) {
            throw new Error('Erro ao buscar usu√°rio: ' + error.message);
          }
          
          if (!usuarios || usuarios.length === 0) {
            throw new Error('Usu√°rio n√£o encontrado ou inativo.');
          }
          
          const usuario = usuarios[0];
          
          // Verificar senha
          if (usuario.senha_hash !== senhaHash) {
            throw new Error('Senha incorreta.');
          }
          
          // Login bem-sucedido
          console.log('‚úÖ Login bem-sucedido para:', usuario.nome);
          
          // Salvar usu√°rio na sess√£o
          window.usuarioLogado = {
            id: usuario.id,
            nome: usuario.nome,
            email: usuario.email,
            nome_usuario: usuario.nome_usuario,
            funcao: usuario.funcao,
            senha_alterada: usuario.senha_alterada || false
          };
          
          // Salvar no localStorage para persist√™ncia
          localStorage.setItem('usuarioLogado', JSON.stringify(window.usuarioLogado));
          
          // ‚≠ê‚≠ê VERIFICAR SE PRECISA TROCAR SENHA
          if (!usuario.senha_alterada) {
            // Mostrar tela de troca de senha
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('trocaSenhaContainer').style.display = 'block';
            loginSuccess.style.display = 'none';
          } else {
            // Senha j√° alterada, ir para tela principal
            loginSuccess.textContent = `Login realizado com sucesso! Bem-vindo(a), ${usuario.nome.split(' ')[0]}`;
            loginSuccess.style.display = 'block';
            
            setTimeout(() => {
              mostrarTelaPrincipal();
            }, 1000);
          }
          
        } else {
          // Modo offline - verificar credenciais locais (para desenvolvimento)
          throw new Error('Conex√£o com banco de dados n√£o dispon√≠vel. Tente novamente mais tarde.');
        }
        
      } catch (error) {
        console.error('‚ùå Erro no login:', error);
        loginError.textContent = error.message;
        loginError.style.display = 'block';
      } finally {
        loadingLogin.style.display = 'none';
      }
    }

    // ========== FUN√á√ÉO PARA TROCAR SENHA ==========
    async function trocarSenha() {
      const novaSenha = document.getElementById('novaSenha').value;
      const confirmarSenha = document.getElementById('confirmarSenha').value;
      const trocaError = document.getElementById('trocaError');
      const trocaSuccess = document.getElementById('trocaSuccess');
      
      // Resetar mensagens
      trocaError.style.display = 'none';
      trocaSuccess.style.display = 'none';
      
      // Valida√ß√µes
      if (!novaSenha || !confirmarSenha) {
        trocaError.textContent = 'Por favor, preencha todos os campos.';
        trocaError.style.display = 'block';
        return;
      }
      
      if (novaSenha !== confirmarSenha) {
        trocaError.textContent = 'As senhas n√£o coincidem.';
        trocaError.style.display = 'block';
        return;
      }
      
      if (novaSenha.length < 6) {
        trocaError.textContent = 'A senha deve ter no m√≠nimo 6 caracteres.';
        trocaError.style.display = 'block';
        return;
      }
      
      // Verificar se a nova senha √© diferente da atual (123456)
      const senhaAtualHash = gerarHashSHA256('123456');
      const novaSenhaHash = gerarHashSHA256(novaSenha);
      
      if (senhaAtualHash === novaSenhaHash) {
        trocaError.textContent = 'A nova senha n√£o pode ser igual √† senha padr√£o (123456).';
        trocaError.style.display = 'block';
        return;
      }
      
      try {
        // Atualizar no Supabase
        const { error } = await window.supabase
          .from('usuarios')
          .update({ 
            senha_hash: novaSenhaHash,
            senha_alterada: true
          })
          .eq('id', window.usuarioLogado.id);
        
        if (error) throw error;
        
        // Atualizar localmente
        window.usuarioLogado.senha_alterada = true;
        localStorage.setItem('usuarioLogado', JSON.stringify(window.usuarioLogado));
        
        // Mensagem de sucesso
        trocaSuccess.textContent = 'Senha alterada com sucesso! Redirecionando...';
        trocaSuccess.style.display = 'block';
        
        // Redirecionar ap√≥s 1.5 segundos
        setTimeout(() => {
          document.getElementById('trocaSenhaContainer').style.display = 'none';
          mostrarTelaPrincipal();
        }, 1500);
        
      } catch (error) {
        console.error('‚ùå Erro ao trocar senha:', error);
        trocaError.textContent = 'Erro ao salvar nova senha. Tente novamente.';
        trocaError.style.display = 'block';
      }
    }

    // ========== FUN√á√ÉO PARA FAZER LOGOUT ==========
    function fazerLogout() {
      if (confirm('Deseja realmente sair do sistema?')) {
        // Limpar dados da sess√£o
        window.usuarioLogado = null;
        localStorage.removeItem('usuarioLogado');
        
        // Limpar formul√°rio
        limparFormulario();
        
        // Mostrar tela de login
        document.getElementById('mainContainer').style.display = 'none';
        document.getElementById('trocaSenhaContainer').style.display = 'none';
        document.getElementById('loginContainer').style.display = 'block';
        
        // Limpar campos de login
        document.getElementById('loginUsername').value = '';
        document.getElementById('loginPassword').value = '';
        
        mostrarNotificacao('Logout realizado com sucesso.', 'sucesso');
      }
    }

    // ========== FUN√á√ÉO PARA MOSTRAR TELA PRINCIPAL ==========
    function mostrarTelaPrincipal() {
      if (!window.usuarioLogado) {
        console.error('‚ùå Nenhum usu√°rio logado');
        return;
      }
      
      // Esconder outras telas
      document.getElementById('loginContainer').style.display = 'none';
      document.getElementById('trocaSenhaContainer').style.display = 'none';
      
      // Mostrar tela principal
      document.getElementById('mainContainer').style.display = 'block';
      
      // Preencher informa√ß√µes do usu√°rio
      document.getElementById('userName').textContent = window.usuarioLogado.nome;
      document.getElementById('userEmail').textContent = window.usuarioLogado.email || window.usuarioLogado.nome_usuario;
      
      document.getElementById('colaboradorInfo').innerHTML = `
        <span>${window.usuarioLogado.nome}</span>
        ${window.usuarioLogado.funcao ? `<br><small>${window.usuarioLogado.funcao}</small>` : ''}
      `;
      
      // Atualizar nome da assinatura
      document.getElementById('nomeAssinatura').textContent = window.usuarioLogado.nome;
      
      // Inicializar data/hora
      atualizarDataHora();
      
      mostrarNotificacao(`Bem-vindo(a), ${window.usuarioLogado.nome.split(' ')[0]}!`, 'sucesso');
    }

    // ========== VERIFICAR SE USU√ÅRIO J√Å EST√Å LOGADO ==========
    function verificarLoginSalvo() {
      try {
        const usuarioSalvo = localStorage.getItem('usuarioLogado');
        
        if (usuarioSalvo) {
          window.usuarioLogado = JSON.parse(usuarioSalvo);
          console.log('‚úÖ Usu√°rio recuperado da sess√£o:', window.usuarioLogado.nome);
          
          // Se a senha j√° foi alterada, mostrar tela principal
          if (window.usuarioLogado.senha_alterada) {
            mostrarTelaPrincipal();
          } else {
            // Senha n√£o alterada, mostrar tela de troca
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('trocaSenhaContainer').style.display = 'block';
          }
        }
      } catch (error) {
        console.error('‚ùå Erro ao verificar login salvo:', error);
        localStorage.removeItem('usuarioLogado');
      }
    }

    // ========== SUPABASE CONFIGURA√á√ÉO ==========
    window.inicializarSupabase = async function() {
      try {
        console.log('üîÑ Inicializando Supabase...');
        
        // Verificar se a biblioteca est√° carregada
        if (typeof supabase === 'undefined') {
          console.warn('‚ö†Ô∏è Biblioteca Supabase n√£o carregada');
          window.supabaseCarregado = false;
          mostrarStatusConexao('‚ö†Ô∏è Modo offline');
          return null;
        }
        
        // Criar cliente
        window.supabase = supabase.createClient(
          'https://lrfhudpojewxwknqekdg.supabase.co',
          'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxyZmh1ZHBvamV3eHdrbnFla2RnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyOTEyNTMsImV4cCI6MjA4MDg2NzI1M30.JmfyUpUO2-qhMsZv17j6YACLfACYG3PneLoLqwtGR4s'
        );
        
        // Testar conex√£o (com timeout)
        const timeoutPromise = new Promise((_, reject) => 
          setTimeout(() => reject(new Error('Timeout na conex√£o')), 5000)
        );
        
        const conexaoPromise = window.supabase
          .from('usuarios')
          .select('count', { count: 'exact', head: true })
          .limit(1);
        
        try {
          const { data, error } = await Promise.race([conexaoPromise, timeoutPromise]);
          
          if (error) {
            console.warn('‚ö†Ô∏è Erro na conex√£o:', error.message);
            window.supabaseCarregado = false;
            mostrarStatusConexao('‚ö†Ô∏è Modo offline');
          } else {
            console.log('‚úÖ Supabase conectado com sucesso!');
            window.supabaseCarregado = true;
            mostrarStatusConexao('‚úÖ Conectado ao banco');
            
            // Sincronizar dados offline se houver
            sincronizarDadosOffline();
          }
        } catch (timeoutError) {
          console.warn('‚ö†Ô∏è Timeout na conex√£o com Supabase');
          window.supabaseCarregado = false;
          mostrarStatusConexao('‚ö†Ô∏è Modo offline');
        }
        
        return window.supabase;
        
      } catch (error) {
        console.error('‚ùå Erro ao inicializar Supabase:', error);
        window.supabaseCarregado = false;
        mostrarStatusConexao('‚ö†Ô∏è Modo offline');
        return null;
      }
    };

    // ========== FUN√á√ïES PRINCIPAIS ==========
    
    // üî• FUN√á√ÉO PRINCIPAL: CONTINUAR ROTA
    window.continuarRota = function() {
      const tipo = document.getElementById("rotaTipo").value;
      
      if (!tipo || tipo === "") {
        alert("Por favor, selecione o tipo de rota (In√≠cio ou Final) para continuar.");
        document.getElementById("rotaTipo").focus();
        document.getElementById("rotaTipo").style.borderColor = "#dc3545";
        return;
      }
      
      document.getElementById("rotaTipo").style.borderColor = "";
      
      console.log(`‚úÖ Tipo de rota selecionado: ${tipo}`);
      
      atualizarDataHora();
      
      document.getElementById("step-selection").style.display = "none";
      document.getElementById("formulario").style.display = "block";
      
      setTimeout(function() {
        try {
          inicializarAssinatura();
        } catch (error) {
          console.error("‚ùå Erro ao inicializar assinatura:", error);
        }
      }, 200);
    };

    // üî• VOLTAR IN√çCIO
    window.voltarInicio = function() {
      document.getElementById("formulario").reset();
      document.getElementById("formulario").style.display = "none";
      document.getElementById("step-selection").style.display = "block";
      limparAssinatura();
      window.fotoPainelDataURL = null;
      document.getElementById('fotoPreview').style.display = 'none';
      window.veiculoSelecionado = null;
      limparErro('km');
    };

    // üî• LIMPAR FORMUL√ÅRIO
    window.limparFormulario = function() {
      if (confirm("Deseja limpar todos os campos?")) {
        document.getElementById("formulario").reset();
        atualizarDataHora();
        limparAssinatura();
        window.fotoPainelDataURL = null;
        document.getElementById('fotoPreview').style.display = 'none';
        window.veiculoSelecionado = null;
        limparErro('km');
      }
    };

    // üî• LIMPAR ASSINATURA
    window.limparAssinatura = function() {
      if (window.ctx) {
        window.ctx.clearRect(0, 0, window.signaturePad.width, window.signaturePad.height);
      }
    };

    // ========== FUN√á√ïES AUXILIARES ==========
    function mostrarErro(campoId, mensagem) {
      const campo = document.getElementById(campoId);
      const erroDiv = document.getElementById(campoId + 'Error');
      
      if (campo) campo.classList.add('km-invalido');
      if (erroDiv) {
        erroDiv.textContent = mensagem;
        erroDiv.style.display = 'block';
      }
    }

    function limparErro(campoId) {
      const campo = document.getElementById(campoId);
      const erroDiv = document.getElementById(campoId + 'Error');
      
      if (campo) campo.classList.remove('km-invalido', 'km-alerta', 'km-valido');
      if (erroDiv) erroDiv.style.display = 'none';
    }

    function mostrarStatusConexao(mensagem) {
      const statusDiv = document.getElementById('status-conexao');
      if (statusDiv) {
        statusDiv.textContent = mensagem;
        
        // Atualizar cor baseada no status
        if (mensagem.includes('Conectado')) {
          statusDiv.style.background = '#d4edda';
          statusDiv.style.color = '#155724';
          statusDiv.style.borderColor = '#c3e6cb';
        } else if (mensagem.includes('offline')) {
          statusDiv.style.background = '#fff3cd';
          statusDiv.style.color = '#856404';
          statusDiv.style.borderColor = '#ffeaa7';
        } else {
          statusDiv.style.background = '#f8f9fa';
          statusDiv.style.color = '#666';
          statusDiv.style.borderColor = '#dee2e6';
        }
      }
    }

    // ---------- FUN√á√ïES DO SISTEMA ----------
    window.carregarVeiculos = function() {
      const tipo = document.getElementById("tipoVeiculo").value;
      const selectVeiculo = document.getElementById("veiculo");
      
      selectVeiculo.innerHTML = '<option value="">Selecione</option>';
      
      veiculos[tipo]?.forEach(v => {
        const opt = document.createElement("option");
        opt.value = v.id;
        opt.textContent = v.nome;
        opt.setAttribute('data-veiculo', JSON.stringify(v));
        selectVeiculo.appendChild(opt);
      });
      
      if (veiculos[tipo] && veiculos[tipo].length === 0) {
        selectVeiculo.innerHTML = '<option value="">Nenhum ve√≠culo encontrado</option>';
      }
    };

    window.atualizarPlaca = function() {
      const veiculoSelect = document.getElementById("veiculo");
      const selectedOption = veiculoSelect.options[veiculoSelect.selectedIndex];
      
      if (selectedOption.value) {
        try {
          window.veiculoSelecionado = JSON.parse(selectedOption.getAttribute('data-veiculo'));
          const placaInput = document.getElementById("placa");
          placaInput.value = window.veiculoSelecionado.placa;
          console.log('‚úÖ Ve√≠culo selecionado:', window.veiculoSelecionado);
        } catch (error) {
          console.error('‚ùå Erro ao processar ve√≠culo:', error);
          window.veiculoSelecionado = null;
          document.getElementById("placa").value = "";
        }
      } else {
        window.veiculoSelecionado = null;
        document.getElementById("placa").value = "";
      }
    };

    // ---------- PREVIEW DA FOTO ----------
    window.previewFoto = function(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          window.fotoPainelDataURL = e.target.result;
          const preview = document.getElementById('fotoPreview');
          preview.src = window.fotoPainelDataURL;
          preview.style.display = 'block';
        };
        reader.readAsDataURL(file);
      }
    };

    // ---------- ASSINATURA DIGITAL ----------
    function inicializarAssinatura() {
      window.signaturePad = document.getElementById("signature-pad");
      if (!window.signaturePad) {
        console.error("Canvas da assinatura n√£o encontrado!");
        return;
      }
      
      window.ctx = window.signaturePad.getContext("2d");
      
      window.signaturePad.width = window.signaturePad.offsetWidth;
      window.signaturePad.height = window.signaturePad.offsetHeight;
      
      window.ctx.strokeStyle = '#000000';
      window.ctx.lineWidth = 2;
      window.ctx.lineCap = 'round';
      window.ctx.lineJoin = 'round';
      
      window.signaturePad.replaceWith(window.signaturePad.cloneNode(true));
      window.signaturePad = document.getElementById("signature-pad");
      window.ctx = window.signaturePad.getContext("2d");
      
      window.ctx.strokeStyle = '#000000';
      window.ctx.lineWidth = 2;
      window.ctx.lineCap = 'round';
      window.ctx.lineJoin = 'round';
      
      window.signaturePad.addEventListener('mousedown', iniciarDesenho);
      window.signaturePad.addEventListener('mousemove', desenhar);
      window.signaturePad.addEventListener('mouseup', pararDesenho);
      window.signaturePad.addEventListener('mouseleave', pararDesenho);
      
      window.signaturePad.addEventListener('touchstart', iniciarDesenho);
      window.signaturePad.addEventListener('touchmove', desenhar);
      window.signaturePad.addEventListener('touchend', pararDesenho);
    }

    function getCoordenadasCanvas(e) {
      const rect = window.signaturePad.getBoundingClientRect();
      let clientX, clientY;
      
      if (e.type.includes('touch')) {
        clientX = e.touches[0].clientX;
        clientY = e.touches[0].clientY;
      } else {
        clientX = e.clientX;
        clientY = e.clientY;
      }
      
      return {
        x: clientX - rect.left,
        y: clientY - rect.top
      };
    }

    function iniciarDesenho(e) {
      e.preventDefault();
      window.desenhando = true;
      const coords = getCoordenadasCanvas(e);
      window.ctx.beginPath();
      window.ctx.moveTo(coords.x, coords.y);
    }

    function desenhar(e) {
      e.preventDefault();
      if (!window.desenhando) return;
      
      const coords = getCoordenadasCanvas(e);
      window.ctx.lineTo(coords.x, coords.y);
      window.ctx.stroke();
    }

    function pararDesenho() {
      window.desenhando = false;
    }

    // ---------- AUTO DATA / HORA ----------
    function atualizarDataHora() {
      const agora = new Date();
      
      // Formatar data no formato YYYY-MM-DD para o Supabase (tipo date)
      const dataFormatada = agora.toISOString().split('T')[0];
      
      // Formatar hora no formato HH:MM
      const horaFormatada = agora.toLocaleTimeString("pt-BR", { 
        hour: "2-digit", 
        minute: "2-digit", 
        hour12: false 
      });
      
      document.getElementById("dataAtual").value = agora.toLocaleDateString("pt-BR");
      document.getElementById("horaAtual").value = horaFormatada;
      
      return {
        dataSupabase: dataFormatada,
        hora: horaFormatada
      };
    }

    // ========== FUN√á√ÉO PRINCIPAL: SALVAR NO SUPABASE ==========
    async function salvarChecklist(dados) {
      try {
        console.log('üíæ Tentando salvar no Supabase...', dados);
        
        // Verificar se o Supabase est√° dispon√≠vel
        if (!window.supabase || !window.supabaseCarregado) {
          console.warn('‚ö†Ô∏è Supabase n√£o dispon√≠vel, tentando reconectar...');
          await window.inicializarSupabase();
          
          if (!window.supabase || !window.supabaseCarregado) {
            throw new Error('Supabase n√£o dispon√≠vel ap√≥s tentativa de reconex√£o');
          }
        }
        
        // Comprimir imagem se necess√°rio
        let fotoComprimida = dados.fotoPainel;
        if (dados.fotoPainel && dados.fotoPainel.length > 100000) {
          console.log('üì∏ Comprimindo imagem...');
          fotoComprimida = await comprimirImagem(dados.fotoPainel, 800, 0.7);
        }
        
        // üî• CORRE√á√ÉO: AGORA USANDO A COLUNA colaborador_id QUE EXISTE
        const dadosParaSalvar = {
          veiculo_id: dados.veiculoId,
          data: dados.dataSupabase,
          km: parseInt(dados.km),
          colaborador: window.usuarioLogado.nome,
          colaborador_id: window.usuarioLogado.id, // ‚≠ê COLUNA QUE VOC√ä CRIOU
          itens: null,
          observacoes: null,
          tipo_rota: dados.tipoRota,
          hora: dados.hora,
          tipo_veiculo: dados.tipoVeiculo,
          veiculo: dados.veiculoNome,
          placa: dados.placa,
          foto_painel_base64: fotoComprimida,
          assinatura_base64: dados.assinatura,
          created_at: new Date().toISOString(),
          updated_at: new Date().toISOString()
        };
        
        console.log('üì§ Dados preparados para envio:', dadosParaSalvar);
        
        // Inserir no banco de dados
        const { data, error } = await window.supabase
          .from('checklists')
          .insert([dadosParaSalvar])
          .select();
        
        if (error) {
          console.error('‚ùå Erro ao salvar no Supabase:', error);
          throw error;
        }
        
        console.log('‚úÖ Dados salvos com sucesso no Supabase:', data);
        return { success: true, online: true };
        
      } catch (error) {
        console.error('‚ùå Erro na fun√ß√£o salvarChecklist:', error);
        
        // Tentar salvar offline (em localStorage) como fallback
        try {
          const checklistsOffline = JSON.parse(localStorage.getItem('checklists_offline') || '[]');
          const dadosOffline = {
            ...dados,
            colaborador: window.usuarioLogado.nome,
            colaborador_id: window.usuarioLogado.id, // ‚≠ê MESMA CORRE√á√ÉO OFFLINE
            tentativa_salvamento: new Date().toISOString(),
            status: 'pendente'
          };
          checklistsOffline.push(dadosOffline);
          localStorage.setItem('checklists_offline', JSON.stringify(checklistsOffline));
          console.log('üì± Dados salvos offline para sincroniza√ß√£o posterior');
          
          return { success: true, online: false };
        } catch (offlineError) {
          console.error('‚ùå Erro ao salvar offline:', offlineError);
          return { success: false, online: false };
        }
      }
    }

    // ========== SINCRONIZA√á√ÉO DE DADOS OFFLINE ==========
    async function sincronizarDadosOffline() {
      if (!window.supabaseCarregado || !window.supabase) {
        console.log('‚ö†Ô∏è Supabase n√£o dispon√≠vel para sincroniza√ß√£o');
        return;
      }
      
      try {
        const dadosOffline = JSON.parse(localStorage.getItem('checklists_offline') || '[]');
        
        if (dadosOffline.length === 0) {
          console.log('‚ÑπÔ∏è Nenhum dado offline para sincronizar');
          return;
        }
        
        console.log(`üì§ Tentando sincronizar ${dadosOffline.length} registros offline...`);
        
        const sucessos = [];
        const falhas = [];
        
        for (let i = 0; i < dadosOffline.length; i++) {
          const dados = dadosOffline[i];
          
          try {
            // üî• CORRE√á√ÉO: INCLUINDO A COLUNA colaborador_id
            const dadosParaEnviar = {
              veiculo_id: dados.veiculoId || null,
              data: dados.dataSupabase || dados.data?.split('/').reverse().join('-') || new Date().toISOString().split('T')[0],
              km: parseInt(dados.km) || 0,
              colaborador: dados.colaborador || '',
              colaborador_id: dados.colaborador_id || null, // ‚≠ê COLUNA QUE VOC√ä CRIOU
              itens: null,
              observacoes: null,
              tipo_rota: dados.tipoRota || '',
              hora: dados.hora || '',
              tipo_veiculo: dados.tipoVeiculo || '',
              veiculo: dados.veiculoNome || dados.veiculo || '',
              placa: dados.placa || '',
              foto_painel_base64: dados.fotoPainel || '',
              assinatura_base64: dados.assinatura || '',
              created_at: dados.created_at || new Date().toISOString(),
              updated_at: new Date().toISOString()
            };
            
            // Remover campos undefined
            Object.keys(dadosParaEnviar).forEach(key => {
              if (dadosParaEnviar[key] === undefined) {
                delete dadosParaEnviar[key];
              }
            });
            
            console.log('üì§ Enviando dados offline:', dadosParaEnviar);
            
            const { error } = await window.supabase
              .from('checklists')
              .insert([dadosParaEnviar]);
            
            if (!error) {
              sucessos.push(dados);
              dadosOffline.splice(i, 1);
              i--;
              console.log(`‚úÖ Registro sincronizado: ${dados.veiculo || dados.veiculoNome} - ${dados.data}`);
            } else {
              falhas.push({ dados, error });
              console.warn(`‚ö†Ô∏è Falha ao sincronizar: ${error.message}`);
            }
          } catch (registroError) {
            falhas.push({ dados, error: registroError });
            console.error(`‚ùå Erro no registro: ${registroError.message}`);
          }
        }
        
        // Atualizar localStorage
        localStorage.setItem('checklists_offline', JSON.stringify(dadosOffline));
        
        if (sucessos.length > 0) {
          mostrarNotificacao(`‚úÖ ${sucessos.length} registro(s) sincronizado(s) com sucesso!`);
        }
        
        if (falhas.length > 0) {
          console.warn(`${falhas.length} registros falharam na sincroniza√ß√£o`, falhas);
        }
        
        console.log(`‚úÖ Sincroniza√ß√£o conclu√≠da: ${sucessos.length} sucesso(s), ${falhas.length} falha(s)`);
        
      } catch (error) {
        console.error('‚ùå Erro na sincroniza√ß√£o offline:', error);
      }
    }

    // ========== FUN√á√ÉO PARA COMPRIMIR IMAGEM ==========
    function comprimirImagem(base64, maxWidth = 800, qualidade = 0.6) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = function() {
          const canvas = document.createElement('canvas');
          let width = img.width;
          let height = img.height;
          
          if (width > maxWidth) {
            height = (height * maxWidth) / width;
            width = maxWidth;
          }
          
          canvas.width = width;
          canvas.height = height;
          
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);
          
          const compressedBase64 = canvas.toDataURL('image/jpeg', qualidade);
          resolve(compressedBase64);
        };
        img.src = base64;
      });
    }

    // üî• FUN√á√ÉO AUXILIAR: VERIFICAR SE A ASSINATURA EST√Å EM BRANCO
    function signaturePadBlank() {
      if (!window.ctx) return true;
      
      const imageData = window.ctx.getImageData(0, 0, window.signaturePad.width, window.signaturePad.height).data;
      for (let i = 0; i < imageData.length; i += 4) {
        if (imageData[i + 3] !== 0) return false;
      }
      return true;
    }

    // ========== VALIDA√á√ÉO DE KM EM TEMPO REAL ==========
    document.getElementById('km').addEventListener('blur', async function() {
      await validarKMEmTempoReal();
    });

    document.getElementById('placa').addEventListener('change', async function() {
      await validarKMEmTempoReal();
    });

    async function validarKMEmTempoReal() {
      const placa = document.getElementById('placa').value;
      const kmInput = document.getElementById('km');
      const kmDigitado = parseInt(kmInput.value);
      
      if (!placa || !kmDigitado || isNaN(kmDigitado)) {
        kmInput.classList.remove('km-valido', 'km-alerta', 'km-invalido');
        limparErro('km');
        return;
      }
      
      console.log(`üîÑ Validando KM: ${kmDigitado} para placa: ${placa}`);
      
      // üî• BUSCAR √öLTIMO KM DO SUPABASE
      if (window.supabaseCarregado && window.supabase) {
        try {
          const { data, error } = await window.supabase
            .from('checklists')
            .select('km')
            .eq('placa', placa)
            .order('created_at', { ascending: false })
            .limit(1);
          
          if (!error && data && data.length > 0) {
            const ultimoKM = data[0].km;
            
            if (kmDigitado < ultimoKM) {
              kmInput.classList.add('km-invalido');
              mostrarErro('km', `‚ùå KM menor que o anterior (${ultimoKM} km)`);
            } else if (kmDigitado === ultimoKM) {
              kmInput.classList.add('km-alerta');
              mostrarErro('km', `‚ö†Ô∏è KM igual ao anterior (${ultimoKM} km)`);
            } else if (kmDigitado > ultimoKM + 1000) {
              kmInput.classList.add('km-alerta');
              mostrarErro('km', `‚ö†Ô∏è KM muito acima do anterior (${ultimoKM} km)`);
            } else {
              kmInput.classList.add('km-valido');
              limparErro('km');
            }
          } else {
            kmInput.classList.remove('km-valido', 'km-alerta', 'km-invalido');
            limparErro('km');
          }
        } catch (error) {
          console.warn('‚ö†Ô∏è Erro ao buscar KM:', error);
          kmInput.classList.remove('km-valido', 'km-alerta', 'km-invalido');
          limparErro('km');
        }
      } else {
        kmInput.classList.remove('km-valido', 'km-alerta', 'km-invalido');
        limparErro('km');
      }
    }

    // ========== EVENT LISTENERS AO CARREGAR ==========
    document.addEventListener('DOMContentLoaded', function() {
      const continuarBtn = document.getElementById('continuarBtn');
      if (continuarBtn) {
        continuarBtn.addEventListener('click', window.continuarRota);
        console.log('‚úÖ Bot√£o "Continuar" configurado com sucesso');
      }
      
      // Permitir login com Enter
      document.getElementById('loginPassword').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          fazerLogin();
        }
      });
      
      // Permitir troca de senha com Enter
      document.getElementById('confirmarSenha').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          trocarSenha();
        }
      });
      
      // üî• MONITORAR CONEX√ÉO
      window.addEventListener('online', function() {
        window.isOnline = true;
        mostrarStatusConexao('üåê Conex√£o restabelecida');
        console.log('‚úÖ Conex√£o restabelecida');
        
        // Tentar reconectar ao Supabase
        setTimeout(async () => {
          await window.inicializarSupabase();
          sincronizarDadosOffline();
        }, 1000);
      });
      
      window.addEventListener('offline', function() {
        window.isOnline = false;
        mostrarStatusConexao('‚ö†Ô∏è Sem conex√£o (modo offline)');
        console.log('‚ö†Ô∏è Conex√£o perdida - modo offline');
      });
      
      // üî• INICIALIZAR SUPABASE
      setTimeout(async () => {
        try {
          await window.inicializarSupabase();
        } catch (error) {
          console.warn('‚ö†Ô∏è Supabase n√£o dispon√≠vel, continuando em modo local');
        }
      }, 1000);
      
      // üî• VERIFICAR SE USU√ÅRIO J√Å EST√Å LOGADO
      setTimeout(() => {
        verificarLoginSalvo();
      }, 500);
      
      // Inicializar data/hora
      atualizarDataHora();
      setInterval(atualizarDataHora, 60000);
      
      console.log('‚úÖ Aplica√ß√£o carregada');
      mostrarStatusConexao('‚úÖ Sistema carregado');
    });

    // ========== PWA INSTALL PROMPT ==========
    window.addEventListener('beforeinstallprompt', (e) => {
      console.log('‚úÖ beforeinstallprompt disparado');
      
      e.preventDefault();
      window.deferredPrompt = e;
      
      const installContainer = document.getElementById('installContainer');
      if (installContainer) {
        installContainer.style.display = 'block';
      }
      
      verificarSeAppInstalado();
    });

    const installButton = document.getElementById('installButton');
    if (installButton) {
      installButton.addEventListener('click', async () => {
        if (!window.deferredPrompt) {
          alert('O app j√° est√° instalado ou n√£o suporta instala√ß√£o.');
          return;
        }
        
        window.deferredPrompt.prompt();
        const { outcome } = await window.deferredPrompt.userChoice;
        
        console.log(`Usu√°rio ${outcome === 'accepted' ? 'aceitou' : 'recusou'} a instala√ß√£o`);
        window.deferredPrompt = null;
        
        const installContainer = document.getElementById('installContainer');
        if (installContainer) {
          installContainer.style.display = 'none';
        }
      });
    }

    function verificarSeAppInstalado() {
      const isStandalone = window.matchMedia('(display-mode: standalone)').matches ||
                         window.navigator.standalone ||
                         document.referrer.includes('android-app://');
      
      if (isStandalone) {
        console.log('üì± App j√° est√° instalado');
        const installContainer = document.getElementById('installContainer');
        if (installContainer) {
          installContainer.style.display = 'none';
        }
        return true;
      }
      return false;
    }

    window.addEventListener('appinstalled', (evt) => {
      console.log('üéâ App instalado com sucesso!');
      
      const installContainer = document.getElementById('installContainer');
        if (installContainer) {
          installContainer.style.display = 'none';
        }
      
      mostrarNotificacao('‚úÖ App instalado com sucesso! Agora voc√™ pode acessar offline', 'sucesso');
      window.deferredPrompt = null;
    });

    // ========== FUN√á√ÉO PRINCIPAL: GERAR PDF E SALVAR NO BANCO ==========
    window.gerarESalvarPDF = async function() {
      const campos = document.querySelectorAll("#formulario [required]");
      for (const campo of campos) {
        if (!campo.value) {
          alert("Preencha todos os campos obrigat√≥rios antes de gerar o PDF!");
          return;
        }
      }
      
      if (!window.fotoPainelDataURL) {
        alert("Por favor, capture a foto do painel antes de gerar o PDF!");
        return;
      }
      
      if (!window.veiculoSelecionado) {
        alert("Por favor, selecione um ve√≠culo v√°lido!");
        return;
      }
      
      const rotaTipoSelect = document.getElementById('rotaTipo');
      const rotaTipoValue = rotaTipoSelect.value;
      const rotaTipoText = rotaTipoSelect.options[rotaTipoSelect.selectedIndex].text;
      
      let tipoRotaParaSalvar = 'IN√çCIO';
      
      if (rotaTipoValue === 'inicio' || rotaTipoText.includes('In√≠cio')) {
        tipoRotaParaSalvar = 'IN√çCIO';
      } else if (rotaTipoValue === 'final' || rotaTipoText.includes('Final')) {
        tipoRotaParaSalvar = 'FINAL';
      }
      
      if (!confirm(`Confirma que esta √© uma rota de: ${rotaTipoText}?\n\nSalvar√° como: ${tipoRotaParaSalvar}`)) {
        alert('Por favor, verifique o tipo de rota selecionado.');
        return;
      }
      
      const placa = document.getElementById('placa').value;
      const kmAtual = parseInt(document.getElementById('km').value);

      if (placa && !isNaN(kmAtual)) {
        if (kmAtual <= 0) {
          alert("‚ùå Quilometragem inv√°lida! O KM deve ser maior que zero.");
          document.getElementById('km').focus();
          mostrarErro('km', 'KM deve ser maior que zero');
          return;
        }
        
        if (kmAtual > 999999) {
          alert("‚ùå Quilometragem muito alta! Verifique o valor digitado.");
          document.getElementById('km').focus();
          mostrarErro('km', 'KM muito alto');
          return;
        }
          
      } else {
        alert("Por favor, preencha a placa e quilometragem corretamente.");
        return;
      }
        
      // Atualizar data e hora, capturando os formatos corretos para o banco
      const { dataSupabase, hora } = atualizarDataHora();
      
      document.getElementById('loadingPDF').style.display = 'block';
      
      try {
        // üî• 1. SALVAR NO BANCO DE DADOS PRIMEIRO
        const dadosParaSalvar = {
          dataSupabase: dataSupabase,
          hora: hora,
          tipoVeiculo: document.getElementById('tipoVeiculo').value,
          veiculoId: window.veiculoSelecionado?.id || null,
          veiculoNome: document.getElementById('veiculo').options[document.getElementById('veiculo').selectedIndex].text,
          placa: placa,
          km: kmAtual,
          tipoRota: tipoRotaParaSalvar,
          fotoPainel: window.fotoPainelDataURL,
          assinatura: window.signaturePad.toDataURL()
        };
        
        console.log('üíæ Salvando dados no banco...', dadosParaSalvar);
        const resultadoSalvamento = await salvarChecklist(dadosParaSalvar);
        
        // üî• 2. GERAR PDF AP√ìS SALVAR OS DADOS
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        const dataExibicao = document.getElementById('dataAtual').value;
        const horaExibicao = document.getElementById('horaAtual').value;
        const tipoVeiculo = document.getElementById('tipoVeiculo').value;
        const veiculoNome = document.getElementById('veiculo').options[document.getElementById('veiculo').selectedIndex].text;
        const km = document.getElementById('km').value;
        
        const margin = 20;
        const pageWidth = doc.internal.pageSize.getWidth();
        const contentWidth = pageWidth - (margin * 2);
        let yPos = margin;
        
        const logoUrl = 'https://i.imgur.com/SEr4lkm.png';
        
        doc.addImage(logoUrl, 'PNG', pageWidth / 2 - 30, yPos, 60, 22);
        yPos += 30;
        
        doc.setFontSize(14);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(0, 0, 0);
        doc.text('Controle de Uso de Ve√≠culos', pageWidth / 2, yPos, { align: 'center' });
        yPos += 15;
        
        doc.setFontSize(10);
        
        function adicionarCampo(rotulo, valor, y) {
          doc.setFont(undefined, 'bold');
          doc.text(rotulo, margin, y);
          
          doc.setFont(undefined, 'normal');
          doc.text(valor.toString(), margin, y + 5);
          
          doc.setDrawColor(200, 200, 200);
          doc.setLineWidth(0.3);
          doc.line(margin, y + 8, pageWidth - margin, y + 8);
          
          return y + 12;
        }
        
        yPos = adicionarCampo('Data:', dataExibicao, yPos);
        yPos = adicionarCampo('Hora:', horaExibicao, yPos);
        yPos = adicionarCampo('Colaborador:', window.usuarioLogado.nome, yPos);
        yPos = adicionarCampo('Tipo de Ve√≠culo:', tipoVeiculo.charAt(0).toUpperCase() + tipoVeiculo.slice(1), yPos);
        yPos = adicionarCampo('Ve√≠culo:', veiculoNome, yPos);
        yPos = adicionarCampo('Placa:', placa, yPos);
        yPos = adicionarCampo('Quilometragem:', km + ' km', yPos);
        yPos = adicionarCampo('Tipo de Rota:', tipoRotaParaSalvar, yPos);
        
        yPos += 3;
        
        doc.setFont(undefined, 'bold');
        doc.text('Foto do Painel (KM):', margin, yPos);
        yPos += 6;
        
        const imgWidth = 40;
        const imgHeight = 40;
        
        doc.setDrawColor(0, 0, 0);
        doc.setLineWidth(0.5);
        doc.rect(margin, yPos, imgWidth, imgHeight);
        
        const imgProps = doc.getImageProperties(window.fotoPainelDataURL);
        const finalImgWidth = imgWidth - 4;
        const finalImgHeight = imgHeight - 4;
        
        doc.addImage(window.fotoPainelDataURL, 'JPEG', margin + 2, yPos + 2, finalImgWidth, finalImgHeight);
        
        yPos += imgHeight + 10;
        
        doc.setFont(undefined, 'bold');
        doc.text('Assinatura Digital:', pageWidth / 2, yPos, { align: 'center' });
        yPos += 6;
        
        doc.setDrawColor(0, 0, 0);
        doc.setLineWidth(0.5);
        const signatureHeight = 25;
        doc.rect(margin, yPos, contentWidth, signatureHeight);
        
        const signatureDataURL = window.signaturePad.toDataURL();
        if (signatureDataURL && !signaturePadBlank()) {
          try {
            const signatureProps = doc.getImageProperties(signatureDataURL);
            const signatureWidth = contentWidth - 10;
            const calcSignatureHeight = (signatureProps.height * signatureWidth) / signatureProps.width;
            
            const finalSignatureHeight = Math.min(calcSignatureHeight, signatureHeight - 4);
            
            doc.addImage(signatureDataURL, 'PNG', margin + 3, yPos + 3, signatureWidth - 6, finalSignatureHeight);
          } catch (e) {
            console.log('Erro ao adicionar assinatura:', e);
          }
        }
        
        yPos += signatureHeight + 8;
        
        doc.setFont(undefined, 'bold');
        doc.setFontSize(9);
        doc.text(window.usuarioLogado.nome, pageWidth / 2, yPos, { align: 'center' });
        
        // üî• 3. STATUS DO SALVAMENTO NO PDF
        yPos += 10;
        doc.setFontSize(8);
        doc.setTextColor(100, 100, 100);
        
        if (resultadoSalvamento.success) {
          if (resultadoSalvamento.online) {
            doc.text('‚úÖ Dados sincronizados com o banco de dados', margin, yPos);
          } else {
            doc.text('üì± Dados salvos localmente (ser√£o sincronizados quando houver conex√£o)', margin, yPos);
          }
        } else {
          doc.text('‚ö†Ô∏è Erro ao salvar os dados', margin, yPos);
        }
        
        const fileName = `Checklist_${veiculoNome.replace(/\s+/g, '_')}_${dataExibicao.replace(/\//g, '-')}_${tipoRotaParaSalvar}.pdf`;
        
        // üî• SALVAR PDF
        doc.save(fileName);
        
        // üî• 4. MOSTRAR NOTIFICA√á√ÉO DO RESULTADO
        if (resultadoSalvamento.success) {
          if (resultadoSalvamento.online) {
            mostrarNotificacao(`‚úÖ PDF gerado e dados sincronizados com sucesso!\nTipo de Rota: ${tipoRotaParaSalvar}`, 'sucesso');
          } else {
            mostrarNotificacao(`üì± PDF gerado! Dados salvos localmente (modo offline)\nSer√£o sincronizados automaticamente quando a conex√£o voltar.`, 'offline');
          }
        } else {
          mostrarNotificacao(`‚ö†Ô∏è PDF gerado, mas houve um erro ao salvar os dados.\nVerifique sua conex√£o e tente novamente.`, 'erro');
        }
        
        // üî• 5. LIMPAR FORMUL√ÅRIO AP√ìS SUCESSO
        if (resultadoSalvamento.success) {
          setTimeout(() => {
            limparFormulario();
            voltarInicio();
          }, 2000);
        }
        
      } catch (error) {
        console.error('Erro ao gerar PDF:', error);
        mostrarNotificacao('‚ùå Erro ao gerar PDF. Tente novamente.', 'erro');
      } finally {
        document.getElementById('loadingPDF').style.display = 'none';
      }
    };

    // ---------- SERVICE WORKER ----------
    if ("serviceWorker" in navigator && (window.location.protocol === 'https:' || window.location.hostname === 'localhost')) {
      navigator.serviceWorker.register("sw.js")
        .then(() => console.log("Service Worker registrado!"))
        .catch(err => console.log("Service Worker n√£o dispon√≠vel:", err.message));
    } else {
      console.log("Service Worker n√£o suportado para este protocolo:", window.location.protocol);
    }

    // üî• VERIFICAR AO CARREGAR
    setTimeout(() => {
      if (!verificarSeAppInstalado() && !window.deferredPrompt) {
        console.log('‚ÑπÔ∏è Prompt de instala√ß√£o n√£o dispon√≠vel ainda');
      }
      
      // Verificar status inicial da conex√£o
      if (!navigator.onLine) {
        window.isOnline = false;
        mostrarStatusConexao('‚ö†Ô∏è Sem conex√£o (modo offline)');
      }
    }, 1000);
  </script>
</body>
</html>
