<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <!-- Configura√ß√µes b√°sicas da p√°gina -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- T√≠tulo da p√°gina -->
    <title>Checklist Ve√≠culos</title>
    
    <!-- Importa√ß√£o do Bootstrap para estiliza√ß√£o -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Importa√ß√£o do Font Awesome para √≠cones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Estilos customizados -->
    <style>
        /* IN√çCIO ESTILOS GLOBAIS */
        body {
            background-color: #f8f9fa;
            padding-top: 20px;
        }
        
        .container {
            max-width: 800px;
        }
        
        .card {
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        /* FIM ESTILOS GLOBAIS */
    </style>
</head>
<body>
    <!-- IN√çCIO CONTAINER PRINCIPAL -->
    <div class="container">
        
        <!-- CABE√áALHO DA APLICA√á√ÉO -->
        <div class="text-center mb-4">
            <h1 class="display-4">
                <i class="fas fa-car"></i> Checklist Ve√≠culos
            </h1>
            <p class="lead">Controle de uso e manuten√ß√£o de ve√≠culos</p>
        </div>
        <!-- FIM CABE√áALHO -->

        <!-- IN√çCIO CARD DO FORMUL√ÅRIO -->
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-clipboard-list"></i> Novo Registro
                </h5>
            </div>
            
            <!-- IN√çCIO CORPO DO FORMUL√ÅRIO -->
            <div class="card-body">
                
                <!-- IN√çCIO FORMUL√ÅRIO PRINCIPAL -->
                <form id="checklistForm">
                    
                    <!-- LINHA 1: DATA E HORA -->
                    <div class="row mb-3">
                        <!-- Campo Data -->
                        <div class="col-md-6">
                            <label class="form-label">Data</label>
                            <input type="date" class="form-control" id="data" required>
                        </div>
                        <!-- Campo Hora -->
                        <div class="col-md-6">
                            <label class="form-label">Hora</label>
                            <input type="time" class="form-control" id="hora" required>
                        </div>
                    </div>
                    <!-- FIM LINHA 1 -->

                    <!-- LINHA 2: TIPO DE REGISTRO E COLABORADOR -->
                    <div class="row mb-3">
                        <!-- Campo Tipo de Registro -->
                        <div class="col-md-6">
                            <label class="form-label">Tipo de Registro</label>
                            <select class="form-select" id="tipoRegistro" required>
                                <option value="">Selecione...</option>
                                <option value="Sa√≠da">Sa√≠da</option>
                                <option value="Retorno">Retorno</option>
                                <option value="Manuten√ß√£o">Manuten√ß√£o</option>
                            </select>
                        </div>
                        <!-- Campo Colaborador -->
                        <div class="col-md-6">
                            <label class="form-label">Colaborador</label>
                            <input type="text" class="form-control" id="colaborador" required>
                        </div>
                    </div>
                    <!-- FIM LINHA 2 -->

                    <!-- LINHA 3: TIPO DE VE√çCULO E VE√çCULO -->
                    <div class="row mb-3">
                        <!-- Campo Tipo de Ve√≠culo -->
                        <div class="col-md-6">
                            <label class="form-label">Tipo de Ve√≠culo</label>
                            <select class="form-select" id="tipoVeiculo" required>
                                <option value="">Selecione...</option>
                                <option value="Carro">Carro</option>
                                <option value="Moto">Moto</option>
                                <option value="Caminh√£o">Caminh√£o</option>
                                <option value="Van">Van</option>
                            </select>
                        </div>
                        <!-- Campo Ve√≠culo -->
                        <div class="col-md-6">
                            <label class="form-label">Ve√≠culo</label>
                            <input type="text" class="form-control" id="veiculo" required>
                        </div>
                    </div>
                    <!-- FIM LINHA 3 -->

                    <!-- LINHA 4: PLACA E QUILOMETRAGEM -->
                    <div class="row mb-3">
                        <!-- Campo Placa -->
                        <div class="col-md-6">
                            <label class="form-label">Placa</label>
                            <input type="text" class="form-control" id="placa" required>
                        </div>
                        <!-- Campo Quilometragem -->
                        <div class="col-md-6">
                            <label class="form-label">Quilometragem (KM)</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="km" required>
                                <!-- Bot√£o para buscar √∫ltima KM -->
                                <button type="button" class="btn btn-outline-secondary" onclick="buscarUltimaKM()">
                                    <i class="fas fa-sync-alt"></i> Buscar √öltima
                                </button>
                            </div>
                        </div>
                    </div>
                    <!-- FIM LINHA 4 -->

                    <!-- SE√á√ÉO CHECKLIST -->
                    <div class="mb-3">
                        <label class="form-label">Checklist</label>
                        
                        <!-- Itens do checklist como checkboxes -->
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="combustivel">
                            <label class="form-check-label" for="combustivel">Combust√≠vel</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="oleo">
                            <label class="form-check-label" for="oleo">√ìleo</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="pneus">
                            <label class="form-check-label" for="pneus">Pneus</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="freios">
                            <label class="form-check-label" for="freios">Freios</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="documentos">
                            <label class="form-check-label" for="documentos">Documentos</label>
                        </div>
                    </div>
                    <!-- FIM SE√á√ÉO CHECKLIST -->

                    <!-- CAMPO OBSERVA√á√ïES -->
                    <div class="mb-3">
                        <label class="form-label">Observa√ß√µes</label>
                        <textarea class="form-control" id="observacoes" rows="3"></textarea>
                    </div>

                    <!-- BOT√ïES DE A√á√ÉO -->
                    <div class="d-grid gap-2">
                        <!-- Bot√£o principal de envio -->
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-save"></i> Salvar Registro
                        </button>
                        
                        <!-- Bot√£o secund√°rio para limpar formul√°rio -->
                        <button type="button" class="btn btn-outline-secondary" onclick="limparFormulario()">
                            <i class="fas fa-broom"></i> Limpar Formul√°rio
                        </button>
                    </div>

                </form>
                <!-- FIM FORMUL√ÅRIO PRINCIPAL -->

            </div>
            <!-- FIM CORPO DO FORMUL√ÅRIO -->
        </div>
        <!-- FIM CARD DO FORMUL√ÅRIO -->

        <!-- IN√çCIO √ÅREA DE MENSAGENS -->
        <div id="mensagens"></div>
        <!-- FIM √ÅREA DE MENSAGENS -->

        <!-- IN√çCIO INDICADOR DE CARREGAMENTO -->
        <div id="loading" class="loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
            <p class="mt-2">Processando...</p>
        </div>
        <!-- FIM INDICADOR DE CARREGAMENTO -->

    </div>
    <!-- FIM CONTAINER PRINCIPAL -->

    <!-- IN√çCIO IMPORTA√á√ÉO DE SCRIPTS -->
    
    <!-- jQuery para simplificar manipula√ß√£o DOM -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- IN√çCIO JAVASCRIPT DA APLICA√á√ÉO -->
    <script>
        // URL do Web App do Google Apps Script
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxW9m2C70AaDFrPEPt68EPn7mw5HhjtyieN3T014T8Gl41Fwy40E9UNieetfgBaZEUX/exec';

        // IN√çCIO FUN√á√ÉO: Inicializa√ß√£o quando documento est√° pronto
        $(document).ready(function() {
            console.log('‚úÖ Aplica√ß√£o iniciada');
            
            // Define data e hora atuais nos campos
            const agora = new Date();
            $('#data').val(agora.toISOString().split('T')[0]);
            $('#hora').val(agora.toTimeString().split(' ')[0].substring(0, 5));
            
            // IN√çCIO EVENTO: Submiss√£o do formul√°rio
            $('#checklistForm').on('submit', function(e) {
                e.preventDefault(); // Previne comportamento padr√£o do form
                console.log('üì§ Formul√°rio submetido');
                enviarFormulario(); // Chama fun√ß√£o de envio
            });
            // FIM EVENTO Submiss√£o do formul√°rio
        });
        // FIM FUN√á√ÉO Inicializa√ß√£o

        // IN√çCIO FUN√á√ÉO: Buscar √∫ltima quilometragem do ve√≠culo
        async function buscarUltimaKM() {
            const veiculo = $('#veiculo').val().trim();
            
            // Valida se o campo ve√≠culo est√° preenchido
            if (!veiculo) {
                mostrarMensagem('‚ö†Ô∏è Informe o ve√≠culo para buscar a KM', 'warning');
                return;
            }

            console.log(`üîç Buscando √∫ltima KM para: ${veiculo}`);
            mostrarLoading(true); // Exibe indicador de carregamento

            try {
                // IN√çCIO REQUISI√á√ÉO: Buscar √∫ltima KM via GET
                const response = await fetch(`${WEB_APP_URL}?action=getLastKM&veiculo=${encodeURIComponent(veiculo)}`);
                console.log('üì• Resposta recebida:', response.status);
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }

                const data = await response.json();
                console.log('üìä Dados recebidos:', data);
                // FIM REQUISI√á√ÉO Buscar √∫ltima KM

                // Processa a resposta
                if (data.success && data.ultimoKM > 0) {
                    $('#km').val(data.ultimoKM);
                    mostrarMensagem(`‚úÖ √öltima KM encontrada: ${data.ultimoKM}`, 'success');
                } else {
                    mostrarMensagem('‚ÑπÔ∏è Nenhuma KM anterior encontrada para este ve√≠culo', 'info');
                }

            } catch (error) {
                // TRATAMENTO DE ERRO: Busca de KM
                console.error('‚ùå Erro ao buscar KM:', error);
                mostrarMensagem('‚ùå Erro ao buscar √∫ltima KM. Verifique a conex√£o.', 'danger');
            } finally {
                mostrarLoading(false); // Esconde indicador de carregamento
            }
        }
        // FIM FUN√á√ÉO Buscar √∫ltima quilometragem

        // IN√çCIO FUN√á√ÉO: Enviar formul√°rio completo
        async function enviarFormulario() {
            console.log('üîÑ Iniciando envio do formul√°rio...');
            mostrarLoading(true); // Exibe loading

            // IN√çCIO COLETA DE DADOS: Obt√©m valores dos campos do formul√°rio
            const dados = {
                data: $('#data').val(),
                hora: $('#hora').val(),
                tipoRegistro: $('#tipoRegistro').val(),
                colaborador: $('#colaborador').val(),
                tipoVeiculo: $('#tipoVeiculo').val(),
                veiculo: $('#veiculo').val(),
                placa: $('#placa').val(),
                km: $('#km').val(),
                checklist: obterChecklist(), // Chama fun√ß√£o para obter checklist
                observacoes: $('#observacoes').val()
            };
            // FIM COLETA DE DADOS

            console.log('üì¶ Dados preparados para envio:', dados);

            try {
                // IN√çCIO REQUISI√á√ÉO: Enviar dados via POST
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(dados) // Converte dados para JSON
                });
                // FIM REQUISI√á√ÉO Enviar dados

                console.log('üì® Resposta do servidor:', response.status);

                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }

                const resultado = await response.json();
                console.log('‚úÖ Resposta JSON:', resultado);

                // Processa resposta do servidor
                if (resultado.success) {
                    mostrarMensagem('‚úÖ Registro salvo com sucesso!', 'success');
                    limparFormulario(); // Limpa formul√°rio ap√≥s sucesso
                } else {
                    throw new Error(resultado.error || 'Erro desconhecido');
                }

            } catch (error) {
                // TRATAMENTO DE ERRO: Envio do formul√°rio
                console.error('‚ùå Erro ao enviar formul√°rio:', error);
                mostrarMensagem(`‚ùå Erro: ${error.message}`, 'danger');
            } finally {
                mostrarLoading(false); // Esconde loading
            }
        }
        // FIM FUN√á√ÉO Enviar formul√°rio completo

        // IN√çCIO FUN√á√ÉO: Obter itens do checklist selecionados
        function obterChecklist() {
            const itens = [];
            
            // Verifica cada checkbox e adiciona se estiver marcado
            if ($('#combustivel').is(':checked')) itens.push('Combust√≠vel');
            if ($('#oleo').is(':checked')) itens.push('√ìleo');
            if ($('#pneus').is(':checked')) itens.push('Pneus');
            if ($('#freios').is(':checked')) itens.push('Freios');
            if ($('#documentos').is(':checked')) itens.push('Documentos');
            
            console.log(`üìã Checklist selecionado: ${itens.join(', ')}`);
            return itens.join(', '); // Retorna como string separada por v√≠rgula
        }
        // FIM FUN√á√ÉO Obter checklist

        // IN√çCIO FUN√á√ÉO: Limpar todos os campos do formul√°rio
        function limparFormulario() {
            console.log('üßπ Limpando formul√°rio...');
            
            // Reseta o formul√°rio
            $('#checklistForm')[0].reset();
            
            // Define data e hora atuais novamente
            const agora = new Date();
            $('#data').val(agora.toISOString().split('T')[0]);
            $('#hora').val(agora.toTimeString().split(' ')[0].substring(0, 5));
            
            // Limpa mensagens
            $('#mensagens').empty();
            
            console.log('‚úÖ Formul√°rio limpo');
        }
        // FIM FUN√á√ÉO Limpar formul√°rio

        // IN√çCIO FUN√á√ÉO: Mostrar/esconder indicador de carregamento
        function mostrarLoading(mostrar) {
            if (mostrar) {
                $('#loading').show(); // Exibe loading
                console.log('‚è≥ Loading exibido');
            } else {
                $('#loading').hide(); // Esconde loading
                console.log('‚úÖ Loading escondido');
            }
        }
        // FIM FUN√á√ÉO Mostrar loading

        // IN√çCIO FUN√á√ÉO: Exibir mensagens para o usu√°rio
        function mostrarMensagem(mensagem, tipo = 'info') {
            console.log(`üí¨ Mensagem [${tipo}]: ${mensagem}`);
            
            // Remove mensagens anteriores
            $('#mensagens').empty();
            
            // Cria e exibe nova mensagem
            const alerta = $(`
                <div class="alert alert-${tipo} alert-dismissible fade show" role="alert">
                    ${mensagem}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `);
            
            $('#mensagens').append(alerta);
            
            // Remove automaticamente ap√≥s 5 segundos (exceto para errors)
            if (tipo !== 'danger') {
                setTimeout(() => {
                    alerta.alert('close');
                }, 5000);
            }
        }
        // FIM FUN√á√ÉO Mostrar mensagem

    </script>
    <!-- FIM JAVASCRIPT DA APLICA√á√ÉO -->

</body>
</html>
