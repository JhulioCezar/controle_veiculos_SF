<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Controle de Uso de Veículos</title>
<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#004aad" />
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f2f2f2;
    margin: 0;
    padding: 0;
  }
  header {
    text-align: center;
    background: #004aad;
    color: white;
    padding: 10px;
  }
  header img {
    max-width: 150px;
  }
  form {
    max-width: 700px;
    margin: 20px auto;
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  label {
    font-weight: bold;
    display: block;
    margin-top: 10px;
  }
  select, input, textarea, button {
    width: 100%;
    padding: 8px;
    margin-top: 4px;
    border-radius: 5px;
    border: 1px solid #ccc;
  }
  canvas {
    border: 2px solid #004aad;
    border-radius: 8px;
    width: 100%;
    height: 200px;
    touch-action: none;
  }
  .buttons {
    display: flex;
    justify-content: space-between;
    margin-top: 15px;
  }
  .buttons button {
    flex: 1;
    margin: 5px;
    padding: 10px;
    font-size: 16px;
    cursor: pointer;
  }
</style>
</head>
<body>
  <header>
    <img src="https://i.imgur.com/SEr4lkm.png" alt="Logo" />
    <h2>Controle de Uso de Veículos</h2>
  </header>

  <form id="formulario">
    <label for="rotaTipo">Tipo de Registro:</label>
    <select id="rotaTipo" required>
      <option value="">Selecione...</option>
      <option value="Início de Rota">Início de Rota</option>
      <option value="Final de Rota">Final de Rota</option>
    </select>

    <label for="dataAtual">Data:</label>
    <input type="text" id="dataAtual" readonly />

    <label for="horaAtual">Hora:</label>
    <input type="text" id="horaAtual" readonly />

    <label for="colaborador">Colaborador:</label>
    <select id="colaborador" required>
      <option value="">Selecione...</option>
      <option value="Jhulio Cezar de Alencar Araujo">Jhulio Cezar de Alencar Araujo</option>
      <option value="João Paulo de Sousa">João Paulo de Sousa</option>
      <option value="Francisco Junior">Francisco Junior</option>
    </select>

    <label for="tipoVeiculo">Tipo de Veículo:</label>
    <select id="tipoVeiculo" required onchange="carregarVeiculos()">
      <option value="">Selecione...</option>
      <option value="Carro">Carro</option>
      <option value="Moto">Moto</option>
    </select>

    <label for="veiculo">Veículo:</label>
    <select id="veiculo" required onchange="atualizarPlaca()">
      <option value="">Selecione o tipo primeiro...</option>
    </select>

    <label for="placa">Placa:</label>
    <input type="text" id="placa" readonly />

    <label for="km">Quilometragem:</label>
    <input type="number" id="km" required />

    <label>Foto do Painel:</label>
    <input type="file" accept="image/*" capture="camera" id="fotoPainel" />
    <img id="preview" style="width:100%;margin-top:8px;display:none;" />

    <label>Assinatura Digital:</label>
    <canvas id="signatureCanvas"></canvas>
    <button type="button" onclick="limparAssinatura()">Limpar Assinatura</button>
    <p id="assinaturaColaborador" style="text-align:center;font-weight:bold;margin-top:5px;"></p>

    <div class="buttons">
      <button type="button" onclick="voltarTela()">Voltar</button>
      <button type="button" onclick="limparFormulario()">Limpar Formulário</button>
      <button type="submit">Enviar</button>
    </div>
  </form>

<script>
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxW9m2C70AaDFrPEPt68EPn7mw5HhjtyieN3T014T8Gl41Fwy40E9UNieetfgBaZEUX/exec";

// ======= AUTO DATA E HORA =======
function atualizarDataHora() {
  const agora = new Date();
  document.getElementById("dataAtual").value = agora.toLocaleDateString("pt-BR");
  document.getElementById("horaAtual").value = agora.toLocaleTimeString("pt-BR", { hour: "2-digit", minute: "2-digit" });
}
setInterval(atualizarDataHora, 60000);
window.onload = atualizarDataHora;

// ======= DADOS DE VEÍCULOS =======
const veiculos = {
  Carro: [
    { nome: "Volkswagen Polo", placa: "NXR-6B97" },
    { nome: "Fiat Toro", placa: "NAB-2B27" }
  ],
  Moto: [
    // Adicione aqui suas motos quando quiser
  ]
};

function carregarVeiculos() {
  const tipo = document.getElementById("tipoVeiculo").value;
  const select = document.getElementById("veiculo");
  select.innerHTML = '<option value="">Selecione...</option>';
  if (veiculos[tipo]) {
    veiculos[tipo].forEach(v => {
      const opt = document.createElement("option");
      opt.value = v.nome;
      opt.textContent = v.nome;
      select.appendChild(opt);
    });
  }
}

function atualizarPlaca() {
  const tipo = document.getElementById("tipoVeiculo").value;
  const veiculoSelecionado = document.getElementById("veiculo").value;
  const v = veiculos[tipo]?.find(v => v.nome === veiculoSelecionado);
  document.getElementById("placa").value = v ? v.placa : "";
}

// ======= ASSINATURA DIGITAL =======
const canvas = document.getElementById("signatureCanvas");
const ctx = canvas.getContext("2d");
let desenhando = false;

function ajustarCanvas() {
  const rect = canvas.getBoundingClientRect();
  canvas.width = rect.width;
  canvas.height = rect.height;
  ctx.lineWidth = 2;
  ctx.strokeStyle = "#004aad";
}
ajustarCanvas();
window.addEventListener("resize", ajustarCanvas);

canvas.addEventListener("mousedown", e => {
  desenhando = true;
  ctx.beginPath();
  ctx.moveTo(e.offsetX, e.offsetY);
});
canvas.addEventListener("mousemove", e => {
  if (!desenhando) return;
  ctx.lineTo(e.offsetX, e.offsetY);
  ctx.stroke();
});
canvas.addEventListener("mouseup", () => desenhando = false);
canvas.addEventListener("mouseleave", () => desenhando = false);

// Suporte toque
canvas.addEventListener("touchstart", e => {
  e.preventDefault();
  const t = e.touches[0];
  const rect = canvas.getBoundingClientRect();
  ctx.beginPath();
  ctx.moveTo(t.clientX - rect.left, t.clientY - rect.top);
  desenhando = true;
});
canvas.addEventListener("touchmove", e => {
  e.preventDefault();
  if (!desenhando) return;
  const t = e.touches[0];
  const rect = canvas.getBoundingClientRect();
  ctx.lineTo(t.clientX - rect.left, t.clientY - rect.top);
  ctx.stroke();
});
canvas.addEventListener("touchend", () => desenhando = false);

function limparAssinatura() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
}

document.getElementById("colaborador").addEventListener("change", () => {
  document.getElementById("assinaturaColaborador").innerText = document.getElementById("colaborador").value;
});

// ======= FOTO DO PAINEL =======
document.getElementById("fotoPainel").addEventListener("change", function() {
  const file = this.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = e => {
      document.getElementById("preview").src = e.target.result;
      document.getElementById("preview").style.display = "block";
    };
    reader.readAsDataURL(file);
  }
});

// ======= BOTÕES =======
function voltarTela() {
  document.getElementById("rotaTipo").value = "";
  window.scrollTo(0,0);
}
function limparFormulario() {
  document.getElementById("formulario").reset();
  limparAssinatura();
  document.getElementById("preview").style.display = "none";
  atualizarDataHora();
}

// ======= GOOGLE SHEETS =======
async function getLastKM(veiculo) {
  const url = `${WEBAPP_URL}?action=getLastKM&veiculo=${encodeURIComponent(veiculo)}`;
  const res = await fetch(url);
  const json = await res.json();
  return Number(json.ultimoKM || 0);
}
async function sendToSheets(dados) {
  const res = await fetch(WEBAPP_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(dados)
  });
  return res.json();
}

// ======= ENVIO =======
document.getElementById("formulario").addEventListener("submit", async (ev) => {
  ev.preventDefault();

  const veiculo = document.getElementById("veiculo").value;
  const km = Number(document.getElementById("km").value);
  const ultimoKM = await getLastKM(veiculo);

  if (km < ultimoKM) {
    alert(`A quilometragem informada (${km}) é menor que a última registrada (${ultimoKM}).`);
    return;
  }

  const dados = {
    data: document.getElementById("dataAtual").value,
    hora: document.getElementById("horaAtual").value,
    tipoRegistro: document.getElementById("rotaTipo").value,
    colaborador: document.getElementById("colaborador").value,
    tipoVeiculo: document.getElementById("tipoVeiculo").value,
    veiculo,
    placa: document.getElementById("placa").value,
    km,
    fotoPainel: document.getElementById("preview").src || "",
    assinatura: canvas.toDataURL()
  };

  await sendToSheets(dados);
  alert("Formulário enviado com sucesso!");
  limparFormulario();
});
</script>
</body>
</html>
