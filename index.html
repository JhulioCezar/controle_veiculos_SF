<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checklist Ve√≠culos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa;
            padding-top: 20px;
        }
        .container {
            max-width: 800px;
        }
        .card {
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="text-center mb-4">
            <h1 class="display-4">
                <i class="fas fa-car"></i> Checklist Ve√≠culos
            </h1>
            <p class="lead">Controle de uso e manuten√ß√£o de ve√≠culos</p>
        </div>

        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-clipboard-list"></i> Novo Registro
                </h5>
            </div>
            
            <div class="card-body">
                <form id="checklistForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Data</label>
                            <input type="date" class="form-control" id="data" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Hora</label>
                            <input type="time" class="form-control" id="hora" required>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Tipo de Registro</label>
                            <select class="form-select" id="tipoRegistro" required>
                                <option value="">Selecione...</option>
                                <option value="Sa√≠da">Sa√≠da</option>
                                <option value="Retorno">Retorno</option>
                                <option value="Manuten√ß√£o">Manuten√ß√£o</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Colaborador</label>
                            <input type="text" class="form-control" id="colaborador" required>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Tipo de Ve√≠culo</label>
                            <select class="form-select" id="tipoVeiculo" required>
                                <option value="">Selecione...</option>
                                <option value="Carro">Carro</option>
                                <option value="Moto">Moto</option>
                                <option value="Caminh√£o">Caminh√£o</option>
                                <option value="Van">Van</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Ve√≠culo</label>
                            <input type="text" class="form-control" id="veiculo" required>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Placa</label>
                            <input type="text" class="form-control" id="placa" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Quilometragem (KM)</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="km" required>
                                <button type="button" class="btn btn-outline-secondary" onclick="buscarUltimaKM()">
                                    <i class="fas fa-sync-alt"></i> Buscar √öltima
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Checklist</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="combustivel">
                            <label class="form-check-label" for="combustivel">Combust√≠vel</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="oleo">
                            <label class="form-check-label" for="oleo">√ìleo</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="pneus">
                            <label class="form-check-label" for="pneus">Pneus</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="freios">
                            <label class="form-check-label" for="freios">Freios</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="documentos">
                            <label class="form-check-label" for="documentos">Documentos</label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Observa√ß√µes</label>
                        <textarea class="form-control" id="observacoes" rows="3"></textarea>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-save"></i> Salvar Registro
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="limparFormulario()">
                            <i class="fas fa-broom"></i> Limpar Formul√°rio
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div id="mensagens"></div>

        <div id="loading" class="loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
            <p class="mt-2">Processando...</p>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxW9m2C70AaDFrPEPt68EPn7mw5HhjtyieN3T014T8Gl41Fwy40E9UNieetfgBaZEUX/exec';

        // FUN√á√ÉO DO SERVICE WORKER - √öNICA ALTERA√á√ÉO
        function registrarServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker
                    .register('./sw.js')
                    .then(function(registration) {
                        console.log('‚úÖ Service Worker registrado com sucesso:', registration);
                    })
                    .catch(function(error) {
                        console.error('‚ùå Falha no registro do Service Worker:', error);
                    });
            }
        }

        $(document).ready(function() {
            console.log('‚úÖ Aplica√ß√£o iniciada');
            
            // CHAMADA DO SERVICE WORKER - √öNICA ALTERA√á√ÉO
            registrarServiceWorker();
            
            const agora = new Date();
            $('#data').val(agora.toISOString().split('T')[0]);
            $('#hora').val(agora.toTimeString().split(' ')[0].substring(0, 5));
            
            $('#checklistForm').on('submit', function(e) {
                e.preventDefault();
                console.log('üì§ Formul√°rio submetido');
                enviarFormulario();
            });
        });

        async function buscarUltimaKM() {
            const veiculo = $('#veiculo').val().trim();
            
            if (!veiculo) {
                mostrarMensagem('‚ö†Ô∏è Informe o ve√≠culo para buscar a KM', 'warning');
                return;
            }

            console.log(`üîç Buscando √∫ltima KM para: ${veiculo}`);
            mostrarLoading(true);

            try {
                const response = await fetch(`${WEB_APP_URL}?action=getLastKM&veiculo=${encodeURIComponent(veiculo)}`);
                console.log('üì• Resposta recebida:', response.status);
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }

                const data = await response.json();
                console.log('üìä Dados recebidos:', data);

                if (data.success && data.ultimoKM > 0) {
                    $('#km').val(data.ultimoKM);
                    mostrarMensagem(`‚úÖ √öltima KM encontrada: ${data.ultimoKM}`, 'success');
                } else {
                    mostrarMensagem('‚ÑπÔ∏è Nenhuma KM anterior encontrada para este ve√≠culo', 'info');
                }

            } catch (error) {
                console.error('‚ùå Erro ao buscar KM:', error);
                mostrarMensagem('‚ùå Erro ao buscar √∫ltima KM. Verifique a conex√£o.', 'danger');
            } finally {
                mostrarLoading(false);
            }
        }

        async function enviarFormulario() {
            console.log('üîÑ Iniciando envio do formul√°rio...');
            mostrarLoading(true);

            const dados = {
                data: $('#data').val(),
                hora: $('#hora').val(),
                tipoRegistro: $('#tipoRegistro').val(),
                colaborador: $('#colaborador').val(),
                tipoVeiculo: $('#tipoVeiculo').val(),
                veiculo: $('#veiculo').val(),
                placa: $('#placa').val(),
                km: $('#km').val(),
                checklist: obterChecklist(),
                observacoes: $('#observacoes').val()
            };

            console.log('üì¶ Dados preparados para envio:', dados);

            try {
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(dados)
                });

                console.log('üì® Resposta do servidor:', response.status);

                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }

                const resultado = await response.json();
                console.log('‚úÖ Resposta JSON:', resultado);

                if (resultado.success) {
                    mostrarMensagem('‚úÖ Registro salvo com sucesso!', 'success');
                    limparFormulario();
                } else {
                    throw new Error(resultado.error || 'Erro desconhecido');
                }

            } catch (error) {
                console.error('‚ùå Erro ao enviar formul√°rio:', error);
                mostrarMensagem(`‚ùå Erro: ${error.message}`, 'danger');
            } finally {
                mostrarLoading(false);
            }
        }

        function obterChecklist() {
            const itens = [];
            
            if ($('#combustivel').is(':checked')) itens.push('Combust√≠vel');
            if ($('#oleo').is(':checked')) itens.push('√ìleo');
            if ($('#pneus').is(':checked')) itens.push('Pneus');
            if ($('#freios').is(':checked')) itens.push('Freios');
            if ($('#documentos').is(':checked')) itens.push('Documentos');
            
            console.log(`üìã Checklist selecionado: ${itens.join(', ')}`);
            return itens.join(', ');
        }

        function limparFormulario() {
            console.log('üßπ Limpando formul√°rio...');
            
            $('#checklistForm')[0].reset();
            
            const agora = new Date();
            $('#data').val(agora.toISOString().split('T')[0]);
            $('#hora').val(agora.toTimeString().split(' ')[0].substring(0, 5));
            
            $('#mensagens').empty();
            
            console.log('‚úÖ Formul√°rio limpo');
        }

        function mostrarLoading(mostrar) {
            if (mostrar) {
                $('#loading').show();
                console.log('‚è≥ Loading exibido');
            } else {
                $('#loading').hide();
                console.log('‚úÖ Loading escondido');
            }
        }

        function mostrarMensagem(mensagem, tipo = 'info') {
            console.log(`üí¨ Mensagem [${tipo}]: ${mensagem}`);
            
            $('#mensagens').empty();
            
            const alerta = $(`
                <div class="alert alert-${tipo} alert-dismissible fade show" role="alert">
                    ${mensagem}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `);
            
            $('#mensagens').append(alerta);
            
            if (tipo !== 'danger') {
                setTimeout(() => {
                    alerta.alert('close');
                }, 5000);
            }
        }
    </script>
</body>
</html>